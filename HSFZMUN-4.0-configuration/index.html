<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script>(()=>{let e="/cnfonts.js?rDuukLHQ",t=document,n=navigator.serviceWorker,r=!1;var a;(r=n&&(n.register(e,{scope:"/"}).then(e=>e.update()),a=n.controller)&&a.scriptURL.endsWith(e)&&"activated"===a.state?!0:r)?((a=t.createElement("link")).rel="stylesheet",a.href="/fontchan/rDuukLHQ.css",a.blocking="render",t.head.appendChild(a)):((a=t.createElement("script")).src=e,a.onload=()=>$fontchan.injectCss(),t.head.appendChild(a))})()</script><title>HSFZMUN 4.0 部署小记</title><meta itemprop="title" content="HSFZMUN 4.0 部署小记 - hsfzxjy 的博客"><meta itemprop="og:title" content="HSFZMUN 4.0 部署小记 - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="
技术流水账一篇，记录踩过的坑

Channels 异构
Django Channels 官方文档宣称 chann..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="zh" class="post post-page"><h1 lang="zh" class="post__title">HSFZMUN 4.0 部署小记</h1><div class="post__meta font__ui">2017-02-25 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body noindent"><blockquote><p>技术流水账一篇，记录踩过的坑</p></blockquote><h2 id="channels-异构">Channels 异构</h2><p>Django Channels 官方文档宣称 channels 的最佳配置是使用其自带的服务器组件 Daphne，但在开发中我发现 daphne 处理普通请求比在 WSGI 架构下慢了好几倍，更何况使用 daphne 派发静态文件是十分不切实际的。于是我将 <code>http.request</code> 和 <code>websocket.*</code> 两个 channel 解耦，前者使用 nginx 配合 uwsgi 处理，后者使用 nginx 反向代理至 daphne 处理。这样一来便可充分利用两种架构的优势。</p><p><strong>旧架构：</strong></p><p><img loading="lazy" src="/assets/django-channels-configuration/old-arch.png" alt=""></p><p><strong>新架构：</strong></p><p><img loading="lazy" src="/assets/django-channels-configuration/new-arch.png" alt=""></p><h2 id="环境">环境</h2><ul><li>Ubuntu Server 16.04（与开发环境相同）</li><li>python 3.5.2</li><li>virtualenv &amp; virtualenvwrapper</li><li>nginx</li><li>uwsgi</li><li>redis（作为缓存和 Channel Layer）</li></ul><h2 id="channels-session-based-authentication">Channels Session-based Authentication</h2><p>channels 有提供基于 HTTP Session 的认证方式，但由于 websocket 和 http 在此不是同域请求（端口号不同），主域名下的 cookies 不会随 websocket 请求发送。故在发起 websocket 链接时要带上一个 GET 参数 <code>session_key</code>。在模板中该参数可由 <code>&#123; &#123;request.session.session_key&#125; &#125;</code> 获得。</p><h2 id="uwsgi">uwsgi</h2><p>安装：</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line">$ sudo pip install uwsgi <span class="hljs-comment"># 全局安装</span></span><br></pre></div></div><p class="par">编写配置文件 <code>/etc/uwsgi/sites/hsfzmun.ini</code>：</p><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line">[uwsgi]</span><br><span class="line">uid = git</span><br><span class="line">chdir = /home/git/hsfzmun/server</span><br><span class="line">module = config.wsgi:application</span><br><span class="line">home = /home/git/virtualenvs/hsfzmun # Virtualenv 路径</span><br><span class="line">master = true</span><br><span class="line">processes = 10</span><br><span class="line">socket = /var/www/hsfzmun.sock # 使用 Unix Socket 与 nginx 通信</span><br><span class="line">chmod-socket = 666</span><br><span class="line">vacuum = true</span><br></pre></div></div><p class="par">配置 systemd 服务（<code>uwsgi.service</code>）：</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line">[Unit]</span><br><span class="line">Description=uWSGI Module</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=/bin/bash -c &#x27;mkdir -p /run/uwsgi; chown git:www-data /run/uwsgi&#x27;</span><br><span class="line">ExecStart=/usr/local/bin/uwsgi --emperor /etc/uwsgi/sites --touch-reload=/home/git/hsfzmun/server/uwsgi_params</span><br><span class="line">Restart=always</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">Type=notify</span><br><span class="line">NotifyAccess=all</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></div></div><p class="par">uwsgi 有个优点：可以通过 <code>--touch-reload</code> 参数简洁地重启服务，这样只需一条 <code>touch</code> 命令便可以完成新代码的部署。</p><h2 id="daphne">daphne</h2><p>daphne 有两个模块：Interface Server 和 Workers。前者负责处理 Websocket、long-polling 等请求，并将其抽象化为 channels 传递给 Workers，Workers 则负责执行具体的业务逻辑。这么做有一个好处就是 <strong>降低了底层与业务逻辑的耦合度，即使业务层崩溃也不会使连接断开，同时也减少了新代码部署对整个系统的印象</strong>。部署新代码时只需重启 Workers 即可。</p><p><code>daphnei.service</code>：</p><div class="gk-code hljs" data-gk-id="BLOCK4"><div class="gk-code-display"><pre><span class="line">[Unit]</span><br><span class="line">Description=Daphne Interface Server</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/home/git/cmd/daphnei</span><br><span class="line">Restart=always</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">Type=simple</span><br><span class="line">NotifyAccess=all</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></div></div><p class="par"><code>daphnew.service</code>：</p><div class="gk-code hljs" data-gk-id="BLOCK5"><div class="gk-code-display"><pre><span class="line">[Unit]</span><br><span class="line">Description=Daphne Worker</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/home/git/cmd/daphnew</span><br><span class="line">Type=simple</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">Restart=always</span><br><span class="line">NotifyAccess=all</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></div></div><p class="par"><strong>此处踩了一个坑</strong>：起初 <code>Type</code> 处的值是 <code>Notify</code>，因为我是仿照 <code>uwsgi.service</code> 编写这两个文件的。<code>Notify</code> 型服务要求主进程自行通知 <code>systemd</code> 自己的启动/停止状态，但 daphne 没有这样的机制，从而导致 <code>systemctl</code> 阻塞，并以 90 秒为周期不断重启服务。幸好 StackOverflow 上的大神指出了这个错误。</p><p>这里我将具体的服务脚本独立出来，因为 <code>ExecStart</code> 不支持编写多行语句。</p><p><code>cmd/daphnei</code>：</p><div class="gk-code hljs" data-gk-id="BLOCK6"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">#!/bin/bash</span></span><br><span class="line"><span class="hljs-built_in">cd</span> /home/git/hsfzmun/server</span><br><span class="line">/home/git/virtualenvs/hsfzmun/bin/daphne -b 0.0.0.0 -p 8001 -v2 config.asgi:channel_layer --access-log=/var/www/daphnei.log</span><br></pre></div></div><p class="par"><code>cmd/daphnew</code>：</p><div class="gk-code hljs" data-gk-id="BLOCK7"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">#!/bin/bash</span></span><br><span class="line"><span class="hljs-built_in">cd</span> /home/git/hsfzmun/server</span><br><span class="line">/home/git/virtualenvs/hsfzmun/bin/python manage.py runworker --threads 5 --only-channels=websocket.*</span><br></pre></div></div><p class="par"><strong>此处 daphne 有个 bug</strong>：理论上 verbosity 不应该影响程序的行为，但如果不加 <code>-v2</code> 参数 nginx 会报 <code>502 Bad Gateway</code>。</p><h2 id="nginx">nginx</h2><p>此处的难点是反向代理 websockets，因为 nginx 默认不识别 websocket 协议。为了能正确指定协议头，只能将所有 websocket 请求路由到某一子路径下。</p><p><code>nginx.service</code>：</p><div class="gk-code hljs" data-gk-id="BLOCK8"><div class="gk-code-display"><pre><span class="line">server {</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name &lt;ip&gt; product;</span><br><span class="line"></span><br><span class="line">  # 静态文件</span><br><span class="line">  location /static {</span><br><span class="line">    alias /var/www/static;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  # 用户上传的文件</span><br><span class="line">  location /m {</span><br><span class="line">    alias /var/www/media;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  # uwsgi 反向代理</span><br><span class="line">  location / {</span><br><span class="line">    include /var/www/uwsgi_params;</span><br><span class="line">    uwsgi_pass unix:/var/www/hsfzmun.sock;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  # daphne 反向代理</span><br><span class="line">  location /ws {</span><br><span class="line">    proxy_pass http://0.0.0.0:8001;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">    proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line"></span><br><span class="line">    proxy_redirect     off;</span><br><span class="line">    proxy_set_header   Host $host;</span><br><span class="line">    proxy_set_header   X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header   X-Forwarded-Host $server_name;</span><br><span class="line">    proxy_read_timeout  36000s;</span><br><span class="line">    proxy_send_timeout  36000s;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></div></div><h2 id="git-自动化部署">Git 自动化部署</h2><p>去年的 WiseCity 3.0 采用 Github 中转的方式进行部署，这对 Github 的稳定性有很高的要求。这次则将生产服务器作为 Git Server，使用 Git Hooks 进行自动化部署，大大提高了生产效率。</p><p>创建 git 用户：</p><div class="gk-code hljs" data-gk-id="BLOCK9"><div class="gk-code-display"><pre><span class="line">$ useradd git</span><br><span class="line">$ passwd git</span><br></pre></div></div><p class="par">设置 SSH authorized_keys（略）。</p><p>创建仓库：</p><div class="gk-code hljs" data-gk-id="BLOCK10"><div class="gk-code-display"><pre><span class="line">$ <span class="hljs-built_in">cd</span> ~</span><br><span class="line">$ git init --bare hsfzmun.git</span><br></pre></div></div><p class="par">创建钩子 <code>hooks/post-receive</code>：</p><div class="gk-code hljs" data-gk-id="BLOCK11"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">#!/bin/bash</span></span><br><span class="line"><span class="hljs-comment"># Checkout Repository</span></span><br><span class="line">GIT_WORK_TREE=/home/git/hsfzmun git checkout -f</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Activate Virtualenv</span></span><br><span class="line"><span class="hljs-built_in">cd</span> /home/git/hsfzmun/server</span><br><span class="line"><span class="hljs-built_in">export</span> LC_ALL=C</span><br><span class="line"><span class="hljs-built_in">export</span> VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3</span><br><span class="line"><span class="hljs-built_in">export</span> WORKON_HOME=~/virtualenvs</span><br><span class="line"><span class="hljs-built_in">source</span> /usr/local/bin/virtualenvwrapper.sh</span><br><span class="line">workon hsfzmun</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Internationalization</span></span><br><span class="line">./manage.py compilemessages</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Collect Static Files</span></span><br><span class="line">./manage.py collectstatic --noinput</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Migrate Databases</span></span><br><span class="line">./manage.py migrate</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Restart uWSGI</span></span><br><span class="line"><span class="hljs-built_in">touch</span> ./uwsgi_params</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Restart Daphne Workers</span></span><br><span class="line">sudo systemctl restart daphnew --no-block</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;All operations done.&quot;</span></span><br></pre></div></div><p class="par">此钩子会在每次 push 之后执行，自动更新静态文件和数据库表并重启相关服务。</p><p>本地添加远程仓库（略）。</p><br><blockquote><p class="cc">作者：hsfzxjy<br>链接：<span class="cc-link"></span><br>许可：<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>著作权归作者所有。本文<b>不允许</b>被用作商业用途，非商业转载请注明出处。</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/Ubuntu/">Ubuntu</a><a href="/tags/Django-Channels/">Django Channels</a><a href="/tags/Django/">Django</a><a href="/tags/Nginx/">Nginx</a></div><div class="post-nav"><a href="/linux-file-permissions/" class="pre">«Linux 文件权限</a><a href="/raining-in-ustc/" class="next">午后雨·科大»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="HSFZMUN-4.0-configuration/",disqus_title="HSFZMUN 4.0 部署小记",disqus_url="https://i.hsfzxjy.site/HSFZMUN-4.0-configuration/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"><div id="toc" lang="zh" class="font__body"><div class="toc-toggler"></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#channels-%E5%BC%82%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">Channels 异构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#channels-session-based-authentication"><span class="toc-number">3.</span> <span class="toc-text">Channels Session-based Authentication</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uwsgi"><span class="toc-number">4.</span> <span class="toc-text">uwsgi</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#daphne"><span class="toc-number">5.</span> <span class="toc-text">daphne</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx"><span class="toc-number">6.</span> <span class="toc-text">nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#git-%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2"><span class="toc-number">7.</span> <span class="toc-text">Git 自动化部署</span></a></li></ol></div></div></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>