<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script>(()=>{let e="/cnfonts.js?rDuukLHQ",t=document,n=navigator.serviceWorker,r=!1;var a;(r=n&&(n.register(e,{scope:"/"}).then(e=>e.update()),a=n.controller)&&a.scriptURL.endsWith(e)&&"activated"===a.state?!0:r)?((a=t.createElement("link")).rel="stylesheet",a.href="/fontchan/rDuukLHQ.css",a.blocking="render",t.head.appendChild(a)):((a=t.createElement("script")).src=e,a.onload=()=>$fontchan.injectCss(),t.head.appendChild(a))})()</script><title>Understanding pickle in Python</title><meta itemprop="title" content="Understanding pickle in Python - hsfzxjy 的博客"><meta itemprop="og:title" content="Understanding pickle in Python - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="The module pickle shipped in Python could be used for gen..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">Understanding pickle in Python</h1><div class="post__meta font__ui">2021-08-14 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body"><p>The module <code>pickle</code> shipped in Python could be used for generic-purpose object serialization and de-serialization. It’s been widely adopted or recommended as backend in scenarios like persisting states or IPC.</p><p class="nomargin">Employed by many famous frameworks, though, the magic behind it still seems to be vague for daily users, especially guys fresh to the language. People come across “unpicklable” errors from time to time, but don’t know the reason; or re-invent state persistence by themselves, even if <code>pickle</code> could be competent. People sometimes write error-prone codes, merely because they are afraid of or unaware of <code>pickle</code>.</p><p class="nomargin">This post thus attempts to clarify the usage of <code>pickle</code> module in an easy understanding way, by answering three questions.</p><h2 id="what-kind-of-object-is-picklable">What kind of object is picklable?</h2><p>Before stepping in, let’s take a swift overview for the design of <code>pickle</code> module.</p><p><code>pickle</code> separates the logic of serialization / de-serialization into two parts, using some kind of intermediate representation (IR). During serialization, an object is firstly transformed into IR, and then dumped into byte stream by <code>pickle</code>. De-serialization operates conversely. For most of the time, we users should only care about the first aspect, that is, the conversion between Python objects and IR.</p><p>To ease the burden of using <code>pickle</code>, the module set up a few principles that could generalize the concept “picklable” automatically to most user-defined objects. Users then need not to communicate with IR. The principles could be roughly summarized into</p><ol><li>Most built-in Python types and their instances are picklable.</li><li>Containers like <em>lists</em>, <em>dicts</em> or <em>sets</em> with only picklable elements are picklable.</li><li>Top-level classes or functions of a module are picklable (if configured properly).</li><li>Objects with picklable <code>__dict__</code> and picklable type are picklable.</li><li>Objects holding external resources (<code>open()</code>, <code>socket.socket()</code>, <em>etc.</em>) are usually NOT picklable.</li></ol><p class="par">Principle 1 and 2 ensures that we can easily pickle built-in types <sup id="fnref:1"><a href="#fn:1">1</a></sup>, values <sup id="fnref:2"><a href="#fn:2">2</a></sup> and their composition <sup id="fnref:3"><a href="#fn:3">3</a></sup>, which covers a large variety of daily-used objects.</p><p class="nomargin">If you want to pickle custom objects, Principle 3 and 4 come into play. If you define your class at the top-level of a module (and usually you should), the class is automatically picklable. An object instantiated from that class, if holding only picklable attributes (stored in <code>__dict__</code>), is also picklable.</p><p class="nomargin">How convenient! Nothing is needed but a simple <code>pickle.load</code> or <code>pickle.dump</code> to enjoy pickle services .</p><p>Principle 3 comes with a remark <em>“if configured properly”</em>. Technically, module-level values are picklable if they have the correct <code>__qualname__</code>. <code>__qualname__</code> dictates the name of variable that holds the value. This is automatically done if the value is a class or function:</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span>: <span class="hljs-keyword">pass</span></span><br><span class="line">C.__qualname__  <span class="hljs-comment"># &#x27;C&#x27;</span></span><br><span class="line"><span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(): <span class="hljs-keyword">pass</span></span><br><span class="line">f.__qualname__  <span class="hljs-comment"># &#x27;f&#x27;</span></span><br></pre></div></div><p class="par">which enables pickling for user-defined classes or functions.</p><p class="nomargin">But this does not apply to lambdas. A lambda by default would have <code>__qualname__ == &quot;&lt;lambda&gt;&quot;</code>, which does not match the variable name that holds it. <code>pickle</code> thus cannot handle it normally</p><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">&gt;&gt;&gt; </span>f = <span class="hljs-keyword">lambda</span>: <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-meta">&gt;&gt;&gt; </span>pickle.dumps(f)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="hljs-string">&quot;&lt;stdin&gt;&quot;</span>, line <span class="hljs-number">1</span>, <span class="hljs-keyword">in</span> &lt;module&gt;</span><br><span class="line">_pickle.PicklingError: Cant pickle &lt;function &lt;<span class="hljs-keyword">lambda</span>&gt; at <span class="hljs-number">0x7f7ed81ad3a0</span>&gt;: attribute look up &lt;<span class="hljs-keyword">lambda</span>&gt; on __main__ failed</span><br><span class="line"><span class="hljs-meta">&gt;&gt;&gt; </span>f.__qualname__</span><br><span class="line"><span class="hljs-string">&#x27;&lt;lambda&gt;&#x27;</span></span><br></pre></div></div><p class="par">To make it possible, one could assign <code>__qualname__</code> for it manually</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">&gt;&gt;&gt; </span>f.__qualname__ = <span class="hljs-string">&#x27;f&#x27;</span></span><br><span class="line"><span class="hljs-meta">&gt;&gt;&gt; </span>pickle.dumps(f)</span><br><span class="line"><span class="hljs-string">b&#x27;\x80\x04\x95\x12\x00\x00\x00\x00\x00\x00\x00\x8c\x08__main__\x94\x8c\x01f\x94\x93\x94.&#x27;</span></span><br></pre></div></div><p>Principle 5 might be wierd at the first sight, but is indeed reasonable.</p><p class="nomargin">Let’s consider if a <code>socket</code> object could be dumped, and we load it at some point afterwards. There exist so many causes that could fail the de-serialization. Peer host malfunctions, link layer breaks, or out of system resources. Even if it succeeds, the loaded object is not identical to the original one, since it references to external resource with different internal state.</p><p class="nomargin"><code>pickle</code> therefore disables the stuff – but if you wish, you could control it by customizing the serialization / de-serialization behavior. Here we come to</p><h2 id="what-if-my-object-is-not-picklable">What if my object is not picklable?</h2><p>From now you would need to learn something about the IR, as well as the object protocol of pickling.</p><p>Fundamentally, an object’s <code>__reduce__()</code> would be called when it’s being serialized. The method’s expected behavior is described by <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pickle.html#object.__reduce__">the documentation</a> in detail. Unoffically, we could regard the return value as kind of IR, which dictates how to locate the object in specific module, or necessary information to restore the object from scratch.</p><p class="nomargin">According to the doc, <code>__reduce__()</code> should return either a string or a tuple. We are going to take apart the two cases in the next moment.</p><p>If a string returned, it should be the name of a local variable relative to the object’s module. Remember the <code>__qualname__</code> trick above? They do the same job. <code>pickle</code> treats the returned string as <code>__qualname__</code> of the object, storing it along with the module name <code>__module__</code> at serialization. The de-serializer afterwards would look up an attribute in the module with that string as name, and retrieve the object directly without creating from scratch.</p><p class="nomargin">It is useful for singleton object, i.e., object that be instantiated once and survives the whole program lifetime, for example, a database connection pool. We thus would not struggle on how to record the internal states for these objects.</p><p>When a tuple returned, well, it’s being a bit complicated. The tuple should contain 2~6 elements <sup id="fnref:4"><a href="#fn:4">4</a></sup>. The meaning of the elements would be described after, but before which, let’s get some understanding of how an object is created.</p><p class="nomargin">In the assumption of <code>pickle</code> module, an object is made up of a <em>skeleton</em>, and <em>states</em>. A skeleton is an initial version of an object, which is returned by a callable named <em>“constructor”</em>. Usually the constructor is the object’s <code>__new__()</code> method, but not necessarily. It could also be some factory function. States refer to all other attributes or elements that the object holds, which could be simple Python objects or external resources. At de-serialization, <code>pickle</code> would first set up a skeleton by calling constructor, then filling up the states. Either step can be customized to accord with your application logic.</p><p class="nomargin">Now we could talk about the scheme of returned tuple.</p><p class="nomargin">The 1-st and 2-nd elements describe how to set up a skeleton. The 1-st element is the constructor callable, and the 2-nd be a tuple of positional arguments, which the constructor takes. The two elements are both required. If no argument is needed, one should leave an empty tuple.</p><p class="nomargin">The remaining elements are optional, describing the states. <code>pickle</code> employs various strategies of restoring states. If the 6-th element provided, it should be a callable with signature <code>(obj, state)</code>, which performs state updating with the object and the 3-rd element as arguments. If not provided, <code>pickle</code> would look up a method named <code>__setstate__</code> on the object, which shares the same signature, and if found, it is served as the state updater. Otherwise, <code>pickle</code> expects the 3-rd element to be a dict, which would then be added to the object’s <code>__dict__</code>. The 4-th and 5-th elements are specialized for list- or dict-like object and less used. If supplied, they should be a list and a dict, which update the object through <code>.extend()</code> and <code>.update()</code> methods, respectively.</p><p>Directly implementing <code>__reduce__()</code> could be error-prone. <code>pickle</code> thus provides other object protocols to simplify the task. A list of the special methods could be found <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pickle.html#pickling-class-instances">here</a>. Users can implement some of them to serve the same purpose, e.g., <code>__getnewargs_ex__()</code> or <code>__getnewargs__()</code> for the 2-nd element, and <code>__getstate__()</code> for the 3-rd element.</p><p>Now let’s back to the title – what if my object is not picklable? The answer is, implementing your own pickling / unpickling logics via <code>__reduce__()</code> or other special methods. <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pickle.html#pickle-state">This section</a> in the docs showcases a good example, where an object maintains a file which should be re-opened and re-sought at de-serialization.</p><p class="nomargin">Here we discussed the scenario of serializing our customized types. Now what if the object to be pickled is out of our control?</p><h2 id="what-if-the-object-is-out-of-my-control">What if the object is out of my control?</h2><p>In some cases, one might have the demand to alter the pickling behavior for a specific type, either it is not supported, or the serialized byte stream is not efficient enough. The type is maintained by some libaries, and out of your control, so you could not change its <code>__reduce__()</code> to fit your requirement. <code>pickle</code> introduces some other interfaces to mitigate the problem from different aspects.</p><h3 id="dispatch-tables">Dispatch Tables</h3><p>This is the recommended way to pickle objects without disturbing any other external codes. Aside from looking up special methods on object, <code>pickle</code> also relies on module <code>copyreg</code> to seek reducers. The function <code>copyreg.pickle(type, reducer)</code> associates callable <code>reducer</code> as the reducer function of type <code>type</code>. <code>reducer</code> should accept arguments and return IR just like a <code>__reduce__()</code> method, and it shadows the original <code>__reduce__()</code> on <code>type</code>. <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pickle.html#dispatch-tables">The documentation</a> showcases the stuff with a simple example.</p><h3 id="persistent-id">Persistent ID</h3><p>Sometimes you would like to persist external objects that could be uniquely identified by some IDs. Think about entries of a database table, where foreign keys act as those IDs. Here storing IDs directly would be better and more efficient than turning the objects into IR. <code>pickle</code> have persistent ID for this purpose.</p><p class="nomargin">Unlike dispatch tables, resolution of persistent IDs is not defined in <code>pickle</code>. One should sub-class <code>Pickler</code> and <code>Unpickler</code> classes and overwrite <code>persistent_id()</code> and <code>persistent_load()</code>, respectively. An example of pickling table entries with persistent IDs could be found <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pickle.html#persistence-of-external-objects">here</a>.</p><h3 id="reducer_override">reducer_override()</h3><p>With only types given, users might still not able to decide the pickling behavior for some objects. If you want to pickle user-defined classes (not their instances) via dispatch tables, all reducings would be delegated to the same method, since in Python user-defined classes share a same base class <code>type</code>. Python 3.8 introduces the <code>reducer_override()</code> method on <code>Pickler</code> class to handle custom pickling in arbitary conditions. You might check technical details and examples at <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/pickle.html#custom-reduction-for-types-functions-and-other-objects">this link</a>.</p><blockquote><p>Personally, I found dispatch tables the most useful. You can always ensemble persistent IDs using IR, and dealing several different objects within a same reducer function is actually not that bad. In contrast, dispatch tables could enable the customization in a global manner, which is useful at some time.</p></blockquote><hr><h2 id="conclusion-1">Conclusion</h2><p>It’s such a long way here, but we made it!</p><p class="nomargin">We’ve seen some basic usage of <code>pickle</code>, the fundamental object protocols of pickling, as well as some other interfaces for customization. Hope the stuffs might give you a rough idea on this module, and be helpful for dealing with pickling problems.</p><div class="footnotes"><ol><li class="footnote" id="fn:1"><code>int</code>, <code>str</code>, <em>etc.</em></li><li class="footnote" id="fn:2"><code>42</code>, <code>&quot;foobar&quot;</code>, <em>etc.</em></li><li class="footnote" id="fn:3">such as <code>[int, &#123;42: &quot;foobar&quot;&#125;]</code></li><li class="footnote" id="fn:4">in Python with version lower than 3.8, this would be 2~5 elements</li></ol></div><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/Python/">Python</a><a href="/tags/pickle/">pickle</a></div><div class="post-nav"><a href="/unravelling-mocona-preface/" class="pre">«[Unravelling mocona] Part 0 - Preface</a><a href="/rough-notes-on-deploying-vaultwarden-and-nextcloud-bookmarks/" class="next">Rough Notes on Deploying Vaultwarden &amp; NextCloud Bookmarks»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="clarifying-pickle-in-python/",disqus_title="Understanding pickle in Python",disqus_url="https://i.hsfzxjy.site/clarifying-pickle-in-python/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"><div id="toc" lang="en" class="font__body"><div class="toc-toggler"></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#what-kind-of-object-is-picklable"><span class="toc-number">1.</span> <span class="toc-text">What kind of object is picklable?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#what-if-my-object-is-not-picklable"><span class="toc-number">2.</span> <span class="toc-text">What if my object is not picklable?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#what-if-the-object-is-out-of-my-control"><span class="toc-number">3.</span> <span class="toc-text">What if the object is out of my control?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dispatch-tables"><span class="toc-number">3.1.</span> <span class="toc-text">Dispatch Tables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#persistent-id"><span class="toc-number">3.2.</span> <span class="toc-text">Persistent ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reducer_override"><span class="toc-number">3.3.</span> <span class="toc-text">reducer_override()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#conclusion-1"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li></ol></div></div></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>