<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><title>Auto Rebuild .pyx Files with pyximport</title><meta itemprop="title" content="Auto Rebuild .pyx Files with pyximport - hsfzxjy 的博客"><meta itemprop="og:title" content="Auto Rebuild .pyx Files with pyximport - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="Modules written in Cython usually comes with a setup.py s..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">Auto Rebuild .pyx Files with pyximport</h1><div class="post__meta font__ui">2021-05-16 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body"><p>Modules written in Cython usually comes with a <code>setup.py</code> script that compiles Cython source codes into native shared libary. For whom not so familiar with Python’s packaging and distributing toolchains, such step is sometimes scary, and turns out to be a stumbling block for Cython freshmen. Moreover, the workflow, “run setup.py -&gt; debug -&gt; edit .pyx files -&gt; run setup.py”, is also less convenient and troublesome for fast iterating projects.</p><p><code>pyximport</code> is a handy tool from Cython official, provided to address the above problem. The module enables users to “directly import” <code>.pyx</code> files, with no explicit <code>setup.py</code> required. Let’s start from an example here. Say we have two files residing in the same directory:</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line"><span class="hljs-comment"># main.py</span></span><br><span class="line"><span class="hljs-keyword">import</span> pyximport</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># hl: begin</span></span><br><span class="line">pyximport.install(language_level=<span class="hljs-number">3</span>)</span><br><span class="line"><span class="hljs-comment"># hl: end</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> foo</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">print</span>(foo.func(<span class="hljs-number">3</span>))</span><br></pre></div></div><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line"><span class="hljs-comment"># foo.pyx</span></span><br><span class="line">cpdef <span class="hljs-built_in">int</span> sqr(<span class="hljs-built_in">int</span> x):</span><br><span class="line">    <span class="hljs-keyword">return</span> x * x</span><br></pre></div></div><p class="par">The magical <code class="_hl-label">highlighted</code> line registers some import hooks to let Python recognize <code>.pyx</code> files. When the <code>.pyx</code> files imported for the first time or modified later, <code>pyximport</code> compiles or re-compiles them behind the scene automatically.</p><p>By default, the built shared libaries are placed at <code>~/.pyxbld/</code>, which can be overrided with the <code>build_dir</code> argument of <code>pyximport.install</code>. One may also pass <code>inplace=True</code> to place the libraries sibling to their source files. For example:</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line"><span class="hljs-comment"># main.py</span></span><br><span class="line"><span class="hljs-keyword">import</span> pyximport</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># hl: begin</span></span><br><span class="line">pyximport.install(language_level=<span class="hljs-number">3</span>, inplace=<span class="hljs-literal">True</span>)</span><br><span class="line"><span class="hljs-comment"># hl: end</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> foo</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">print</span>(foo.func(<span class="hljs-number">3</span>))</span><br></pre></div></div><p class="par">will generate a <code>.so</code> (or <code>.pyd</code> in Windows) file in the same directory.</p><p>But there’s a problem with inplace building – the extension will not be automatically rebuilt. If you modify the <code>.pyx</code> file and re-run the program, the compilation process will not be triggered. The reason is that Python itself is able to recognize <code>.so</code> or <code>.pyd</code> modules, and their importers have higher priority than customized ones. Thus, if there’s an <code>.so</code> and a <code>.pyx</code> file with same module names reside in the same directory, the <code>.so</code> file will be imported instead of <code>.pyx</code>.</p><p>Therefore, if you want the compiled binaries be placed within your project directory, the best practice is to specify the <code>build_dir</code> argument. By setting <code>build_dir</code> to somewhere inside your project, compiled libraries will be kept within your project directory, but at the same time you can still enjoy the automatic rebuild service.</p><h2 id="references-6">References</h2><ul><li><a target="_blank" rel="noopener" href="https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiling-with-pyximport">https://cython.readthedocs.io/en/latest/src/userguide/source_files_and_compilation.html#compiling-with-pyximport</a></li></ul><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/Cython/">Cython</a></div><div class="post-nav"><a href="/indexeddb-performant-bulk-mutations/" class="pre">«Performant Bulk Mutations in IndexedDB</a><a href="/cython-and-threads/" class="next">Cython and Threads»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="cython-auto-reload/",disqus_title="Auto Rebuild .pyx Files with pyximport",disqus_url="https://i.hsfzxjy.site/cython-auto-reload/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"><div id="toc" lang="en" class="font__body"><div class="toc-toggler"></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#references-6"><span class="toc-number">1.</span> <span class="toc-text">References</span></a></li></ol></div></div></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>