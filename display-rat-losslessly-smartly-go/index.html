<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><title>Display *big.Rat Losslessly and Smartly in Golang</title><meta itemprop="title" content="Display *big.Rat Losslessly and Smartly in Golang - hsfzxjy 的博客"><meta itemprop="og:title" content="Display *big.Rat Losslessly and Smartly in Golang - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="Floating-point numbers, as we know, are notorious for los..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">Display *big.Rat Losslessly and Smartly in Golang</h1><div class="post__meta font__ui">2023-10-10 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body"><p>Floating-point numbers, as we know, are notorious for losing precision when their values become too large or too small. They are also bad at representing decimals accurately, yielding confusions like <code>0.1 + 0.2 != 0.3</code> for every beginner in their programming 101.</p><p>Albeit being imprecise, floats are good enough for most daily scenarios. For those not, however, Golang provides <code>*big.Rat</code> to the rescue. Rats are designed to represent rational numbers with arbitary precision, addressing most flaws of floats, yet at a cost of much slower computation speed and bigger memory footprint. For example, we are confident to compare <code>0.1 + 0.2</code> to <code>0.3</code> using Rats without caring about tolerance:</p><div class="gk-code hljs" data-gk-id="BLOCK1" data-gk-title="Floats vs Rats"><div class="gk-code-display"><pre><span class="gk-section gk-zip zipped" data-gk-sid="BLOCK1.SEC1" data-gk-type="zip"><span class="line"><span class="hljs-keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line">    <span class="hljs-string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="hljs-string">&quot;math/big&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br></span><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {</span><br><span class="line">    x, y := <span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span></span><br><span class="line">    f := x + y</span><br><span class="line">    fmt.Printf(<span class="hljs-string">&quot;%.20f %v\n&quot;</span>, f, f == <span class="hljs-number">0.3</span>)</span><br><span class="line">    <span class="hljs-comment">// 0.30000000000000004441 false</span></span><br><span class="line"></span><br><span class="line">    a, b := <span class="hljs-built_in">new</span>(big.Rat).SetFrac64(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>), <span class="hljs-built_in">new</span>(big.Rat).SetFrac64(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>)</span><br><span class="line">    c := <span class="hljs-built_in">new</span>(big.Rat).Add(a, b)</span><br><span class="line">    c2 := <span class="hljs-built_in">new</span>(big.Rat).SetFrac64(<span class="hljs-number">3</span>, <span class="hljs-number">10</span>)</span><br><span class="line">    fmt.Printf(<span class="hljs-string">&quot;%s %v\n&quot;</span>, c.FloatString(<span class="hljs-number">20</span>), c.Cmp(c2) == <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-comment">// 0.30000000000000000000 true</span></span><br><span class="line">}</span><br></pre></div></div><p>You may have noticed that the Rats are initialized by the <code>z.SetFrac64(a, b)</code> method, which sets <code>z</code> to the fractional number <code>a/b</code>. In fact there’s even a <code>z.SetString()</code> to parse a Rat from either its fractional or decimal representation, which is a convenient utility:</p><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line">r1, ok1 := <span class="hljs-built_in">new</span>(big.Rat).SetString(<span class="hljs-string">&quot;3/5&quot;</span>)</span><br><span class="line">r2, ok2 := <span class="hljs-built_in">new</span>(big.Rat).SetString(<span class="hljs-string">&quot;0.6&quot;</span>)</span><br></pre></div></div><p>In the above listing, both <code>r1</code> and <code>r2</code> equal to the same number of 0.6. <code>.SetString()</code> smartly infers the input format and performs parsing.</p><p>Now let’s think about the reversed problem – how to display a <code>*big.Rat</code> as string smartly and loselessly?</p><p>To clarify, we would like to obtain a string <code>s</code> from the given Rat <code>z</code>. <code>s</code> is formatted as decimal when <code>z</code> could be written as finite decimal, and otherwise formatted as fractional. If we give name <code>SmartRatString()</code> to such a function, some samples may be:</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line">SmartRatString(<span class="hljs-built_in">new</span>(big.Rat).SetFrac64(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)) == <span class="hljs-string">&quot;0.6&quot;</span></span><br><span class="line">SmartRatString(<span class="hljs-built_in">new</span>(big.Rat).SetFrac64(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)) == <span class="hljs-string">&quot;1/3&quot;</span> <span class="hljs-comment">// instead of 0.33333...</span></span><br></pre></div></div><p>This is a legitimate use case. You may want to print out some numbers to the user, and expect they would be parsed <i>exactly</i> as they were if being typed back, for the motive of reproducibility or whatever. Simultaneously, the numbers should be in decimal form whenever they could, to conform the preference of human.</p><p>Unfortunately, <code>*big.Rat</code> does not come with such conversion method. The most relevant ones we could find are <a target="_blank" rel="noopener" href="https://pkg.go.dev/math/big#Rat.RatString">RatString()</a> and <a target="_blank" rel="noopener" href="https://pkg.go.dev/math/big#Rat.FloatString">FloatString(prec)</a>. <code>RatString()</code> always converts the Rat into fractional form <code>a/b</code>, while <code>FloatString(prec)</code> displays it as decimal form with exactly <code>prec</code> digits after the decimal point.</p><p>A straightforward thought is to combine the two utility methods in an adaptive way. If the Rat couldn’t be written as finite decimal, we call the <code>RatString()</code>. Otherwise, we compute the appropriate <code>prec</code> for <code>FloatString()</code> such that the Rat is converted into decimal form without any truncation. In such a way, we reduce the problem into two simpler ones:</p><ol><li>How to determine a Rat has a finite decimal representation?</li><li>How to compute the number of digits after the decimal point?</li></ol><p class="par">Answers to both problems concealed in the factorization of the denominator. Say we have a rational number $z=a/b$ where $b \in \mathbb{Z}^+$ and $gcd(a, b)=1$. $z$ has a finite decimal form if and only if $b=2^n5^m$ for some natural numbers $n$ and $m$, while $\max(n, m)$ being the number of digits after the decimal point. These conclusions can be derived from some easy math so we won’t discuss in this post.</p><p>The following section will focus on the implementation. We can sketch out the framework of <code>SmartRatString()</code>:</p><div class="gk-code hljs" data-gk-id="BLOCK4" data-gk-title="SmartRatString() Sketch"><div class="gk-code-display"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SmartRatString</span><span class="hljs-params">(r *big.Rat)</span></span> <span class="hljs-type">string</span> {</span><br><span class="line">    denom := <span class="hljs-built_in">new</span>(big.Int).Set(r.Denom())</span><br><span class="line">    n := ... <span class="hljs-comment">// compute 2&#x27;s power in the factorization of denom</span></span><br><span class="line">    <span class="hljs-comment">// denom = denom / 2^n</span></span><br><span class="line">    m, isFiveExp := ... <span class="hljs-comment">// check power of 5</span></span><br><span class="line">    <span class="hljs-keyword">if</span> !isFiveExp {</span><br><span class="line">        <span class="hljs-keyword">return</span> r.RatString()</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> r.FloatString(<span class="hljs-type">int</span>(max(n, m)))</span><br><span class="line">}</span><br></pre></div></div><p>Estimating <code>n</code> is the easiest part. We can compute <code>n</code> by counting zero bits at the rear of <code>denom</code>‘s binary form, with the help of <code>TrailingZeroBits()</code> method. Dividing <code>denom</code> by <code>2^n</code> can also be achieved efficiently with bitwise right shifting. We complete the first blank as follows:</p><div class="gk-code hljs" data-gk-id="BLOCK5"><div class="gk-code-display"><pre><span class="gk-section gk-zip zipped" data-gk-sid="BLOCK5.SEC1" data-gk-type="zip"><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SmartRatString</span><span class="hljs-params">(r *big.Rat)</span></span> <span class="hljs-type">string</span> {</span><br><span class="line">    denom := <span class="hljs-built_in">new</span>(big.Int).Set(r.Denom())</span><br></span><span class="line">    n := denom.TrailingZeroBits()</span><br><span class="line">    denom.Rsh(&amp;denom, n)</span><br><span class="gk-section gk-zip zipped" data-gk-sid="BLOCK5.SEC2" data-gk-type="zip"><span class="line">    m, isFiveExp := ... <span class="hljs-comment">// check power of 5</span></span><br><span class="line">    <span class="hljs-keyword">if</span> !isFiveExp {</span><br><span class="line">        <span class="hljs-keyword">return</span> r.RatString()</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> r.FloatString(<span class="hljs-type">int</span>(max(n, m)))</span><br><span class="line">}</span><br></span></pre></div></div><p>For the second part, however, there’s no shortcut, at least I don’t have an idea. We have to iteratively divide <code>denom</code> by 5 until the process cannot proceed. For readability I write a small function <code>log5</code>:</p><div class="gk-code hljs" data-gk-id="log5"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">var</span> intOne = <span class="hljs-built_in">new</span>(big.Int).SetUint64(<span class="hljs-number">1</span>)</span><br><span class="line"><span class="hljs-keyword">var</span> intFive = <span class="hljs-built_in">new</span>(big.Int).SetUint64(<span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// log5 checks x in the form of $5^m$ or not. If so, isExp is true</span></span><br><span class="line"><span class="hljs-comment">// and cnt stores the power $m$.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">log5</span><span class="hljs-params">(x *big.Int)</span></span> (cnt <span class="hljs-type">uint</span>, isExp <span class="hljs-type">bool</span>) {</span><br><span class="line">    tmp2 := <span class="hljs-built_in">new</span>(big.Int)</span><br><span class="line">    m := <span class="hljs-built_in">new</span>(big.Int)  <span class="hljs-comment">// m stores the modulo</span></span><br><span class="line">    <span class="hljs-keyword">for</span> x.CmpAbs(intOne) &gt; <span class="hljs-number">0</span> {</span><br><span class="line">        tmp2.DivMod(x, intFive, m)</span><br><span class="line">        <span class="hljs-keyword">if</span> m.Sign() != <span class="hljs-number">0</span> {  <span class="hljs-comment">// m != 0</span></span><br><span class="line">            <span class="hljs-keyword">return</span> cnt, <span class="hljs-literal">false</span></span><br><span class="line">        }</span><br><span class="line">        cnt++</span><br><span class="line">        x, tmp2 = tmp2, x</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> cnt, <span class="hljs-literal">true</span></span><br><span class="line">}</span><br></pre></div></div><p>This function is not efficient but it serves the purpose. We modify the second part of <code>SmartRatString()</code> accordingly:</p><div class="gk-code hljs" data-gk-id="BLOCK6"><div class="gk-code-display"><pre><span class="gk-section gk-zip zipped" data-gk-sid="BLOCK6.SEC1" data-gk-type="zip"><span class="gk-section gk-include" data-gk-sid="BLOCK6.SEC2" data-gk-type="include" data-gk-referee="log5"><span class="line"><span class="hljs-keyword">var</span> intOne = <span class="hljs-built_in">new</span>(big.Int).SetUint64(<span class="hljs-number">1</span>)</span><br><span class="line"><span class="hljs-keyword">var</span> intFive = <span class="hljs-built_in">new</span>(big.Int).SetUint64(<span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// log5 checks x in the form of $5^m$ or not. If so, isExp is true</span></span><br><span class="line"><span class="hljs-comment">// and cnt stores the power $m$.</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">log5</span><span class="hljs-params">(x *big.Int)</span></span> (cnt <span class="hljs-type">uint</span>, isExp <span class="hljs-type">bool</span>) {</span><br><span class="line">    tmp2 := <span class="hljs-built_in">new</span>(big.Int)</span><br><span class="line">    m := <span class="hljs-built_in">new</span>(big.Int)  <span class="hljs-comment">// m stores the modulo</span></span><br><span class="line">    <span class="hljs-keyword">for</span> x.CmpAbs(intOne) &gt; <span class="hljs-number">0</span> {</span><br><span class="line">        tmp2.DivMod(x, intFive, m)</span><br><span class="line">        <span class="hljs-keyword">if</span> m.Sign() != <span class="hljs-number">0</span> {  <span class="hljs-comment">// m != 0</span></span><br><span class="line">            <span class="hljs-keyword">return</span> cnt, <span class="hljs-literal">false</span></span><br><span class="line">        }</span><br><span class="line">        cnt++</span><br><span class="line">        x, tmp2 = tmp2, x</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> cnt, <span class="hljs-literal">true</span></span><br><span class="line">}</span><br></span><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SmartRatString</span><span class="hljs-params">(r *big.Rat)</span></span> <span class="hljs-type">string</span> {</span><br><span class="line">    denom := <span class="hljs-built_in">new</span>(big.Int).Set(r.Denom())</span><br><span class="line">    n := denom.TrailingZeroBits()</span><br><span class="line">    denom.Rsh(&amp;denom, n)</span><br></span><span class="line">    m, isFiveExp := log5(&amp;denom)</span><br><span class="gk-section gk-zip zipped" data-gk-sid="BLOCK6.SEC3" data-gk-type="zip"><span class="line">    <span class="hljs-keyword">if</span> !isFiveExp {</span><br><span class="line">        <span class="hljs-keyword">return</span> r.RatString()</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> r.FloatString(<span class="hljs-type">int</span>(max(n, m)))</span><br><span class="line">}</span><br></span></pre></div></div><p>With all these in hand, we have finished the complete function of <code>SmartRatString()</code>.</p><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/Math/">Math</a><a href="/tags/Go/">Go</a></div><div class="post-nav"><a href="/zst-at-the-rear-of-go-struct/" class="pre">«Go Fact: Zero-sized Field at the Rear of a Struct Has Non-zero Size</a><a href="/coding-ceremory/" class="next">代码的仪式»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="display-rat-losslessly-smartly-go/",disqus_title="Display *big.Rat Losslessly and Smartly in Golang",disqus_url="https://i.hsfzxjy.site/display-rat-losslessly-smartly-go/";!function(){var s=document.createElement("script");s.type="text/javascript",s.async=!0,s.defer=!0,s.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(s),s.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>