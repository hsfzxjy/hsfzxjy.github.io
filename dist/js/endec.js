"use strict";(()=>{function x(r){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",r):r()}var S=class{constructor(){this.store=new Map;this.el2node=new Map}get(e){return this.el2node.get(e)}put(e,n){let a=this.store.get(e)??[];a.push(n),this.store.set(e,a),this.el2node.set(n.$el,n)}mapKind(e,n){return this.store.get(e).map(n)}forEachAll(e){for(let n of this.el2node.values())e(n)}},g=new S,E=class r{constructor(e){this.$el=e;e.classList.contains("encrypted")?(this.state=0,this.promise=Promise.resolve(2),this.meta=this.getMeta()):(this.state=2,this.meta={kind:""}),g.put(this.meta.kind,this),this.listeners=T.listeners.slice(),this.emitListeners()}static of(e){return g.get(e)??new r(e)}addListener(e){this.listeners.push(e),this.emitListeners()}emitListeners(){this.state===2&&(this.listeners.forEach(e=>e(this.$el)),this.listeners.length=0)}getPassphase(e){return window.localStorage.getItem(`passphase-${e}`)}decrypt(e){switch(this.state){case 1:if(!this.promise)throw new Error("bad state");return this.promise.then(t=>t!==2?this.decrypt(e):t);case 2:return Promise.resolve(2)}this.state=1;let n=this.$el.querySelector(".cover");n.classList.remove("hide");let a=e.passphase??this.getPassphase(e.kind)??"";return this.promise=this._decrypt(a).then(t=>(this.promise=void 0,this.state=t,this.emitListeners(),n.classList.add("hide"),t)),this.promise}getMeta(){let e=[];for(let s of this.$el.childNodes){if(s.nodeType!==Node.TEXT_NODE)break;e.push(s.data)}let[n,a,t,o]=e.join("").split(":");return{kind:n,keySalt:v.decode(a),ivSalt:v.decode(t),content:v.decode(o)}}async _decrypt(e){let{keySalt:n,ivSalt:a,content:t}=this.meta,{$el:o}=this,s=await d.getKeyMaterial(e),i=await d.getDecryptKey(s,n),c=await d.getIv(s,a),l,m={name:"AES-CBC",iv:c};try{l=await d.subtle.decrypt(m,i,t.buffer)}catch(p){return console.warn(p),0}let h=new TextDecoder().decode(l);return h.startsWith(d.KNOWN_PREFIX)?(o.classList.remove("encrypted"),o.innerHTML=h.slice(d.KNOWN_PREFIX.length),2):0}initForm(){switch(this.state){case 0:this._initForm();return;case 1:if(!this.promise)throw new Error("bad state");this.promise.then(()=>this.initForm());return}}_initForm(){let{$el:e}=this,{kind:n}=this.meta,a=e.querySelector("input[type=password]"),t=async c=>{c.preventDefault();let l=a.value;if(await this.decrypt({passphase:l})===0){alert("Incorrect passphase!");return}return await Promise.all(g.mapKind(n,y=>y.decrypt({passphase:l}))),window.localStorage.setItem(`passphase-${n}`,l),!1};e.querySelector("button").addEventListener("click",t),e.querySelector("form").addEventListener("submit",t);let o=e.querySelector("legend.header"),s=e.querySelector("legend.hint"),i=o.getAttribute("data-hint");o.addEventListener("click",()=>{s.innerHTML="HINT: "+i})}},T;(e=>e.listeners=[])(T||={});window.ENDEC={decryptEager(r,e){E.of(r).decrypt({kind:e})},onCleartext(r){T.listeners.push(r),g.forEachAll(e=>e.addListener(r))}};x(()=>{document.querySelectorAll("div.post__content").forEach(r=>E.of(r).initForm())});var v;(a=>{let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function e(t){return r.indexOf(t.charAt(t.length-1))==64?t.substring(0,t.length-1):t}function n(t,o=null){t=e(t),t=e(t);let s=Math.trunc(t.length/4*3),i,c,l,m,y,h,p,L,u=0,f=0;for(o?i=new Uint8Array(o):i=new Uint8Array(s),t=t.replace(/[^A-Za-z0-9+/=]/g,""),u=0;u<s;u+=3)y=r.indexOf(t.charAt(f++)),h=r.indexOf(t.charAt(f++)),p=r.indexOf(t.charAt(f++)),L=r.indexOf(t.charAt(f++)),c=y<<2|h>>4,l=(h&15)<<4|p>>2,m=(p&3)<<6|L,i[u]=c,p!=64&&(i[u+1]=l),L!=64&&(i[u+2]=m);return i}a.decode=n})(v||={});var d;(s=>{let r=window.crypto||window.msCrypto;s.subtle=r.subtle||r.webkitSubtle,s.KNOWN_PREFIX="<hexo-enhanced-encrytion></hexo-enhanced-encrytion>";function a(i){let c=new TextEncoder;return s.subtle.importKey("raw",c.encode(i),{name:"PBKDF2"},!1,["deriveKey","deriveBits"])}s.getKeyMaterial=a;function t(i,c){return s.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:c.buffer,iterations:1024},i,{name:"AES-CBC",length:256},!0,["decrypt"])}s.getDecryptKey=t;function o(i,c){return s.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:c.buffer,iterations:512},i,16*8)}s.getIv=o})(d||={});})();
//# sourceMappingURL=endec.js.map
