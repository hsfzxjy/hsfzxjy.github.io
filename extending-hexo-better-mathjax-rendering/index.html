<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script>(()=>{let e="/cnfonts.js?rDuukLHQ",t=document,n=navigator.serviceWorker,r=!1;var a;(r=n&&(n.register(e,{scope:"/"}).then(e=>e.update()),a=n.controller)&&a.scriptURL.endsWith(e)&&"activated"===a.state?!0:r)?((a=t.createElement("link")).rel="stylesheet",a.href="/fontchan/rDuukLHQ.css",a.blocking="render",t.head.appendChild(a)):((a=t.createElement("script")).src=e,a.onload=()=>$fontchan.injectCss(),t.head.appendChild(a))})()</script><title>[Extending Hexo For My Site] Part 1 - Better Mathjax Rendering</title><meta itemprop="title" content="[Extending Hexo For My Site] Part 1 - Better Mathjax Rendering - hsfzxjy 的博客"><meta itemprop="og:title" content="[Extending Hexo For My Site] Part 1 - Better Mathjax Rendering - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="I am a heavy user of Mathjax. Mathjax is a library that r..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">[Extending Hexo For My Site] Part 1 - Better Mathjax Rendering</h1><div class="post__meta font__ui">2022-01-03 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body"><p>I am a heavy user of <a target="_blank" rel="noopener" href="https://www.mathjax.org/">Mathjax</a>. Mathjax is a library that renders Tex-compatible syntax into pretty equations in web scenarios. Hence I am always mixing up Markdown and Tex snippets in my writing. The annoying part is Tex snippets have low priority in my Markdown renderer, and are sometimes incorrectly rendered into Markdown elements. For instance, <code>$a_1, a_2$</code> becomes <code>$a<em>1, a</em>2$</code>, where underscores within <code>$...$</code> are mistakenly recognized as an emphasis element. A bunch of escaping is required to avoid the situation, which drives me mad. So I got to seek a permanant solution.</p><p>The first attempt was to add specialized logic for Tex snippets into Markdown renderer, but I soon found it hardly a neat workaround. The renderer I use is <a target="_blank" rel="noopener" href="https://github.com/markedjs/marked">marked</a>. The package itself does not work alone, but depends on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo-renderer-marked">hexo-renderer-marked</a> as a wrapper. If I would add magic in <em>marked</em>, I had to fork and edit both <em>marked</em> and <em>hexo-renderer-marked</em>. Also, parsing Tex snippets is something beyond the duty of a Markdown renderer. There is no reason to nail the two stuff together, and I gave up.</p><p>Then I came up with another idea: what if I “guard” the Tex snippets before feeding the content into Markdown renderer? By “guarding” I mean to replace Tex snippets by something that <em>marked</em> ignores, and restore them after <em>marked</em> finishes rendering.</p><p>Actually, Hexo <em>DOES</em> provide such an official trick, though it’s not mentioned in the docs. In short, you can wrap a piece of content with a special tag <code>&lt;hexoPostRenderCodeBlock &gt;...&lt;/hexoPostRenderCodeBlock&gt;</code> in a <code>before_post_render</code> filter, to prevent it from being parsed by renderer. The code that handles the trick can be found at <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/blob/11b145c6c4aacbb69b4c10d49245090dd1db6375/lib/hexo/post.js#L402">hexo/post.js</a>. Before taken over by renderer, all <code>&lt;hexoPostRenderCodeBlock &gt;</code> tags will be detached and replaced by some special HTML comment tags like <code>&lt;--code\uFFFCxxx--&gt;</code>. After renderer finishes, each comment tag is substituted back to inner content of corresponding <code>&lt;hexoPostRenderCodeBlock &gt;</code> tag. Such usage exists both in <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/blob/11b145c6c4/lib/plugins/filter/before_post_render/backtick_code_block.js#L95">Hexo built-in plugin</a> and in <a target="_blank" rel="noopener" href="https://github.com/Aetf/hexo-prism-plus/blob/a44d14c639c49482d43807b8f298e287a8b1d9d1/src/code_block.js#L33">the wild</a>.</p><p>Our goal is clear now: build a <code>before_post_render</code> filter, which finds out each piece of legitimate Tex snippets, either inline-level <code>$...$</code> or block-level <code>$$...$$</code>, and wraps them with the magical <code>&lt;hexoPostRenderCodeBlock &gt;</code> tag. The matching can be realized using simple regular expressions:</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">const</span> rBlockMath = <span class="hljs-regexp">/^\$\$([^\$]+?)\$\$/gm</span></span><br><span class="line"><span class="hljs-keyword">const</span> rInlineMath = <span class="hljs-regexp">/(?&lt;!\$)\$([^\$\n]+?)\$(?!\$)/g</span></span><br></pre></div></div><p class="par"><code>rInlineMath</code> contains certain assertions in case block-level snippets mistakenly being interpreted as inline ones. Such concern can alternatively be addressed by first matching block-level snippets and then inline ones, but I would rather use assertions for better clarification.</p><p>Beyond the regular expressions, there is still some edge cases that should be carefully taken into consideration – <code>$</code> within code blocks should never be touched. Unfortunately, it’s not straightforward (or impossible) to achieve with mere regular expressions, since code block context is too complicated to match. A workaround here is required, that is to detach all code blocks beforehand, then handle the Tex snippets, and lastly restore the code blocks.</p><p>It’s also worth noting that <code>before_post_render</code> filters from other plugins can be executed prior to us, and thus <code>&lt;hexoPostRenderCodeBlock &gt;</code> tags can pre-exist in the content, whose inner texts are also expected to remain untouched. Our workaround then needs to handle three cases, magical tags and two forms of code blocks (single-backticked and triple-backticked).</p><p>But in fact, it is enough to consider only two of them. There’s a less known filter bundled in the <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/tree/11b145c6c4aacbb69b4c10d49245090dd1db6375/lib/plugins">built-in plugin</a> named <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/blob/11b145c6c4/lib/plugins/filter/before_post_render/backtick_code_block.js">backtick_code_block</a>. The filter syntax-highlights triple-backticked code blocks and guards them with the magical tag. At the time our filter gets executed, triple-backticked code blocks will have already been wrapped in <code>&lt;hexoPostRenderCodeBlock &gt;</code>, and no need to handle.</p><p>So here’s the pipeline: 1) find out all existing <code>&lt;hexoPostRenderCodeBlock &gt;</code> and single-backticked code blocks, and detach them; 2) find out all Tex snippets (inline or block-level), and wrap them with <code>&lt;hexoPostRenderCodeBlock &gt;</code> tag; 3) restore the aforementioned detached items. It’s also critical to register the filter with priority larger than 10, so that <code>backtick_code_block</code> filter will be called before us.</p><p>The filter <code>mathjax</code> is packed in plugin <code>hexo-enhanced</code> and the code at <a target="_blank" rel="noopener" href="https://github.com/hsfzxjy/hexo-enhanced/blob/main/lib/filter/before_post_render/mathjax.js">lib/filter/before_post_render/mathjax.js</a>. With it enabled, you can now write math equations on the fly just like in a Tex file, without any burden of escaping special characters.</p><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"></div><div class="post-nav"><a href="/rust-python-ffi-from-scratch/" class="pre">«Rust - Python FFI From Scratch</a><a href="/extending-hexo-preface/" class="next">[Extending Hexo For My Site] Part 0 - Preface»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="extending-hexo-better-mathjax-rendering/",disqus_title="[Extending Hexo For My Site] Part 1 - Better Mathjax Rendering",disqus_url="https://i.hsfzxjy.site/extending-hexo-better-mathjax-rendering/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>