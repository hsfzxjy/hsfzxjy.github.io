<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script>(()=>{let r="/cnfonts.js",n=document,e=n.createElement("link");e.rel="stylesheet",e.href="/fontchan/jBKCaHQX.css",e.blocking="render",e.onerror=()=>{var e=n.createElement("script");e.src=r,e.onload=()=>$fontchan.injectCss(),n.head.appendChild(e)},n.head.appendChild(e),"serviceWorker"in navigator&&navigator.serviceWorker.register(r,{scope:"/"}).then(e=>e.update())})()</script><title>Git sparse-checkout and partial clones for Mega-Repos</title><meta itemprop="title" content="Git sparse-checkout and partial clones for Mega-Repos - hsfzxjy 的博客"><meta itemprop="og:title" content="Git sparse-checkout and partial clones for Mega-Repos - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="Recently I was planning to make a small contribution to p..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Memo/">Memo</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">Git sparse-checkout and partial clones for Mega-Repos</h1><div class="post__meta font__ui">2023-05-05 | <span class="post__meta-categories"><a href="/categories/Memo/">Memo</a></span></div><div class="post__content font__body"><p>Recently I was planning to make a small contribution to project <a target="_blank" rel="noopener" href="https://github.com/DefinitelyTyped/DefinitelyTyped">DefinitelyTyped/DefinitelyTyped</a>. It is a huge repository that hosts and provides the type declaration files for thousands of packages on <a target="_blank" rel="noopener" href="https://npmjs.com/">npm</a>, with a structure like the following</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line">types/</span><br><span class="line">├── 11ty__eleventy-img</span><br><span class="line">├── 1line-aa</span><br><span class="line">├── 3box</span><br><span class="line">├── ...and more of them...</span><br></pre></div></div><p class="par">Each sub-folder under the <code>types/</code> directory corresponds to a specific npm package.</p><p>The package I am interested in is <code>marked</code>, whose type declaration files reside in <code>types/marked/</code> directory. Towards this end, cloning the whole repository and doing a full checkout is considered worthless, since my disk space and network traffic would be eaten up by a bunch of irrelevant files.</p><p>Then I read several lines of instructions in the <a target="_blank" rel="noopener" href="https://github.com/DefinitelyTyped/DefinitelyTyped#partial-clone">README</a> file, prompting that I could pair partial clone and sparse-checkout to achieve more efficient workflow. The instructions target a newer version of git 2.27, which doesn’t work for my environment with git 2.25. After some research I found the ones at <a target="_blank" rel="noopener" href="https://github.blog/2020-01-17-bring-your-monorepo-down-to-size-with-sparse-checkout/">Bring your monorepo down to size with sparse-checkout | Github Blog</a> for my case. If you would apply the steps in this post, make sure to check the version of git on your hand.</p><p>To start with, we clone the forked repository with some additional arguments:</p><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line">$ git clone --filter=blob:none --depth=1 --no-checkout git@github.com:hsfzxjy/DefinitelyTyped</span><br></pre></div></div><p class="par">With <code>--filter=blob:none</code> option, files in the repo won’t be fetched until they are needed in the future. This would be helpful where the repo contains large amounts of files but those of interest only take up a small proportion.</p><p class="nomargin">The <code>--depth=1</code> option creates a shallow clone with the commit history truncated and accelerates the cloning process. If you execute <code>git log</code> afterwards, only a single commit would be displayed.</p><p class="nomargin">And finally, the <code>--no-checkout</code> option tells git to not checkout any files, leaving simply a <code>.git</code> directory in the working area.</p><p>Finished the cloning, we run a special command to initialize the configuration for git sparse-checkout:</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line">$ cd DefinitelyTyped/</span><br><span class="line">$ git sparse-checkout init --cone</span><br></pre></div></div><p class="par">The <code>--cone</code> option, as described <a target="_blank" rel="noopener" href="https://github.blog/2020-01-17-bring-your-monorepo-down-to-size-with-sparse-checkout/#cone-mode-restricted-patterns-improve-performance">here</a>, enables the “Cone Mode” that brings improved performance during the checkout. After that, we use <code>git sparse-checkout set &lt;pattern&gt;</code> to take specific part of the repository into the working area:</p><div class="gk-code hljs" data-gk-id="BLOCK4"><div class="gk-code-display"><pre><span class="line">$ git sparse-checkout set types/marked</span><br></pre></div></div><p class="par">Now we should have the needed files ready under the root directory and the <code>types/marked/</code> directory, if you like a <code>tree</code> command to see:</p><div class="gk-code hljs" data-gk-id="BLOCK5"><div class="gk-code-display"><pre><span class="line">$ tree</span><br><span class="gk-section gk-zip zipped" data-gk-sid="BLOCK5.SEC1" data-gk-type="zip"><span class="line">.</span><br><span class="line">├── azure-pipelines.yml</span><br><span class="line">├── dangerfile.ts</span><br><span class="line">├── LICENSE</span><br><span class="line">├── notNeededPackages.json</span><br><span class="line">├── package.json</span><br><span class="line">├── README.es.md</span><br><span class="line">├── README.it.md</span><br><span class="line">├── README.ja.md</span><br><span class="line">├── README.ko.md</span><br><span class="line">├── README.md</span><br><span class="line">├── README.pt.md</span><br><span class="line">├── README.ru.md</span><br><span class="line">├── README.zh-Hans.md</span><br><span class="line">└── types</span><br><span class="line">    └── marked</span><br><span class="line">        ├── index.d.mts</span><br><span class="line">        ├── index.d.ts</span><br><span class="line">        ├── marked-tests.ts</span><br><span class="line">        ├── OTHER_FILES.txt</span><br><span class="line">        ├── package.json</span><br><span class="line">        ├── tsconfig.json</span><br><span class="line">        ├── tslint.json</span><br><span class="line">        └── v3</span><br><span class="line">            ├── index.d.ts</span><br><span class="line">            ├── marked-tests.ts</span><br><span class="line">            ├── tsconfig.json</span><br><span class="line">            └── tslint.json</span><br></span><span class="line">3 directories, 24 files</span><br></pre></div></div><p class="par">From here on, the daily git operations such as commits and pushes would proceed as per usual.</p><h2 id="references-10">References</h2><ul><li><a target="_blank" rel="noopener" href="https://github.blog/2020-01-17-bring-your-monorepo-down-to-size-with-sparse-checkout/">https://github.blog/2020-01-17-bring-your-monorepo-down-to-size-with-sparse-checkout/</a></li><li><a target="_blank" rel="noopener" href="https://github.blog/2020-12-21-get-up-to-speed-with-partial-clone-and-shallow-clone/">https://github.blog/2020-12-21-get-up-to-speed-with-partial-clone-and-shallow-clone/</a></li></ul><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/Git/">Git</a></div><div class="post-nav"><a href="/some-notes-on-kotlin-coroutines/" class="pre">«Some Notes on Kotlin Coroutines</a><a href="/disambiguate-feudalism/" class="next">辩义“封建”»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="git-sparse-checkout-and-partial-clones-for-mega-repos/",disqus_title="Git sparse-checkout and partial clones for Mega-Repos",disqus_url="https://i.hsfzxjy.site/git-sparse-checkout-and-partial-clones-for-mega-repos/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon current"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item current"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"><div id="toc" lang="en" class="font__body"><div class="toc-toggler"></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#references-10"><span class="toc-number">1.</span> <span class="toc-text">References</span></a></li></ol></div></div></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>