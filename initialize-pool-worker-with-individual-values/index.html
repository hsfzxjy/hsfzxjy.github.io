<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script>(()=>{let r="/cnfonts.js",n=document,e=n.createElement("link");e.rel="stylesheet",e.href="/fontchan/jBKCaHQX.css",e.blocking="render",e.onerror=()=>{var e=n.createElement("script");e.src=r,e.onload=()=>$fontchan.injectCss(),n.head.appendChild(e)},n.head.appendChild(e),"serviceWorker"in navigator&&navigator.serviceWorker.register(r,{scope:"/"}).then(e=>e.update())})()</script><title>Initialize Process Pool Worker with Individual Value</title><meta itemprop="title" content="Initialize Process Pool Worker with Individual Value - hsfzxjy 的博客"><meta itemprop="og:title" content="Initialize Process Pool Worker with Individual Value - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="There could be scenes when you are using multiprocessing...."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">Initialize Process Pool Worker with Individual Value</h1><div class="post__meta font__ui">2022-03-21 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body"><p>There could be scenes when you are using <code>multiprocessing.pool.Pool</code> and you want to perform some initialization for each worker before tasks are scheduled via <code>Pool.map()</code> or something alike. For example, you create a pool of 4 workers, each for one GPU, and expect tasks scheduled on Worker-i to precisely utilize GPU-i. In this case, Worker-i should be initialized with env var <code>CUDA_VISIBLE_DEVICES=&lt;i&gt;</code> set.</p><p>To initialize spawned workers, the constructor of <code>Pool</code> provides two arguments concerning the job <sup id="fnref:1"><a href="#fn:1">1</a></sup> – <code>initializer</code> and <code>initargs</code>. <code>initializer</code> is expected to be a callable, and if specified, each worker process will call <code>initializer(*initargs)</code> when it starts.</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">import</span> multiprocessing <span class="hljs-keyword">as</span> mp</span><br><span class="line"><span class="hljs-keyword">import</span> multiprocessing.pool <span class="hljs-keyword">as</span> mpp</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">arg1</span>):</span><br><span class="line">    <span class="hljs-built_in">print</span>(arg1)</span><br><span class="line"></span><br><span class="line">mpp.Pool(processes=<span class="hljs-number">2</span>, initializer=worker, initargs=(<span class="hljs-number">42</span>, ))</span><br><span class="line"><span class="hljs-comment"># 42</span></span><br><span class="line"><span class="hljs-comment"># 42</span></span><br></pre></div></div><p class="par">This is, however, slightly away from what we expect. The <code>initializer</code> is called with same arguments in each worker, while in our case, the arguments are expected to be different, like value <code>1</code> for Worker-0 and value <code>1</code> for Worker-1. There are two approaches to do the tricks.</p><h2 id="use-a-queue">Use a Queue</h2><p><code>Queue</code> and <code>SimpleQueue</code> types in module <code>multiprocessing</code> <sup id="fnref:2"><a href="#fn:2">2</a></sup> implement multi-producer, multi-consumer FIFO queues under the multi-processing scenario. We may create and share a queue among parent and worker processes, send individual values from parent processes and read them from workers. Since the sending and receiving operations are synchronized, we won’t run into any race conditions.</p><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">q</span>):</span><br><span class="line">    <span class="hljs-built_in">print</span>(q.get())</span><br><span class="line"></span><br><span class="line">q = mp.SimpleQueue()</span><br><span class="line">p = mpp.Pool(processes=<span class="hljs-number">2</span>, initializer=worker, initargs=(q,))</span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):</span><br><span class="line">    q.put(i)</span><br><span class="line">p.close()</span><br><span class="line"><span class="hljs-comment"># 0</span></span><br><span class="line"><span class="hljs-comment"># 1</span></span><br></pre></div></div><h2 id="use-a-value">Use a Value</h2><p>Alternatively, we may use a lighter shared object other than a queue. The <code>Value</code> type in module <code>multiprocessing</code> <sup id="fnref:3"><a href="#fn:3">3</a></sup> allows sharing simple values across multiple processes. It can also synchronize accesses to values to avoid race conditions if necessary. We can use a <code>Value</code> object to allocate an individual id for each worker process.</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">v</span>):</span><br><span class="line">    <span class="hljs-keyword">with</span> v.get_lock():</span><br><span class="line">        val = v.value</span><br><span class="line">        v.value += <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-built_in">print</span>(val)</span><br><span class="line"></span><br><span class="line">v = mp.Value(ctypes.c_int32, <span class="hljs-number">0</span>, lock=<span class="hljs-literal">True</span>)</span><br><span class="line">p = mpp.Pool(processes=<span class="hljs-number">2</span>, initializer=worker, initargs=(v,))</span><br><span class="line">p.close()</span><br><span class="line"><span class="hljs-comment"># 0</span></span><br><span class="line"><span class="hljs-comment"># 1</span></span><br></pre></div></div><div class="footnotes"><ol><li class="footnote" id="fn:1"><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool">https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool</a></li><li class="footnote" id="fn:2"><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.Queue">https://docs.python.org/3/library/multiprocessing.html#multiprocessing.Queue</a></li><li class="footnote" id="fn:3"><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.Value">https://docs.python.org/3/library/multiprocessing.html#multiprocessing.Value</a></li></ol></div><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/Python/">Python</a><a href="/tags/Multiprocessing/">Multiprocessing</a></div><div class="post-nav"><a href="/a-bug-of-promoting-complex-trait-bounds-in-rust/" class="pre">«A Flaw of Promoting Complex Trait Bounds in Rust</a><a href="/rust-python-ffi-from-scratch/" class="next">Rust - Python FFI From Scratch»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="initialize-pool-worker-with-individual-values/",disqus_title="Initialize Process Pool Worker with Individual Value",disqus_url="https://i.hsfzxjy.site/initialize-pool-worker-with-individual-values/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"><div id="toc" lang="en" class="font__body"><div class="toc-toggler"></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#use-a-queue"><span class="toc-number">1.</span> <span class="toc-text">Use a Queue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#use-a-value"><span class="toc-number">2.</span> <span class="toc-text">Use a Value</span></a></li></ol></div></div></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>