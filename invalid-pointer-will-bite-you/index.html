<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><title>Invalid Golang Pointers Can Bite You Even If You Don't Dereference</title><meta itemprop="title" content="Invalid Golang Pointers Can Bite You Even If You Don't Dereference - hsfzxjy 的博客"><meta itemprop="og:title" content="Invalid Golang Pointers Can Bite You Even If You Don't Dereference - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="In Golang, if you coerce a uintptr variable into unsafe.P..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">Invalid Golang Pointers Can Bite You Even If You Don't Dereference</h1><div class="post__meta font__ui">2022-04-19 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body"><p>In Golang, if you coerce a <code>uintptr</code> variable into <code>unsafe.Pointer</code> (or further, to some <code>*T</code>), the linter will warn with the message <code>&quot;possible miuse of unsafe.Pointer&quot;</code>. This makes sense because the <code>uintptr</code> variable may contain an address that points to a piece of invalid memory, and dereferencing such a pointer is catastrophic (usually aborts the program).</p><p>I was always aware of the above discipline, but I thought it would be OK to hold the pointers but not dereference them. This is true in C/C++, but not for Golang, which I did not realize until recently.</p><p>In fact, <strong>the program can panic even if you just keep an invalid pointer on the stack!</strong></p><h2 id="a-strange-invalid-pointer-panic">A strange invalid pointer panic</h2><p>The story back from an attempt of interoperation between Golang and JVM, when I was working on a Go-written dynamic library which need to operate bluetooth socket on Android. Android does not provide any native interfaces for bluetooth, so I had to call into JVM and invoke Java APIs.</p><p>I have learned JNI <sup id="fnref:1"><a href="#fn:1">1</a></sup> beforehand, which is an interface designed for interacting with JVM from native codes. Since JNI is provided to programmers as C++ header files, I had to seek a Golang binding. Then I noticed <a target="_blank" rel="noopener" href="https://github.com/xlab/android-go">xlab/android-go</a> which, as utilities, encapsulates the full list of JNI types and functions. The project was out of maintenance for some while, but using only the JNI pieces should be fine.</p><p>With the help of xlab/android-go, I quickly finished a prototype of my library, so good, so far. I bundled the library into apk file, ran it on my phone, but unfortunately it crashed with the stack strace</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line">runtime: bad pointer in frame kcore_android/bluetooth.ioWorker.Loop at 0x400018eeb0: 0x1</span><br><span class="line">fatal error: invalid pointer found on stack</span><br><span class="line"></span><br><span class="line">runtime stack:</span><br><span class="line">runtime.throw({0x7dbf000df2?, 0x7dbf19b4a0?})</span><br><span class="line">  /usr/local/go/src/runtime/panic.go:992 +0x50 fp=0x7d980b6c70 sp=0x7d980b6c40 pc=0x7dbf058ff0</span><br><span class="line">runtime.adjustpointers(0x7d980b7000?, 0x36581?, 0x7dbf164983?, {0x7dbf192338?, 0x7dbf19b4a0?})</span><br><span class="line">  /usr/local/go/src/runtime/stack.go:628 +0x1cc fp=0x7d980b6cb0 sp=0x7d980b6c70 pc=0x7dbf0716cc</span><br><span class="line">runtime.adjustframe(0x7d980b7000, 0x7d980b70f8)</span><br><span class="line">  /usr/local/go/src/runtime/stack.go:670 +0xa4 fp=0x7d980b6d40 sp=0x7d980b6cb0 pc=0x7dbf0717b4</span><br><span class="line">runtime.gentraceback(0x7d00001000?, 0x7d980b7140?, 0xffffff80ffffffe0?, 0x40001824e0, 0x0, 0x0, 0x7fffffff, 0x7dbf116168, 0x43?, 0x0)</span><br><span class="line">  /usr/local/go/src/runtime/traceback.go:330 +0x734 fp=0x7d980b7060 sp=0x7d980b6d40 pc=0x7dbf07b7d4</span><br><span class="line">runtime.copystack(0x40001824e0, 0x1000)</span><br><span class="line">  /usr/local/go/src/runtime/stack.go:930 +0x300 fp=0x7d980b7220 sp=0x7d980b7060 pc=0x7dbf071fa0</span><br><span class="line">runtime.newstack()</span><br><span class="line">  /usr/local/go/src/runtime/stack.go:1110 +0x37c fp=0x7d980b73d0 sp=0x7d980b7220 pc=0x7dbf0723fc</span><br><span class="line">runtime.morestack()</span><br><span class="line">  /usr/local/go/src/runtime/asm_arm64.s:314 +0x70 fp=0x7d980b73d0 sp=0x7d980b73d0 pc=0x7dbf084bc0</span><br><span class="line"></span><br><span class="line">goroutine 51 [copystack, locked to thread]:</span><br><span class="line">--- snip ---</span><br></pre></div></div><p class="par">I was not frightened, since no code would succeed in one go. But the error report did frustrate me from two perspectives</p><ol><li>It involved one of my stack frames (<code>kcore_android/bluetooth.ioWorker.Loop</code>), but the panic was thrown from some source code that lies out of my codebase (<code>runtime/stack.go</code>).</li><li>It was caused by an invalid pointer, whose value was <code>0x1</code>.</li></ol><p class="par">I guessed the pointer was returned from the Java side, for some unknown reason it had a wierd value of <code>0x1</code>. But what I didn’t understand is how it could crash my program. I have tried carefully to avoid dereferencing any non-Go pointer in my code.</p><p class="nomargin">Also, the mismatch between stack frame and source code made me really difficult to locate the problem. For a time I thought <code>goroutine 51</code> stopped at the scene where the pointer troubled, as its stack trace contained the aforementioned frame <code>bluetooth.ioWorker.Loop</code>, but it didn’t. In fact, the goroutine stopped at another line when I restarted the program! This was annoying.</p><p>It took me almost half a day to resolve and understand the problem. I will first explain the origin of the invalid pointer, and then show how it would crash the program.</p><h2 id="the-origin-of-0x1-pointer">The origin of <code>0x1</code> pointer</h2><p>In JNI, the C type <code>jobject</code> acts as a handle for Java object, which is technically an alias of <code>void*</code>. They can be created by calling most JNI functions like <code>JNIEnv-&gt;CallObjectMethod</code>.</p><p class="nomargin">Although being a pointer type, a <code>jobject</code> variable is not necessarily a valid pointer. To understand one should know that there exists two kinds of object references in JNI, <em>local reference</em> and <em>global reference</em>. Local references will be recycled at the end of a Java frame, while global references survive longer until you delete them.</p><p class="nomargin">They not only differ semantically, but practically diverse in values. Local references often contain smaller values like <code>0x01</code>, <code>0x75</code>, yet global references will have values like <code>0x7dbeffc1cf</code>. I guess local references are not actual pointers but indices of some internal object tables.</p><p class="nomargin">Symmetrically, xlab/android-go defines a <code>Jobject</code> which was an alias for <code>unsafe.Pointer</code>. So if you recieve a local reference from JNI functions, you are owning an invalid pointer at Go side.</p><h2 id="go-runtime-checks-invalid-pointers-during-stack-growth">Go runtime checks invalid pointers during stack growth</h2><p>What’s interesting is that, <strong>goroutines do not statically allocate their stack</strong>. Instead, they are able to grow or shrink the stack according to our needs. I will not dive into the details of this mechanism, which you may read from the article <a target="_blank" rel="noopener" href="https://medium.com/a-journey-with-go/go-how-does-the-goroutine-stack-size-evolve-447fc02085e5">Go: How does the goroutine stack size evolve?</a> if you are interested.</p><p class="nomargin">My panic was thrown by an invalid pointer checking during stack growing. Why should the Go runtime check for invalid pointers here? Because growing a stack involves memory re-allocation, and the runtime must ensure no pointer is invalidated after the potential moving.</p><p class="nomargin">To see how a moving could invalidate pointers, let’s consider an example. Say we have a goroutine whose stack ranged in address space <code>0x8000 - 0x8800</code>. An integer <code>i int</code> was stored at <code>0x8000</code>, and a pointer <code>ptr *int</code> referenced to that <code>int</code> stored at <code>0x8004</code>, whose value is <code>0x8000</code>. Now we grow the stack by moving it to address space <code>0xA000 - 0xB000</code>. If <code>ptr</code> retains its old value, it will no longer point to <code>i</code> since <code>i</code> has been moved to <code>0xA000</code>! Therefore, during a stack growth, Go runtime must also check the existence for such pointers, and change their values accordingly.</p><p class="nomargin">However, the Go runtime does more than checking whether or not a pointer value falls in the old address space range. It also checks and complains about pointers with small values</p><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">adjustpointers</span><span class="hljs-params">(/*...*/)</span></span> {</span><br><span class="line">    <span class="hljs-comment">/* --- snip --- */</span></span><br><span class="line">    <span class="hljs-keyword">if</span> f.valid() &amp;&amp; <span class="hljs-number">0</span> &lt; p &amp;&amp; p &lt; minLegalPointer &amp;&amp; debug.invalidptr != <span class="hljs-number">0</span> {</span><br><span class="line">        <span class="hljs-comment">// Looks like a junk value in a pointer slot.</span></span><br><span class="line">        <span class="hljs-comment">// Live analysis wrong?</span></span><br><span class="line">        getg().m.traceback = <span class="hljs-number">2</span></span><br><span class="line">        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;runtime: bad pointer in frame &quot;</span>, funcname(f), <span class="hljs-string">&quot; at &quot;</span>, pp, <span class="hljs-string">&quot;: &quot;</span>, hex(p), <span class="hljs-string">&quot;\n&quot;</span>)</span><br><span class="line">        throw(<span class="hljs-string">&quot;invalid pointer found on stack&quot;</span>)</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">/* --- snip --- */</span></span><br><span class="line">}</span><br></pre></div></div><p class="par">The above snippet can be found at <a target="_blank" rel="noopener" href="https://github.com/golang/go/blob/release-branch.go1.18/src/runtime/stack.go#L623">runtime/stack.go</a>. If a pointer value is less than <code>minLegalPointer</code> (which is <code>4096</code>), the runtime will also panic! And that’s the culprit for my case.</p><h2 id="conclusion-3">Conclusion</h2><p>Now I know that the panic comes from two aspects. First I have an invalid pointer due to FFI, although I don’t mean to dereference it. The Go runtime, however, does more than I thought behind the scene. It moves the goroutine stack when necessary, during which it checks and complains for invalid pointers.</p><p>This reminds me not to coerce foreign pointer-like values into Go pointers, if you won’t dereference them at the Go side. The safest practice is to keep them <code>uintptr</code>. As a solution, I patch and slim xlab/android-go into <a target="_blank" rel="noopener" href="https://github.com/hsfzxjy/android-jni-go">hsfzxjy/android-jni-go</a>, which works like a charm.</p><p>I also create a minimal example to reproduce the above problem, for whom interested to investigate. In this example, the main goroutine stack will grow during the invocation of <code>foo() -&gt; bar() -&gt; baz()</code>, during which the Go runtime encounters the crafted pointer <code>ptr</code>, and eventually panics.</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> (</span><br><span class="line">    <span class="hljs-string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="hljs-string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {</span><br><span class="line">    <span class="hljs-keyword">var</span> a [<span class="hljs-number">10</span>]<span class="hljs-type">int</span></span><br><span class="line">    foo(a)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//go:noinline</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">foo</span><span class="hljs-params">(a [10]<span class="hljs-type">int</span>)</span></span> {</span><br><span class="line">    <span class="hljs-keyword">var</span> b [<span class="hljs-number">100</span>]<span class="hljs-type">int</span></span><br><span class="line">    ptr := unsafe.Pointer(<span class="hljs-type">uintptr</span>(<span class="hljs-number">1</span>))</span><br><span class="line">    bar(b)</span><br><span class="line">    fmt.Printf(<span class="hljs-string">&quot;%p\n&quot;</span>, ptr)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//go:noinline</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">bar</span><span class="hljs-params">(a [100]<span class="hljs-type">int</span>)</span></span> {</span><br><span class="line">    <span class="hljs-keyword">var</span> b [<span class="hljs-number">1000</span>]<span class="hljs-type">int</span></span><br><span class="line">    baz(b)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">//go:noinline</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">baz</span><span class="hljs-params">(a [1000]<span class="hljs-type">int</span>)</span></span> {}</span><br></pre></div></div><div class="footnotes"><ol><li class="footnote" id="fn:1"><a target="_blank" rel="noopener" href="https://developer.android.com/training/articles/perf-jni">https://developer.android.com/training/articles/perf-jni</a></li></ol></div><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/FFI/">FFI</a><a href="/tags/Go/">Go</a></div><div class="post-nav"><a href="/human-sucks/" class="pre">«人类一败涂地</a><a href="/side-project/" class="next">Side Project（副业）»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="invalid-pointer-will-bite-you/",disqus_title="Invalid Golang Pointers Can Bite You Even If You Don't Dereference",disqus_url="https://i.hsfzxjy.site/invalid-pointer-will-bite-you/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"><div id="toc" lang="en" class="font__body"><div class="toc-toggler"></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#a-strange-invalid-pointer-panic"><span class="toc-number">1.</span> <span class="toc-text">A strange invalid pointer panic</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-origin-of-0x1-pointer"><span class="toc-number">2.</span> <span class="toc-text">The origin of 0x1 pointer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go-runtime-checks-invalid-pointers-during-stack-growth"><span class="toc-number">3.</span> <span class="toc-text">Go runtime checks invalid pointers during stack growth</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#conclusion-3"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li></ol></div></div></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>