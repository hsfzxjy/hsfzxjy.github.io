<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><title>hsfzxjy 的博客</title><meta itemprop="title" content="hsfzxjy 的博客"><meta itemprop="og:title" content="hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/">Home</a></div></nav><main class="mainContainer"><div class="post-list"><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/tensor-cuda-hang/">Debug a 'torch.tensor(1).cuda()' hanging</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-12-14 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="146a0bcd8ee67c90f3c08de594847e5d555aa30fde8f662b29e237146ba51c2b" class="post__content font__body"><p>Today a user of our GPU cluster ran into a problem where executing <code>python -c &#39;import torch; torch.tensor(1).cuda()</code> would hang forever and could not be killed. The problem occured on a rather old Docker image (with <code>torch == 0.4.0</code>), and would disappear if newer images were used. It was caused by some far less known coincidents, which surprised me and I want to share in this post.</p><h2 id="the-problem-1">The Problem</h2><p>The hanging program is spawned by following command:</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line">/usr/bin/docker run --<span class="hljs-built_in">rm</span> -u 1457:1457 \</span><br><span class="line">    --gpus <span class="hljs-string">&#x27;&quot;device=&#x27;</span>0,1,2,3<span class="hljs-string">&#x27;&quot;&#x27;</span> \</span><br><span class="line">    -v /ghome/username:/ghome/username -v /gdata/username:/gdata/username \</span><br><span class="line">    -it --ipc=host --shm-size 64G \</span><br><span class="line">    -v /gdata1/username:/gdata1/username -v /gdata2/username:/gdata2/username \</span><br><span class="line">    -e HOME=/ghome/username \</span><br><span class="line">    -m 48G --memory-swap 48G --cpus 5 \</span><br><span class="line">    --name username2 \</span><br><span class="line">    bit:5000/deepo_9 \</span><br><span class="line">    python3 -c <span class="hljs-string">&#x27;import torch; torch.tensor(1).cuda()&#x27;</span></span><br></pre></div></div><p class="par">the Docker image <code>bit:5000/deepo_9</code> he used was built with CUDA-9, while the host has multiple 1080Ti GPU cards and CUDA upgraded to 11.4. Looks like there’s some binary incompatibility, considering the fact that the problem would gone with newer images.</p></div><div lang="zh" class="post__readmore font__ui"><a href="/tensor-cuda-hang/">READ MORE</a></div></article><article lang="zh" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/internet-is-not-liberal/">不自由的互联网</a></h1><span class="post__lang-tag font__ui">zh</span></div><div lang="zh" class="post__meta font__ui">2021-11-23 | <span class="post__meta-categories"><a href="/categories/Soliloquy/">Soliloquy</a></span></div><div data-post-id="9c37c0903dfe297f4eda265649bca0580f95a08235eff9e5e462ac355e4cbddd" class="post__content font__body"><p>互联网正在变得不自由——这已经成为了一种共识。这种不自由是从获取内容的角度出发，我们依自己的意愿获取知识/资讯的难度在增加。「中文互联网已死」。优质资源被各大互联网巨头所垄断，人们只能从应用内部访问，并时常受到推荐算法的说教。在巨头领域之外的公网则是一片荒漠，充斥着大量低质量、重复的内容，让秉承自主意志前来探索的人心寒。而在世界其他地方，情况可能没有这么严重，但类似的现象如巨头垄断也是存在的。互联网并不像十几年前我们所憧憬的那样。</p></div><div lang="zh" class="post__readmore font__ui"><a href="/internet-is-not-liberal/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/a-trick-to-retrieve-web-contents-without-curl-or-wget/">Retrieve Contents over HTTP without curl or wget</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-10-30 | <span class="post__meta-categories"><a href="/categories/Memo/">Memo</a></span></div><div data-post-id="0d7e24275ce64448609bdfbac4055dc5974f442fad14b2a87af4d5b5455850dc" class="post__content font__body"><p>I came across a piece of interesting vulnerable script from a post on V2EX <sup id="fnref:1"><a href="#fn:1">1</a></sup>) on V2EX. A bash function named <code>__curl</code> inside the file retrieves contents over HTTP as a simple alternative for command <code>curl</code> or <code>wget</code>, in scenarios where no such utilities available.</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">#!/bin/bash</span></span><br><span class="line"><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">__curl</span></span>() {</span><br><span class="line">  <span class="hljs-built_in">read</span> proto server path &lt;&lt;&lt;$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">${1//// }</span>)</span><br><span class="line">  DOC=/<span class="hljs-variable">${path// //}</span></span><br><span class="line">  HOST=<span class="hljs-variable">${server//:*}</span></span><br><span class="line">  PORT=<span class="hljs-variable">${server//*:}</span></span><br><span class="line">  [[ x<span class="hljs-string">&quot;<span class="hljs-variable">${HOST}</span>&quot;</span> == x<span class="hljs-string">&quot;<span class="hljs-variable">${PORT}</span>&quot;</span> ]] &amp;&amp; PORT=80</span><br><span class="line"></span><br><span class="line">  <span class="hljs-built_in">exec</span> 3&lt;&gt;/dev/tcp/<span class="hljs-variable">${HOST}</span>/<span class="hljs-variable">$PORT</span></span><br><span class="line">  <span class="hljs-built_in">echo</span> -en <span class="hljs-string">&quot;GET <span class="hljs-variable">${DOC}</span> HTTP/1.0\r\nHost: <span class="hljs-variable">${HOST}</span>\r\n\r\n&quot;</span> &gt;&amp;3</span><br><span class="line">  (<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> line; <span class="hljs-keyword">do</span></span><br><span class="line">   [[ <span class="hljs-string">&quot;<span class="hljs-variable">$line</span>&quot;</span> == $<span class="hljs-string">&#x27;\r&#x27;</span> ]] &amp;&amp; <span class="hljs-built_in">break</span></span><br><span class="line">  <span class="hljs-keyword">done</span> &amp;&amp; <span class="hljs-built_in">cat</span>) &lt;&amp;3</span><br><span class="line">  <span class="hljs-built_in">exec</span> 3&gt;&amp;-</span><br><span class="line">}</span><br></pre></div></div><p class="par">The function makes use of certain less known features of Linux and the Bash language.</p><p class="noindent">The first one is <strong>communicating over TCP through files</strong>. Linux employs a design philosophy of “everything are files”. One could find some special device files in directory <code>/dev</code>, through which we can manipulate the underlying devices. Specifically, manipulating a TCP socket connecting <code>$&#123;HOST&#125;:$&#123;PORT&#125;</code> could be achieved by accessing device file <code>/dev/tcp/$&#123;HOST&#125;/$&#123;PORT&#125;</code>. Since HTTP is a text-based protocol over TCP, working with it is no more difficult than reading / writing a text file. Line <code>exec 3&lt;&gt;$FILENAME</code> opens file <code>$FILENAME</code> under read-write mode and binds it to descriptor 3. The next line then manually composes an HTTP payload and writes out to <code>&amp;3</code>, which is in fact requesting the URL <code>http ://$&#123;HOST&#125;:$&#123;PORT&#125;</code>. By reading the same file descriptor, we retrieve the response content from the service. The trick serves as a primitive workaround for retrieving contents from web.</p><p class="noindent">Another one is <strong>parameter substitution in Bash</strong>. The expression <code>$&#123;var//PATTERN/REPL&#125;</code> substitutes <em>all</em> occurrences of <code>PATTERN</code> in <code>var</code> into <code>REPL</code>. If <code>REPL</code> omitted, the matched substrings will be deleted. For example, in this script, <code>$&#123;1//// &#125;</code> would replace all slashes <code>/</code> into white spaces in variable <code>$1</code>.</p><p class="noindent">References</p><ol><li><a target="_blank" rel="noopener" href="https://tldp.org/LDP/abs/html/parameter-substitution.html">Parameter Substitution</a></li></ol><div class="footnotes"><ol><li class="footnote" id="fn:1">[收到条阿里云的告警，看不懂是做什么用的，请教一下 - V2EX](<a target="_blank" rel="noopener" href="https://www.v2ex.com/t/811424">https://www.v2ex.com/t/811424</a></li></ol></div></div><div lang="zh" class="post__readmore font__ui"><a href="/a-trick-to-retrieve-web-contents-without-curl-or-wget/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/unravelling-mocona-verbosity-or-anti-pattern/">[Unravelling mocona] Part 1 - Verbosity or Anti-Pattern</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-09-16 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="c3b583bf87b83e83166344a1c71e8af2eaa6f7b14f548ff826ab6253ec5264e8" class="post__content font__body"><p>I was once working as an intern at MSRA around two years ago, at which I joined a research project and started developing upon a large codebase. It’s a practice in ML research fields to adopt an existing code repository as codebase, instead of crafting everything from scratch. Such codebases usually come with convenient “infrastructures” , so researchers would not have to implement them once again, which could be time-wasting and error-prone. All we need is to write our models and losses, and put them into experiments.</p><p>The flow works just fine if you are proposing minor improvement on algorithms. The codebase provides an easy approach to prove and iterate your idea. But things would get worse if your work goes beyond it, especially touching the encapsulated infrastructures. Those convenient parts would constraint you and enforce your code into spaghetti.</p></div><div lang="zh" class="post__readmore font__ui"><a href="/unravelling-mocona-verbosity-or-anti-pattern/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/unravelling-mocona-preface/">[Unravelling mocona] Part 0 - Preface</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-09-12 | <span class="post__meta-categories"><a href="/categories/Series/">Series</a></span></div><div data-post-id="fe7aec480e438753767bb156fee3ec3479da23347e0584a5443644d09fb7b11e" class="post__content font__body"><p>The early idea of <a target="_blank" rel="noopener" href="https://github.com/hsfzxjy/mocona">hsfzxjy/mocona</a> was come up with in late April. It was not until July that I figure out a reasonable design for the project. I finished most of my idea and released the first version approaching August. Nevertheless, there’s no chance for me to share the story behind the library. Now another month gone, it’s time to do some writing.</p><p>The series, as I planning, would cover the motivation of creating mocona, some technical details and usage, along with some critical thinking on the creative process. For whom interested in CPython internals or would like to extend the language, it is worth to read through.</p><h2 id="table-of-contents">Table of Contents</h2><ul><li><a href="../2021-09-16-unravelling-mocona-verbosity-or-anti-pattern/">Part 1 - Verbosity or Anti-Pattern</a></li></ul></div><div lang="zh" class="post__readmore font__ui"><a href="/unravelling-mocona-preface/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/clarifying-pickle-in-python/">Understanding pickle in Python</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-08-14 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="5cb9abf17ac30519199afe9167edb72ba548765d3baef0559699d315f3b32e3c" class="post__content font__body"><p>The module <code>pickle</code> shipped in Python could be used for generic-purpose object serialization and de-serialization. It’s been widely adopted or recommended as backend in scenarios like persisting states or IPC.</p><p class="nomargin">Employed by many famous frameworks, though, the magic behind it still seems to be vague for daily users, especially guys fresh to the language. People come across “unpicklable” errors from time to time, but don’t know the reason; or re-invent state persistence by themselves, even if <code>pickle</code> could be competent. People sometimes write error-prone codes, merely because they are afraid of or unaware of <code>pickle</code>.</p><p class="nomargin">This post thus attempts to clarify the usage of <code>pickle</code> module in an easy understanding way, by answering three questions.</p></div><div lang="zh" class="post__readmore font__ui"><a href="/clarifying-pickle-in-python/">READ MORE</a></div></article><article lang="zh" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/rough-notes-on-deploying-vaultwarden-and-nextcloud-bookmarks/">Rough Notes on Deploying Vaultwarden &amp; NextCloud Bookmarks</a></h1><span class="post__lang-tag font__ui">zh</span></div><div lang="zh" class="post__meta font__ui">2021-07-26 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="d2313c1334046a0b00b2bed7a5e961c8feb74140e6616bf2d1c46a02c78fa98e" class="post__content font__body"><p>I’ve been struggling for years on two things: synchronize passwords and blog posts I have read across devices. The problem kills me so much since my devices, an Android mobile, an Ubuntu laptop and an iPad, are less supported by big App companies. Aside, I want to gain control for all my data, so there should better exist a self-hosted solution. The problem are partially solved recently by deploying <a target="_blank" rel="noopener" href="https://github.com/dani-garcia/vaultwarden/wiki/Enabling-HTTPS">Vaultwarden</a> and <a target="_blank" rel="noopener" href="https://nextcloud.com/">NextCloud</a> on VPS. This blog post dictates the setup process and problems I met, in case anyone searching for this topic.</p><h2 id="install-vaultwarden-and-nextcloud-on-vps-1">Install Vaultwarden and NextCloud on VPS</h2><p>The two services are both luckily dockerized. To install there’s nothing more complicated than a command:</p></div><div lang="zh" class="post__readmore font__ui"><a href="/rough-notes-on-deploying-vaultwarden-and-nextcloud-bookmarks/">READ MORE</a></div></article><article lang="zh" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/language-ethusiast-and-pragmatist/">语言狂热者与实用主义者</a></h1><span class="post__lang-tag font__ui">zh</span></div><div lang="zh" class="post__meta font__ui">2021-07-08 | <span class="post__meta-categories"><a href="/categories/Soliloquy/">Soliloquy</a></span></div><div data-post-id="18db0e77c8b49abff50e03601ba9ef4069e07dda4017d1cfe5c808cb08bf1e03" class="post__content font__body"><p>编程语言界有着一场旷日持久的争论。人们会为了一种（或一类）语言，或是自己熟用的，或是自己所欣赏的，与他人吵得不可开交。而争论的起点，可能只是某人一句小小的抱怨。各方各为其主，剑拔弩张，俨然一次声势浩大的圣战。</p><p>尽管众语言不可一概而论，我们还是可以粗略地将争论的人群分为两个派别：语言狂热者与实用主义者。这是光谱的两个极端。语言狂热者关注语言本身，或是钟情于新的、现代化的语言特性，并据此评判一种语言；实用主义者则侧重于语言的工程实践，常会以语言的生态、业界使用率反驳他人。当然，也不乏两者兼具的人，对双方的意见各持有一定比例。</p></div><div lang="zh" class="post__readmore font__ui"><a href="/language-ethusiast-and-pragmatist/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/where-does-the-randomness-of-cuda-kernels-come-from/">Demystify the randomness in CUDA kernels</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-06-11 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="af53ba5b2c598676418f75714303f451fb56c48169cbacba6710e9cabcb98c28" class="post__content font__body"><p>You might have heard that many CUDA operators contains some kind of non-determinism, and to eliminate the randomness, one must pay for the degradation of performance. The warning occurs many times in blog posts or framework documentation, but few of them give a detailed explanation for the source of randomness. To this end, the post is going to explore the problem.</p><p>When talked about GPU computation, one might come up with a notion of some super-fast hardwares. The surprising speed comes from intensive parallelism of the architecture, which allows users to run thousands of routines on parallel (compared to dozens on ordinary CPUs). The routines are called <strong>threads</strong>, and similar to the concept with the same name in operating systems, they suffer from <strong>non-deterministic execution order</strong> and <strong>data race condition</strong>.</p><p>Non-deterministic execution order means, if we arrange all instructions of different threads into a sequence, ordered by their occurrence time, the sequence could vary greatly across invocations. If two threads run on parallel, each with a single instruction, we cannot tell which one is executed first. This is the fundamental origin of randomness, and is inevitable.</p><p>Data race condition is one of the consequences of non-deterministic execution order. When the threads is manipulating some shared variables, and the manipulation is not <em>atomic</em>, i.e. consists of interruptible instruction sequence, the program might yield undesired results. Programs should be carefully designed to avoid race condition, with the help of locks or atomic operations. To alleviate, CUDA provides atomic arithmetic routines like <code>atomicAdd()</code> or <code>atomicMax()</code> for safe access to shared memory.</p><p>By far we have seen that there does exist some kind of randomness inside GPUs, and if not handled properly, our program will give incorrect results when working with shared variables. But one may argue that, we have atomic operations like <code>atomicAdd()</code>. If a program correctly sums up the same collection of numbers, although the order might be messed, it should always returns the same result. Sadly this is wrong, since some arithmetic operations <strong>DOES rely on the order of operands</strong>! Let’s take the following CUDA program as an example:</p></div><div lang="zh" class="post__readmore font__ui"><a href="/where-does-the-randomness-of-cuda-kernels-come-from/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/indexeddb-performant-bulk-mutations/">Performant Bulk Mutations in IndexedDB</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-05-30 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="fe25b2a3fdb4095bd624d0b4de803af1453ec20e9f81362ba73b7c97a33ea937" class="post__content font__body"><p>IndexedDB seems to be inefficient when working on bulk mutations, such as dumping a huge list of items into an object store – at least I think so at the first sight on the MDN docs. It provides no explicit API for the job as SQL does , so all we can do is to loop from client side, which cannot benefit from database internal optimization (if there’s any). The mutation requests, in addition, appear to be spawned sequentially – the tutorial recommends a paradigm to raise a request within the <code>success</code> event callback of the previous request, which is in fact a sequential execution. Such code will be definitely slow.</p><p>We may conduct a quick benchmark on the above approach:</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line">;(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">const</span> r = indexedDB.<span class="hljs-title function_">deleteDatabase</span>(<span class="hljs-string">&quot;test&quot;</span>)</span><br><span class="line">        r.<span class="hljs-property">onsuccess</span> = r.<span class="hljs-property">onerror</span> = resolve</span><br><span class="line">    })</span><br><span class="line">    <span class="hljs-keyword">const</span> items = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({ <span class="hljs-attr">id</span>: i }))</span><br><span class="line">    <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</span><br><span class="line">        indexedDB.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">1</span>).<span class="hljs-property">onupgradeneeded</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</span><br><span class="line">            <span class="hljs-keyword">const</span> db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span></span><br><span class="line">            <span class="hljs-keyword">const</span> store = db.<span class="hljs-title function_">createObjectStore</span>(<span class="hljs-string">&quot;store&quot;</span>, { <span class="hljs-attr">keyPath</span>: <span class="hljs-string">&quot;id&quot;</span> })</span><br><span class="line">            store.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;id&quot;</span>)</span><br><span class="line">            <span class="hljs-title function_">resolve</span>(store)</span><br><span class="line">        }</span><br><span class="line">    })</span><br><span class="line">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">&quot;bulkAdd&quot;</span>)</span><br><span class="line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">bulkAdd</span>(store, items)</span><br><span class="line">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">&quot;bulkAdd&quot;</span>)</span><br><span class="line">})()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">bulkAdd</span>(<span class="hljs-params">store, items</span>) {</span><br><span class="line">    <span class="hljs-keyword">const</span> failures = []</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">function</span> <span class="hljs-title function_">_perform</span>(<span class="hljs-params">idx</span>) {</span><br><span class="line">            <span class="hljs-keyword">const</span> req = store.<span class="hljs-title function_">add</span>(items[idx])</span><br><span class="line">            req.<span class="hljs-property">onsuccess</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</span><br><span class="line">                <span class="hljs-keyword">if</span> (idx === items.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) <span class="hljs-title function_">resolve</span>(failures)</span><br><span class="line">                <span class="hljs-keyword">else</span> <span class="hljs-title function_">_perform</span>(idx + <span class="hljs-number">1</span>)</span><br><span class="line">            }</span><br><span class="line">            req.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</span><br><span class="line">                failures.<span class="hljs-title function_">push</span>(items[idx].<span class="hljs-property">id</span>)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-title function_">_perform</span>(<span class="hljs-number">0</span>)</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></div></div><p class="par">Practically, we concern more about failed records than the ones inserted successfully. We thus take down only the indices of those records, which improves the efficiency at least a little bit.</p><p>The timing is rather unstable, but on average, it takes 30~40 seconds to insert 100k records or 2000~3000 records per second, which is not promising.</p></div><div lang="zh" class="post__readmore font__ui"><a href="/indexeddb-performant-bulk-mutations/">READ MORE</a></div></article></div><div lang="zh" class="page-navigator font__ui"><span class="page__button"><a href="/page/4/" class="pre">PREV</a></span><span class="page__button"><a href="/page/6/" class="next">NEXT</a></span></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon current"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item current"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>