<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><title>hsfzxjy 的博客</title><meta itemprop="title" content="hsfzxjy 的博客"><meta itemprop="og:title" content="hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/">Home</a></div></nav><main class="mainContainer"><div class="post-list"><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/indexeddb-performant-bulk-mutations/">Performant Bulk Mutations in IndexedDB</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-05-30 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="fe25b2a3fdb4095bd624d0b4de803af1453ec20e9f81362ba73b7c97a33ea937" class="post__content font__body"><p>IndexedDB seems to be inefficient when working on bulk mutations, such as dumping a huge list of items into an object store – at least I think so at the first sight on the MDN docs. It provides no explicit API for the job as SQL does , so all we can do is to loop from client side, which cannot benefit from database internal optimization (if there’s any). The mutation requests, in addition, appear to be spawned sequentially – the tutorial recommends a paradigm to raise a request within the <code>success</code> event callback of the previous request, which is in fact a sequential execution. Such code will be definitely slow.</p><p>We may conduct a quick benchmark on the above approach:</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line">;(<span class="hljs-keyword">async</span> () =&gt; {</span><br><span class="line">    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">const</span> r = indexedDB.<span class="hljs-title function_">deleteDatabase</span>(<span class="hljs-string">&quot;test&quot;</span>)</span><br><span class="line">        r.<span class="hljs-property">onsuccess</span> = r.<span class="hljs-property">onerror</span> = resolve</span><br><span class="line">    })</span><br><span class="line">    <span class="hljs-keyword">const</span> items = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({ <span class="hljs-attr">id</span>: i }))</span><br><span class="line">    <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</span><br><span class="line">        indexedDB.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-number">1</span>).<span class="hljs-property">onupgradeneeded</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</span><br><span class="line">            <span class="hljs-keyword">const</span> db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span></span><br><span class="line">            <span class="hljs-keyword">const</span> store = db.<span class="hljs-title function_">createObjectStore</span>(<span class="hljs-string">&quot;store&quot;</span>, { <span class="hljs-attr">keyPath</span>: <span class="hljs-string">&quot;id&quot;</span> })</span><br><span class="line">            store.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;id&quot;</span>)</span><br><span class="line">            <span class="hljs-title function_">resolve</span>(store)</span><br><span class="line">        }</span><br><span class="line">    })</span><br><span class="line">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">&quot;bulkAdd&quot;</span>)</span><br><span class="line">    <span class="hljs-keyword">await</span> <span class="hljs-title function_">bulkAdd</span>(store, items)</span><br><span class="line">    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">&quot;bulkAdd&quot;</span>)</span><br><span class="line">})()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">function</span> <span class="hljs-title function_">bulkAdd</span>(<span class="hljs-params">store, items</span>) {</span><br><span class="line">    <span class="hljs-keyword">const</span> failures = []</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</span><br><span class="line">        <span class="hljs-keyword">function</span> <span class="hljs-title function_">_perform</span>(<span class="hljs-params">idx</span>) {</span><br><span class="line">            <span class="hljs-keyword">const</span> req = store.<span class="hljs-title function_">add</span>(items[idx])</span><br><span class="line">            req.<span class="hljs-property">onsuccess</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</span><br><span class="line">                <span class="hljs-keyword">if</span> (idx === items.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) <span class="hljs-title function_">resolve</span>(failures)</span><br><span class="line">                <span class="hljs-keyword">else</span> <span class="hljs-title function_">_perform</span>(idx + <span class="hljs-number">1</span>)</span><br><span class="line">            }</span><br><span class="line">            req.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {</span><br><span class="line">                failures.<span class="hljs-title function_">push</span>(items[idx].<span class="hljs-property">id</span>)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="hljs-title function_">_perform</span>(<span class="hljs-number">0</span>)</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></div></div><p class="par">Practically, we concern more about failed records than the ones inserted successfully. We thus take down only the indices of those records, which improves the efficiency at least a little bit.</p><p>The timing is rather unstable, but on average, it takes 30~40 seconds to insert 100k records or 2000~3000 records per second, which is not promising.</p></div><div lang="zh" class="post__readmore font__ui"><a href="/indexeddb-performant-bulk-mutations/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/cython-auto-reload/">Auto Rebuild .pyx Files with pyximport</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-05-16 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="a5fe38c4de5c55f0f79b6f16184da1fcee284d639d73e65c436261fe9c1c838c" class="post__content font__body"><p>Modules written in Cython usually comes with a <code>setup.py</code> script that compiles Cython source codes into native shared libary. For whom not so familiar with Python’s packaging and distributing toolchains, such step is sometimes scary, and turns out to be a stumbling block for Cython freshmen. Moreover, the workflow, “run setup.py -&gt; debug -&gt; edit .pyx files -&gt; run setup.py”, is also less convenient and troublesome for fast iterating projects.</p><p><code>pyximport</code> is a handy tool from Cython official, provided to address the above problem. The module enables users to “directly import” <code>.pyx</code> files, with no explicit <code>setup.py</code> required. Let’s start from an example here. Say we have two files residing in the same directory:</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line"><span class="hljs-comment"># main.py</span></span><br><span class="line"><span class="hljs-keyword">import</span> pyximport</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># hl: begin</span></span><br><span class="line">pyximport.install(language_level=<span class="hljs-number">3</span>)</span><br><span class="line"><span class="hljs-comment"># hl: end</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> foo</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">print</span>(foo.func(<span class="hljs-number">3</span>))</span><br></pre></div></div><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line"><span class="hljs-comment"># foo.pyx</span></span><br><span class="line">cpdef <span class="hljs-built_in">int</span> sqr(<span class="hljs-built_in">int</span> x):</span><br><span class="line">    <span class="hljs-keyword">return</span> x * x</span><br></pre></div></div><p class="par">The magical <code class="_hl-label">highlighted</code> line registers some import hooks to let Python recognize <code>.pyx</code> files. When the <code>.pyx</code> files imported for the first time or modified later, <code>pyximport</code> compiles or re-compiles them behind the scene automatically.</p></div><div lang="zh" class="post__readmore font__ui"><a href="/cython-auto-reload/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/cython-and-threads/">Cython and Threads</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-05-07 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="a729f20ca8794a57ba69ce049b61e120f51255d63600792cf6ef57b2f081be62" class="post__content font__body"><p>Pure Python <em>sucks</em> in the scene of parallel computing, due to the existence of the Global Interpreter Lock (aka GIL). GIL prevents accessing or manipulating interpreter from different threads concurrently. The mechanism alleviates the risk of race condition, but sequentializes multi-threading program as well. Sadly, there’s no way to release the lock from pure Python.</p><p>Alright. So what about beyond pure Python? Shall we bypass the mechanism within an extension? The answer is yes, and that’s what most of scientific computing libaries do.</p><p>Cython is a good choice for writing extensions, less verbose, and more similar to Python syntactically. In Cython, one can release GIL temporarily for a code block using the <code>with nogil:</code> syntax. Will it release the true power of multi-core CPU? We should have a try.</p></div><div lang="zh" class="post__readmore font__ui"><a href="/cython-and-threads/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/obtain-a-random-unused-tcp-port-with-bash/">Obtain a Random Available TCP Port with Bash</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2021-03-10 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="61a4ff0a6add35a07b153395dfabd8317c95bb7c5e826892656333207dec9bad" class="post__content font__body"><p>On Linux, we might sometimes want to choose an unused TCP port randomly. This occurs from time to time on a server, when the administrator wants to expose an HTTP port for a user. Or, you just need an available port for IPC. Let’s make it happen with pure bash scripting.</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">unused_port</span></span>() {</span><br><span class="line">    N=<span class="hljs-variable">${1:-1}</span></span><br><span class="line">    <span class="hljs-built_in">comm</span> -23 \</span><br><span class="line">        &lt;(<span class="hljs-built_in">seq</span> <span class="hljs-string">&quot;1025&quot;</span> <span class="hljs-string">&quot;65535&quot;</span> | <span class="hljs-built_in">sort</span>) \</span><br><span class="line">        &lt;(ss -Htan |</span><br><span class="line">            awk <span class="hljs-string">&#x27;{print $4}&#x27;</span> |</span><br><span class="line">            <span class="hljs-built_in">cut</span> -d<span class="hljs-string">&#x27;:&#x27;</span> -f2 |</span><br><span class="line">            <span class="hljs-built_in">sort</span> -u) |</span><br><span class="line">        <span class="hljs-built_in">shuf</span> |</span><br><span class="line">        <span class="hljs-built_in">head</span> -n <span class="hljs-string">&quot;<span class="hljs-variable">$N</span>&quot;</span></span><br><span class="line">}</span><br></pre></div></div><p class="par">We would take apart the function step by step in the following paragraphs.</p></div><div lang="zh" class="post__readmore font__ui"><a href="/obtain-a-random-unused-tcp-port-with-bash/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/information-theory-kl-divergence/">Information Theory: KL Divergence</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2020-01-15 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="a8f0f56dc4367b07c7485d47d768bf9f9b8ec557b02ab7148e2a920e1b7dd921" class="post__content font__body"><p>Assume there are two hypotheses $H_1$ and $H_2$, r.v. $X$ ranged in alphabets $\{a_1,\ldots\,a_k\}$. Under hypothesis $H_i$, $X$ has pdf $p(X=a_j|H_i)=p_i(a_j)$. According to Law of Total Probability, we have:</p><p>$$ p(H_i|a_k) = \frac{p(H_i)p_i(a_k)}{p_1(a_k)p(H_1)+p_2(a_k)p(H_2)} $$</p><p class="par">The formula can be transformed into:</p><p>$$ \log \frac{p_2(a_k)}{p_1(a_k)} = \log \frac{p(H_2|a_k)}{p(H_1|a_k)} - \log \frac{p(H_2)}{p(H_1)} $$</p><p class="par">which implies that, $\log \frac{p_2(a_k)}{p_1(a_k)}$ equals the difference of log likelihood ratio before and after conditioning $X=a_k$. We define $\log \frac{p_2(a_k)}{p_1(a_k)}$ be the discrimination information for $H_2$ over $H_1$, when $X=a_k$. The expectation of discrimination information is KL divergence, denoted as:</p><p>$$D_{KL}(P_2||P_1) = \sum_k p_2(a_k) \log \frac{p_2(a_k)}{p_1(a_k)} $$</p><p class="par">which sometimes denoted as $I(p2,p1;X)$, or simply $I(p2,p1)$ if without ambiguity.</p><p>KL Divergence can be interpreted as a measure of expected information for $X$ gained after distribution shifted from $p_1$ to $p_2$, where $p_1$ and $p_2$ regarded as prior and post-prior distributions.</p></div><div lang="zh" class="post__readmore font__ui"><a href="/information-theory-kl-divergence/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/information-theory-entropy-and-mutual-information/">Information Theory: Entropy and Mutual Information</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2020-01-04 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="19b7471d880baa6bfdae585f620e85b1a8d50a66b8a6cac9d3fa0279b8d73e93" class="post__content font__body"><p>Given a discrete r.v. $X$, where $X$ ranged in $\{a_1, \ldots, a_n\}$, $\mathbb{P}(X=a_k)=p_k$. Entropy $H(X)$ is defined as:</p><p>$$H(X)= - \sum_k p_k \log p_k$$</p><p class="par">When regarded as a function of $\{p_k\}$, entropy satisfies the following properties:</p><ol><li>$H(p_1,\ldots,p_n)$ is continuous, and non-negative;</li><li>$H(p_1,\ldots,p_n)$ is convex w.r.t. $(p_1,\ldots,p_n)$;</li><li>$H(p_1,\ldots,p_n)$ has a unique maxima $(\frac{1}{n},\ldots,\frac{1}{n})$;</li><li>$H(n):=H(\frac{1}{n},\ldots,\frac{1}{n})$ increases along with $n$;</li><li>$H(p_1,\ldots,p_n)=H(p_1+\ldots+p_k,p_{k+1},\ldots,p_n)+(p_1+\ldots+p_k)H(p_{k+1}&#39;,\ldots,p_n&#39;)$.</li></ol><p class="par">Property 5 is so-called addictivity. That is, if we observe $X$ in two steps, firstly obtaining a value from $\{\hat{a},a_{k+1},\ldots,a_n\}$ and then another value from $\{a_1,\ldots,a_k\}$ if $\hat{a}$ selected, the entropy of the whole system should be sum of these two subsystems.</p><p class="nomargin">Note that a function satisfying property 1, 4, 5 must have a form of $H(\vec{p})= - C \sum_k p_k \log p_k$, which reveals that entropy function is unique.</p><p>Entropy measures the <strong>uncertainty</strong> of a random value. Intuitively, entropy reaches its maximum $\log n$ when all alphabets occur with same probability, and likewise has a minimum of $0$ if $p_k=1$ for some $k$.</p><p>Entropy also represents the smallest average length to encode a message. Say we have a message consisting of alphabets $a_1,\ldots,a_n$, occurring with probability $p_1,\ldots,p_n$. Now we want to assign a code (an $N$-ary string) to each alphabet, with no two codes sharing a same prefix. The length of the codes are denoted as $l_1,\ldots,l_n$. <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Shannon%27s_source_coding_theorem">Shannon’s source coding theroem</a> states that the average code length $\sum_k p_k l_k$ could not be less than $H(p_1,\ldots,p_n)$ (taking $N$ as logarithm base).</p></div><div lang="zh" class="post__readmore font__ui"><a href="/information-theory-entropy-and-mutual-information/">READ MORE</a></div></article><article lang="zh" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/yakimono/">铁板烧</a></h1><span class="post__lang-tag font__ui">zh</span></div><div lang="zh" class="post__meta font__ui">2019-12-10 | <span class="post__meta-categories"><a href="/categories/Life/">Life</a></span></div><div data-post-id="37548b1038157a09b939af4dcfc8164c011430ddcc8f3ecbadffe5682b07c1b8" class="post__content font__body"><p>最近喜欢上了那家铁板烧。在寸土寸金的北京，那家店占据了食街不大的一角。开放式的厨房几乎就是它的全部。一圈细长的大理石柜台，被椅子围得严严实实。人们就此坐下，点菜，颇有一番日式的味道。隔着不高的玻璃，可以看到三个大厨在柜台另一边忙碌。食材触到铁板的「吱」响，伴随时不时的爆裂声，白色的烟汽袅起，混合着诱人的香味，好不热闹。</p><p>入冬后，食街上的人更多了。日落后，室外温度急剧下降，这时来热闹的地方吃点热热的东西，再合适不过了。独自点上一份肉，一份菜，一碟满满的炒饭，吃得满面油光，奢侈而满足。推门而出，白天发生的不愉快，或是接下来要加班的怠惰，多少缓解了一些。但每次吃完，衣服上，头发上总会带上一股味道——铁板烧的味道，油烟的味道。</p><p>有人不在乎这味道，觉得这是烟火味，是相关料理的灵魂，是生活的气息。在以前，我是很痛恨这种说法的。吃火锅，或是烧烤时，高温食材逸散出的分子，几乎无孔不入，附在衣服上、头发上，就像被泼了一身油。每一回都要努力地洗澡，再将衣服由里至外换一遍，方可除去这种味道。我不能忍受这样的味道，藉而讨厌相关的料理。但近几年，这种想法似乎在慢慢消失，我开始能接受这种味道。尽管还是接受不了烧烤，但这种铁板烧倒是可以，甚至慢慢喜欢上了。</p><p>讨厌烟火味，和睡前一定要洗澡一样，这些观念的背后似乎有着奇妙的机理。人们小时候的经历，或是大人的说教，或是自身的负面遭遇，仿佛在主导这些观念。怕小鸡的以前踩死过小鸡，不敢吃鱼的是被鱼刺卡过。但我的这个观念好像是自发产生的，没有听从任何人表达过这样的观点，而是打心底里就讨厌这种味道。</p><p>如此根深蒂固的观念，又是如何被改变的呢？大概是太忙碌，忙得无暇顾及这类事。烟汽熏天的铁板烧，是我不可多得的闲暇时光。生活于生存之上，生存尚不能满足，又谈何更高层次的吹毛求疵？</p><p>一个习惯的改变，或者是一种生活方式的丧失。</p></div><div lang="zh" class="post__readmore font__ui"><a href="/yakimono/">READ MORE</a></div></article><article lang="zh" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/xjx/">西郊线</a></h1><span class="post__lang-tag font__ui">zh</span></div><div lang="zh" class="post__meta font__ui">2019-10-03 | <span class="post__meta-categories"><a href="/categories/Life/">Life</a></span></div><div data-post-id="452d8fc0de2b7dfaa674633e876b16d67b49013be6e1aa85b8f5cb28dd55fb6c" class="post__content font__body"><p>西郊线真的是电车，那种拖着两个辫子，走得不快的电车。沿途的车站也是很小的车站。不到两米宽的站台，甚至比广州的 BRT 站更窄一些，立了一排凳子，仅此而已。半露天的车站，有遮雨棚，却没有真正意义的墙。透过一人多高的玻璃看，站台外沿长满了狗尾巴草，再往后铺开了大片的草甸和桦林，一直延伸到远处的香山，和仿佛水洗后的天空。午前的秋阳给眼前的一切都染上了愉悦的暖色。</p></div><div lang="zh" class="post__readmore font__ui"><a href="/xjx/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/proof-of-gumbel-max-trick/">Proof of the Gumbel Max Trick</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2019-08-01 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="f3c989e3e00908baa34ab3d83871aa38754e7e0d10ad926d25ee0b4866ac42b7" class="post__content font__body"><h2 id="statement">Statement</h2><p class="noindent">Assume that $\alpha_1, \alpha_2, \ldots, \alpha_n$ satisify $\sum_k\alpha_k=1$. Define</p><p>$$Z=\arg\max_k\{\log\alpha_k+G_k\}$$</p><p class="par">where $G_1,\ldots,G_n \text{ i.i.d.}\sim Gumbel(0,1)$, whose PDF and CDF are defined as</p><p>$$\begin{align} f(x)&amp;=e^{-(x+e^{-x})} \\ F(x)&amp;=e^{-e^{-x}}\end{align}$$</p><p class="par">. Then $\mathbb{P}(Z=k)=\alpha_k$.</p><h2 id="proof">Proof</h2><p class="par">Set $u_k=\log{\alpha_k}+G_k$. We prove by direct calculations.</p><p>$$\begin{align} \mathbb{P}(Z=k)&amp;=\mathbb{P}(u_k \geq u_j,\forall j \neq k) \\ &amp;=\int_{-\infty}^\infty \mathbb{P}(u_k \geq u_j, \forall j \neq k|u_k)\mathbb{P}(u_k) du_k \\ &amp;=\int_{-\infty}^\infty \prod_{j\neq k}\mathbb{P}(u_k \geq u_j|u_k)\mathbb{P}(u_k) du_k \\ &amp;=\int_{-\infty}^\infty \prod_{j\neq k}e^{-e^{-u_k+\log \alpha_j}} e^{-(u_k-\log\alpha_k+e^{-(u_k-\log\alpha_k)})} du_k \\ &amp;=\int_{-\infty}^\infty e^{-\sum_{j\neq k}\alpha_je^{-u_k}} \alpha_k e^{-(u_k+\alpha_k e^{-u_k})} du_k \\ &amp;=\alpha_k \int_{-\infty}^\infty e^{-u_k-(\alpha_k+\sum_{j\neq k}\alpha_j)e^{-u_k}} du_k \\ &amp;= \alpha_k \end{align}$$.</p><h2 id="application">Application</h2><p class="par">The trick is commonly used in DL to make sampling over a discrete distribution differentiable.</p><h2 id="references-4">References</h2><ul><li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Gumbel_distribution">Gumbel Distribution - Wikipedia</a></li><li><a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1611.01144.pdf">Categorical Reparameterization with Gumbel-Softmax (ICLR 2017)</a></li></ul></div><div lang="zh" class="post__readmore font__ui"><a href="/proof-of-gumbel-max-trick/">READ MORE</a></div></article><article lang="en" class="post"><div class="post__title-block"><h1 class="post__title"><a href="/option-as_ref/">Option::as_ref</a></h1><span class="post__lang-tag font__ui">en</span></div><div lang="zh" class="post__meta font__ui">2019-06-26 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div data-post-id="f9352571bd44ad92341db0a6cb40fe9b6e884ec413bbd7f20bc715499ef50c29" class="post__content font__body"><p>Let’s consider the following function:</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">use</span> std::ptr::NonNull;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">transform</span>&lt;T&gt;(option: &amp;<span class="hljs-type">Option</span>&lt;NonNull&lt;T&gt;&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Option</span>&lt;&amp;T&gt; {</span><br><span class="line">    option.<span class="hljs-title function_ invoke__">map</span>(|x| <span class="hljs-keyword">unsafe</span> { x.<span class="hljs-title function_ invoke__">as_ref</span>() })</span><br><span class="line">}</span><br></pre></div></div><p class="par">The function <code>transform</code> takes an <code>Option&lt;NonNull&lt;T&gt;&gt;</code> as input, and converts the inner pointer to an immutable reference <code>&amp;T</code> if possible. The method <code>NonNull::as_ref()</code> is marked unsafe so we need an <code>unsafe</code> block. The snippet causes an compilation error:</p></div><div lang="zh" class="post__readmore font__ui"><a href="/option-as_ref/">READ MORE</a></div></article></div><div lang="zh" class="page-navigator font__ui"><span class="page__button"><a href="/page/5/" class="pre">PREV</a></span><span class="page__button"><a href="/page/7/" class="next">NEXT</a></span></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon current"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item current"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>