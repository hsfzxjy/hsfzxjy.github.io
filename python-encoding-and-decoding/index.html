<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><title>Python“黑魔法”之 Encoding &amp; Decoding</title><meta itemprop="title" content="Python“黑魔法”之 Encoding &amp; Decoding - hsfzxjy 的博客"><meta itemprop="og:title" content="Python“黑魔法”之 Encoding &amp; Decoding - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="写在前面


本文为科普文
本文中的例子在 Ubuntu 14.04 / Python 2.7.11 下运行成功，..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="zh" class="post post-page"><h1 lang="zh" class="post__title">Python“黑魔法”之 Encoding &amp; Decoding</h1><div class="post__meta font__ui">2016-07-21 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body noindent"><h2 id="写在前面-2">写在前面</h2><blockquote><ul><li>本文为科普文</li><li>本文中的例子在 Ubuntu 14.04 / Python 2.7.11 下运行成功，Python 3+ 的接口有些许不同，需要读者自行转换</li></ul></blockquote><h2 id="引子-3">引子</h2><p>先看一段代码：</p><p><code>example.py</code>：</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line"># -*- conding=yi -*-</span><br><span class="line"></span><br><span class="line">从 math 导入 sin, pi</span><br><span class="line"></span><br><span class="line">打印 &#x27;sin(pi) =&#x27;, sin(pi)</span><br></pre></div></div><p>这是什么？！是 Python 吗？可以运行吗？——想必你会问。</p><p>我可以明确告诉你：这不是 Python，<strong>但它可以用 Python 解释器运行</strong>。当然，如果你愿意，可以叫它“Yython” （易语言 + Python）。</p><p><img loading="lazy" src="//sf.gg/img/bVzuHw" alt=""></p><p>怎么做到的？也许你已经注意到第一行的奇怪注释——没错，秘密全在这里。</p><p>这种黑魔法，还要从 <a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0263/">PEP 263</a> 说起。</p><h2 id="古老的-pep-263">古老的 PEP 263</h2><p>我相信 99% 的中国 Python 开发者都曾经为一个问题而头疼——字符编码。那是每个初学者的梦靥。</p><p>还记得那天吗？当你试图用代码向它示好：</p><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line"><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;你好&#x27;</span></span><br></pre></div></div><p>它却给你当头一棒：</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line">SyntaxError: Non-ASCII character &#x27;\xe4&#x27; in file chi.py on line 1, but no enconding declared</span><br></pre></div></div><p>【一脸懵逼】</p><p>于是，你上网查找解决方案。很快，你便有了答案：</p><div class="gk-code hljs" data-gk-id="BLOCK4"><div class="gk-code-display"><pre><span class="line"><span class="hljs-comment"># -*- conding=utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">print</span> <span class="hljs-string">&#x27;你好&#x27;</span></span><br></pre></div></div><p>其中第一行的注释用于指定解析该文件的编码。</p><p>这个特新来自 2001 年的 <a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0263/">PEP 263 – Defining Python Source Code Encondings</a>，它的出现是为了解决一个反响广泛的问题：</p><blockquote><p>In Python 2.1, Unicode literals can only be written using the</p></blockquote><div class="gk-code hljs" data-gk-id="BLOCK5"><div class="gk-code-display"><pre><span class="line">Latin-1 based enconding &quot;unicode-escape&quot;. This makes the</span><br><span class="line">programming environment rather unfriendly to Python users who live</span><br><span class="line">and work in non-Latin-1 locales such as many of the Asian</span><br><span class="line">countries. Programmers can write their 8-bit strings using the</span><br><span class="line">favorite enconding, but are bound to the &quot;unicode-escape&quot; enconding</span><br><span class="line">for Unicode literals.</span><br></pre></div></div><p>Python 默认用 ASCII 编码解析文件，给 15 年前的非英文世界开发者造成了不小的困扰——看来 Guido 老爹有些个人主义，设计时只考虑到了英文世界。</p><p>提案者设想：<strong>使用一种特殊的文件首注释，用于指定代码的编码</strong>。这个注释的正则原型是这样的：</p><div class="gk-code hljs" data-gk-id="BLOCK6"><div class="gk-code-display"><pre><span class="line">^[ \t\v]*#.*?conding[:=][ \t]*([-_.a-zA-Z0-9]+)</span><br></pre></div></div><p>也就是说 <code># -*- conding=utf-8 -*-</code> 并不是唯一的写法，只是 Emacs 推荐写法而已。诸如 <code># conding=utf-8</code>、<code># enconding: utf-8</code> 都是合法的——因此你不必惊讶于他人编码声明与你不同。</p><p>正则的捕获组 <code>([-_.a-zA-Z0-9]+)</code> 将会被用作查找编码的名称，查找到的编码信息会被用于解码文件。也就是说，<code>import example</code> 背后其实相当于有如下转换过程：</p><div class="gk-code hljs" data-gk-id="BLOCK7"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;example.py&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">    content = f.read()</span><br><span class="line">    enconding = extract_enconding_info(content) <span class="hljs-comment"># 解析首注释</span></span><br><span class="line">    <span class="hljs-built_in">exec</span>(content.decode(enconding))</span><br></pre></div></div><p>问题其实又回到我们常用的 <code>str.encode</code> 和 <code>str.decode</code> 上来了。</p><p>可 Python 怎么这么强大？！几乎所有编码它都认得！这是怎么做到的？是标准库？还是内置于解释器中？</p><p>一切，都是 <code>codecs</code> 模块在起作用。</p><h2 id="codecs">codecs</h2><p><code>codecs</code> 算是较为冷门的一个模块，更为常用的是 <code>str</code> 的 <code>encode</code>/<code>decode</code> 的方法——但它们本质都是对 <code>codecs</code> 的调用。</p><p>打开 <code>/path/to/your/python/lib/encondings/</code> 目录，你会发现有许多以编码名称命名的 <code>.py</code> 文件，如 <code>utf_8.py</code>、<code>latin_1.py</code>。这些都是系统预定义的编码系统，实现了应对各种编码的逻辑——也就是说：编码系统其实也是普通的模块。</p><p>除了内置的编码，用户也可以 <strong>自行定义编码系统</strong>。<code>codecs</code> 暴露了一个 <code>register</code> 函数，用于注册自定义编码。<code>register</code> 签名如下：</p><blockquote><p><strong>codecs.register(search_function)</strong> Register a codec search function. Search functions are expected to take one argument, the enconding name in all lower case letters, and return a CodecInfo object having the following attributes:</p></blockquote><ul><li>name: The name of the enconding;</li><li>encode: The stateless enconding function;</li><li>decode: The stateless deconding function;</li><li>incrementalencoder: An incremental encoder class or factory function;</li><li>incrementaldecoder: An incremental decoder class or factory function;</li><li>streamwriter: A stream writer class or factory function;</li><li>streamreader: A stream reader class or factory function.</li></ul><p><code>encode</code> 和 <code>decode</code> 是无状态的编码/解码的函数，简单说就是：前一个被编解码的字符串与后一个没有关联。如果你想用 <code>codecs</code> 系统进行语法树解析，解析逻辑最好不要写在这里，因为代码的连续性无法被保证；<code>incremental*</code> 则是有状态的解析类，能弥补 <code>encode</code>、<code>decode</code> 的不足；<code>stream*</code> 是流相关的解析类，行为通常与 <code>encode</code>/<code>decode</code> 相同。</p><p>关于这六个对象的具体写法，可以参考 <code>/path/to/your/python/lib/encondings/rot_13.py</code>，该文件实现了一个简单的密码系统。</p><p>那么，是时候揭开真相了。</p><h2 id="所谓的yython">所谓的“Yython”</h2><p>黑魔法其实并不神秘，照猫画虎定义好相应的接口即可。作为例子，这里只处理用到的关键字：</p><p><code>yi.py</code>：</p><div class="gk-code hljs" data-gk-id="BLOCK8"><div class="gk-code-display"><pre><span class="line"><span class="hljs-comment"># enconding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line">yi_map = {</span><br><span class="line">    <span class="hljs-string">u&#x27;从&#x27;</span>: <span class="hljs-string">&#x27;from&#x27;</span>,</span><br><span class="line">    <span class="hljs-string">u&#x27;导入&#x27;</span>: <span class="hljs-string">&#x27;import&#x27;</span>,</span><br><span class="line">    <span class="hljs-string">u&#x27;打印&#x27;</span>: <span class="hljs-string">&#x27;print&#x27;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params"><span class="hljs-built_in">input</span></span>):</span><br><span class="line">    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> yi_map.items():</span><br><span class="line">        <span class="hljs-built_in">input</span> = <span class="hljs-built_in">input</span>.replace(value, key)</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">input</span>.encode(<span class="hljs-string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params"><span class="hljs-built_in">input</span></span>):</span><br><span class="line">    <span class="hljs-built_in">input</span> = <span class="hljs-built_in">input</span>.decode(<span class="hljs-string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> yi_map.items():</span><br><span class="line">        <span class="hljs-built_in">input</span> = <span class="hljs-built_in">input</span>.replace(key, value)</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">input</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Codec</span>(codecs.Codec):</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>, errors=<span class="hljs-string">&quot;strict&quot;</span></span>):</span><br><span class="line">        <span class="hljs-built_in">input</span> = encode(<span class="hljs-built_in">input</span>)</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">input</span>, <span class="hljs-built_in">len</span>(<span class="hljs-built_in">input</span>))</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>, errors=<span class="hljs-string">&quot;strict&quot;</span></span>):</span><br><span class="line">        <span class="hljs-built_in">input</span> = decode(<span class="hljs-built_in">input</span>)</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">input</span>, <span class="hljs-built_in">len</span>(<span class="hljs-built_in">input</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IncrementalEncoder</span>(codecs.IncrementalEncoder):</span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>, final=<span class="hljs-literal">False</span></span>):</span><br><span class="line">        <span class="hljs-keyword">return</span> encode(<span class="hljs-built_in">input</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IncrementalDecoder</span>(codecs.IncrementalDecoder):</span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span>, final=<span class="hljs-literal">False</span></span>):</span><br><span class="line">        <span class="hljs-keyword">return</span> decode(<span class="hljs-built_in">input</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamWriter</span>(Codec, codecs.StreamWriter):</span><br><span class="line">    <span class="hljs-keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamReader</span>(Codec, codecs.StreamReader):</span><br><span class="line">    <span class="hljs-keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">def</span> <span class="hljs-title function_">register_entry</span>(<span class="hljs-params">enconding</span>):</span><br><span class="line">    <span class="hljs-keyword">return</span> codecs.CodecInfo(</span><br><span class="line">        name=<span class="hljs-string">&#x27;yi&#x27;</span>,</span><br><span class="line">        encode=Codec().encode,</span><br><span class="line">        decode=Codec().decode,</span><br><span class="line">        incrementalencoder=IncrementalEncoder,</span><br><span class="line">        incrementaldecoder=IncrementalDecoder,</span><br><span class="line">        streamwriter=StreamWriter,</span><br><span class="line">        streamreader=StreamReader</span><br><span class="line">    ) <span class="hljs-keyword">if</span> enconding == <span class="hljs-string">&#x27;yi&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span></span><br></pre></div></div><p>在命令行里注册一下，就可以看到激动人心的结果了：</p><div class="gk-code hljs" data-gk-id="BLOCK9"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> codecs, yi</span><br><span class="line"><span class="hljs-meta">&gt;&gt;&gt; </span>codecs.register(yi.register_entry)</span><br><span class="line"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">import</span> example</span><br><span class="line">sin(pi) = <span class="hljs-number">1.22464679915e-16</span></span><br></pre></div></div><h2 id="结语-1">结语</h2><p>有时，对习以为常的东西深入了解一下，说不定会有惊人的发现。</p><h2 id="references-1">References</h2><ul><li><a target="_blank" rel="noopener" href="https://docs.python.org/2.7/library/codecs.html">codecs - Codec registry and base classes</a></li></ul><br><blockquote><p class="cc">作者：hsfzxjy<br>链接：<span class="cc-link"></span><br>许可：<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>著作权归作者所有。本文<b>不允许</b>被用作商业用途，非商业转载请注明出处。</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/Python/">Python</a></div><div class="post-nav"><a href="/recursively-calling-when-decorating-a-python-class/" class="pre">«神坑·Python 装饰类无限递归</a><a href="/alternative-key-maps-under-ubuntu/" class="next">Ubuntu 重新映射键盘布局»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="python-encoding-and-decoding/",disqus_title="Python“黑魔法”之 Encoding &amp; Decoding",disqus_url="https://i.hsfzxjy.site/python-encoding-and-decoding/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"><div id="toc" lang="zh" class="font__body"><div class="toc-toggler"></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2-2"><span class="toc-number">1.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%AD%90-3"><span class="toc-number">2.</span> <span class="toc-text">引子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%A4%E8%80%81%E7%9A%84-pep-263"><span class="toc-number">3.</span> <span class="toc-text">古老的 PEP 263</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#codecs"><span class="toc-number">4.</span> <span class="toc-text">codecs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%80%E8%B0%93%E7%9A%84yython"><span class="toc-number">5.</span> <span class="toc-text">所谓的“Yython”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD-1"><span class="toc-number">6.</span> <span class="toc-text">结语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#references-1"><span class="toc-number">7.</span> <span class="toc-text">References</span></a></li></ol></div></div></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>