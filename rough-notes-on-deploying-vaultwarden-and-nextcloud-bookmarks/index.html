<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script>(()=>{let e="/cnfonts.js?rDuukLHQ",t=document,n=navigator.serviceWorker,r=!1;var a;(r=n&&(n.register(e,{scope:"/"}).then(e=>e.update()),a=n.controller)&&a.scriptURL.endsWith(e)&&"activated"===a.state?!0:r)?((a=t.createElement("link")).rel="stylesheet",a.href="/fontchan/rDuukLHQ.css",a.blocking="render",t.head.appendChild(a)):((a=t.createElement("script")).src=e,a.onload=()=>$fontchan.injectCss(),t.head.appendChild(a))})()</script><title>Rough Notes on Deploying Vaultwarden &amp; NextCloud Bookmarks</title><meta itemprop="title" content="Rough Notes on Deploying Vaultwarden &amp; NextCloud Bookmarks - hsfzxjy 的博客"><meta itemprop="og:title" content="Rough Notes on Deploying Vaultwarden &amp; NextCloud Bookmarks - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="I’ve been struggling for years on two things: synchronize..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">Rough Notes on Deploying Vaultwarden &amp; NextCloud Bookmarks</h1><div class="post__meta font__ui">2021-07-26 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body"><p>I’ve been struggling for years on two things: synchronize passwords and blog posts I have read across devices. The problem kills me so much since my devices, an Android mobile, an Ubuntu laptop and an iPad, are less supported by big App companies. Aside, I want to gain control for all my data, so there should better exist a self-hosted solution. The problem are partially solved recently by deploying <a target="_blank" rel="noopener" href="https://github.com/dani-garcia/vaultwarden/wiki/Enabling-HTTPS">Vaultwarden</a> and <a target="_blank" rel="noopener" href="https://nextcloud.com/">NextCloud</a> on VPS. This blog post dictates the setup process and problems I met, in case anyone searching for this topic.</p><h2 id="install-vaultwarden-and-nextcloud-on-vps">Install Vaultwarden and NextCloud on VPS</h2><p>The two services are both luckily dockerized. To install there’s nothing more complicated than a command:</p><div class="gk-code hljs" data-gk-id="BLOCK1"><div class="gk-code-display"><pre><span class="line"><span class="hljs-built_in">mkdir</span> vaultwarden &amp;&amp; <span class="hljs-built_in">cd</span> vaultwarden</span><br><span class="line"><span class="hljs-built_in">mkdir</span> data</span><br><span class="line">docker run -d --name vaultwarden \</span><br><span class="line">    -v <span class="hljs-variable">$HOME</span>/vaultwarden/data/:/data/ \</span><br><span class="line">    -p 29999:80 vaultwarden/server:latest</span><br></pre></div></div><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line"><span class="hljs-built_in">mkdir</span> nc &amp;&amp; <span class="hljs-built_in">cd</span> nc</span><br><span class="line"><span class="hljs-built_in">mkdir</span> data</span><br><span class="line">docker run -d --name nextcloud \</span><br><span class="line">    -v <span class="hljs-variable">$HOME</span>/nc/data:/var/www/html \</span><br><span class="line">    -p 14514:80 nextcloud</span><br></pre></div></div><p class="par">External mounted volumes here are for persisting service data inside containers. The folders should be back-up periodically, in case for potential data loss.</p><h2 id="enable-https-for-both-services">Enable HTTPS for Both Services</h2><p><a target="_blank" rel="noopener" href="https://github.com/dani-garcia/vaultwarden/wiki/Enabling-HTTPS">Several options</a> exist to enable HTTPS for the sites. I pick the one that hides both services behind an nginx, which deals with SSL connection from clients and bypasses the content to the containers. This setup would require an nginx config like:</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line"><span class="hljs-section">server</span> {</span><br><span class="line">    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;</span><br><span class="line">    <span class="hljs-attribute">server_name</span> nc.hsfzxjy.site;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-section">location</span> / {</span><br><span class="line">        <span class="hljs-attribute">proxy_pass</span> http://localhost:14514;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-section">server</span> {</span><br><span class="line">    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;</span><br><span class="line">    <span class="hljs-attribute">server_name</span> v.hsfzxjy.site;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-section">location</span> / {</span><br><span class="line">        <span class="hljs-attribute">proxy_pass</span> http://localhost:29999;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></div></div><p class="par">With configs ready, we use <code>certbot</code> to issue certificates for them.</p><h3 id="certbot">certbot</h3><p><a target="_blank" rel="noopener" href="https://certbot.eff.org/">certbot</a> is a CLI tool from <a target="_blank" rel="noopener" href="https://letsencrypt.org/getting-started/">Let’s Encrypt</a>, easing the effort to setup an HTTPS-enabled site. Install <code>certbot</code> on Ubuntu for nginx following <a target="_blank" rel="noopener" href="https://certbot.eff.org/lets-encrypt/ubuntufocal-nginx">the instruction</a></p><div class="gk-code hljs" data-gk-id="BLOCK4"><div class="gk-code-display"><pre><span class="line">sudo snap install core; sudo snap refresh core</span><br><span class="line">sudo snap install --classic certbot</span><br><span class="line">sudo <span class="hljs-built_in">ln</span> -s /snap/bin/certbot /usr/bin/certbot</span><br><span class="line">sudo certbot --nginx</span><br><span class="line"><span class="hljs-comment"># select the domain names to issue in the interactive interface</span></span><br></pre></div></div><p class="par">Note that the issuer server is banned by GFW, and you might need a proxy to get it passed. <code>certbot</code> also edits nginx config files automatically to enable the certificates, so all you need to do is to reload the nginx service.</p><h3 id="update-config-for-nextcloud">Update Config for NextCloud</h3><p>NextCloud needs re-configuration to support the nginx proxying. Edit file <code>~/nc/data/config/config.php</code> and add the following lines</p><div class="gk-code hljs" data-gk-id="BLOCK5"><div class="gk-code-display"><pre><span class="line"><span class="hljs-variable">$CONFIG</span> = <span class="hljs-keyword">array</span>(</span><br><span class="line">  <span class="hljs-string">&#x27;overwriteprotocol&#x27;</span> =&gt; <span class="hljs-string">&#x27;https&#x27;</span>,</span><br><span class="line">  <span class="hljs-string">&#x27;overwrite.cli.url&#x27;</span> =&gt; <span class="hljs-string">&#x27;https://nc.hsfzxjy.site&#x27;</span>,</span><br><span class="line">  <span class="hljs-string">&#x27;overwritehost&#x27;</span> =&gt; <span class="hljs-string">&#x27;nc.hsfzxjy.site&#x27;</span>,</span><br><span class="line">  <span class="hljs-string">&#x27;trusted_domains&#x27;</span> =&gt;</span><br><span class="line">  <span class="hljs-keyword">array</span> (</span><br><span class="line">    <span class="hljs-number">0</span> =&gt; <span class="hljs-string">&#x27;nc.hsfzxjy.site&#x27;</span>,</span><br><span class="line">  ),</span><br><span class="line"></span><br><span class="line">);</span><br></pre></div></div><p class="par">The snippet is necessary, since otherwise the clients will stuck on “Grant Access”. See <a target="_blank" rel="noopener" href="https://help.nextcloud.com/t/macos-and-ios-clients-stuck-in-grant-access-loop/52279/3">this thread</a> for a full discussion.</p><h2 id="install-bookmarks-app-on-nextcloud">Install Bookmarks App on NextCloud</h2><p>Bookmarks synchronization is powered by the NextCloud app “Bookmarks”. Download it from <a target="_blank" rel="noopener" href="https://apps.nextcloud.com/apps/bookmarks">here</a> and extract under <code>~/nc/data/apps/</code> to install. After which, enable the app in NextCloud settings from web interface.</p><h2 id="clients">Clients</h2><h3 id="laptop">Laptop</h3><p>Since most of my daily work is accomplished in web browsers on laptop, I choose Chrome extensions as clients. Luckily, both services provide chrome extensions, with <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/nngceckbapebfimnlniiiahkandclblb">Bitwarden</a> for Vaultwarden and <a target="_blank" rel="noopener" href="https://chrome.google.com/webstore/detail/floccus-bookmarks-sync/fnaicdffflnofjppbagibeoednhnbjhg">floccus</a> for NextCloud Bookmarks.</p><h3 id="mobile">Mobile</h3><p>I use the apps “Bitwarden” (com.x8bit.bitwarden) and “Bookmarks” (de.emasty.bookmarks) for Android, both of which can be downloaded from Google Play Store.</p><p>For Bitwarden, turn on “Auto Filling services” in its settings to enable password auto-filling. If you are using MIUI, enable the application priviledge「后台弹出界面」to allow pop-up on clicking the drop-down box.</p><h2 id="auto-backup-service-data">Auto-Backup Service Data</h2><p>Since my VPS is hosted on Tencent Cloud, <a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/cos">Tencent COS</a> would be a good choice for data backup storage. The platform would not charge your network fees if VPS and COS bucket are within the same region. All you need to pay is merely the storage cost.</p><p>A back-up service can be simply set up with CRON service and a bash script:</p><div class="gk-code hljs" data-gk-id="BLOCK6"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">sudo python3 -m pip install coscmd</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">cd</span> /home/ubuntu</span><br><span class="line">tar czvf /tmp/services.tgz nc/ vaultwarden/</span><br><span class="line">coscmd -c /home/ubuntu/tools/cosconfig upload /tmp/services.tgz services.tgz</span><br></pre></div></div><p class="par">Place the script at <code>/etc/cron.hourly/backup-services</code> to enable it. You would also need to create a file named <code>cosconfig</code> following <a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/436/10976#.E7.94.9F.E6.88.90.E9.85.8D.E7.BD.AE.E6.96.87.E4.BB.B6">the doc</a> for bucket configuration. Afterwards the backup service should be invoked per hour.</p><blockquote><p>Initially I’ve encountered a strange problem that CRON would not run the script. The crux is I have named it <code>backup-services.sh</code>, but CRON does not accept a file name with dot <code>.</code> inside. Check <a target="_blank" rel="noopener" href="https://askubuntu.com/questions/8426/cron-hourly-wont-run/508307#508307">this answer</a> for details.</p></blockquote><h2 id="problems-remained">Problems Remained</h2><p>Password auto-filling is not available in non-Chrome browsers on Android like UC browser or MIUI’s default browser. Currently I have to copy them manually from Bitwarden app.</p><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/docker/">docker</a><a href="/tags/Bitwarden/">Bitwarden</a><a href="/tags/NextCloud/">NextCloud</a></div><div class="post-nav"><a href="/clarifying-pickle-in-python/" class="pre">«Understanding pickle in Python</a><a href="/language-ethusiast-and-pragmatist/" class="next">语言狂热者与实用主义者»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="rough-notes-on-deploying-vaultwarden-and-nextcloud-bookmarks/",disqus_title="Rough Notes on Deploying Vaultwarden &amp; NextCloud Bookmarks",disqus_url="https://i.hsfzxjy.site/rough-notes-on-deploying-vaultwarden-and-nextcloud-bookmarks/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"><div id="toc" lang="en" class="font__body"><div class="toc-toggler"></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#install-vaultwarden-and-nextcloud-on-vps"><span class="toc-number">1.</span> <span class="toc-text">Install Vaultwarden and NextCloud on VPS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#enable-https-for-both-services"><span class="toc-number">2.</span> <span class="toc-text">Enable HTTPS for Both Services</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#certbot"><span class="toc-number">2.1.</span> <span class="toc-text">certbot</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#update-config-for-nextcloud"><span class="toc-number">2.2.</span> <span class="toc-text">Update Config for NextCloud</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#install-bookmarks-app-on-nextcloud"><span class="toc-number">3.</span> <span class="toc-text">Install Bookmarks App on NextCloud</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#clients"><span class="toc-number">4.</span> <span class="toc-text">Clients</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#laptop"><span class="toc-number">4.1.</span> <span class="toc-text">Laptop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mobile"><span class="toc-number">4.2.</span> <span class="toc-text">Mobile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#auto-backup-service-data"><span class="toc-number">5.</span> <span class="toc-text">Auto-Backup Service Data</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#problems-remained"><span class="toc-number">6.</span> <span class="toc-text">Problems Remained</span></a></li></ol></div></div></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>