<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><title>Rust - Python FFI From Scratch</title><meta itemprop="title" content="Rust - Python FFI From Scratch - hsfzxjy 的博客"><meta itemprop="og:title" content="Rust - Python FFI From Scratch - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="I was recently working on a side project that involves co..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">Rust - Python FFI From Scratch</h1><div class="post__meta font__ui">2022-03-12 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body"><p>I was recently working on a side project that involves communication between binaries written in Rust and web interfaces written in Python. Moving a part of my project onto a language like Rust is under several considerations: <em>1)</em> the logic is all about manipulating byte arrays, where Python has deficit and system language like Rust is superior; <em>2)</em> the logic happens to be complicated, I need a static type system to ensure the correctness, and also the <code>match</code> expression of Rust is found helpful in getting things concise; <em>3)</em> I was planning to develop CLI tools with Rust, which calls this fraction of functionality, and I don’t want to rewrite the stuff in the future.</p><p>For half a day, I was reading about FFI between the two languages, and finally got everything work as intended. Before stepping into the technical sharing, I would firstly set up the stage of our story.</p><p class="nomargin">My project stores a list of <em>“widgets”</em> in local files on the server side. As of what <em>“widgets”</em> are, it’s sufficient to know that they are stored in a compact binary format. A web endpoint recieves user-provided modification in a similar format, applies them on existing widgets and writes the new widgets back to the files. Technically, the endpoint has two byte arrays as input, <code>mods</code> extracted from the HTTP request and <code>widgets</code> read from local files, which are processed at the Rust side by a function named <code>mod_widgets()</code>, and yields one byte array <code>new_widgets</code> as output.</p><figure class="graphviz"><svg xmlns="http://www.w3.org/2000/svg" width="562pt" height="128pt" viewBox="0 0 562.2 127.52"><g class="graph"><path fill="none" d="M0 127.52V0h562.2v127.52z"/><g class="node" transform="translate(4 123.52)"><path fill="none" d="M92.65-119.52h-66.9v22.26h66.9z"/><text x="59.2" y="-103.34" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">Rust Side</text></g><g class="node" transform="translate(4 123.52)"><path fill="none" d="M80.4-30.51H0v22.26h80.4z"/><text x="40.2" y="-14.33" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">Python Side</text></g><g class="node" transform="translate(4 123.52)"><path fill="#fff5ee" stroke="#444" d="M320.65-119.52h-96.9v22.26h96.9z"/><text x="272.2" y="-103.34" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">mod_widgets()</text></g><g class="node" transform="translate(4 123.52)"><path fill="#fff5ee" stroke="#444" d="M431.65-38.76h-96.9V0h96.9z"/><text x="383.2" y="-22.58" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">consume</text><text x="383.2" y="-6.08" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">new_widgets...</text></g><g class="edge" transform="translate(4 123.52)"><path fill="none" stroke="#444" d="M281.63-97.01c10.04 10.74 26.68 27.67 42.82 40.25 5.09 3.97 10.64 7.88 16.23 11.57"/><path fill="#444" stroke="#444" d="m342.23-48.35 6.53 8.34-10.3-2.44z"/><text x="351.82" y="-64.13" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">new_widgets</text></g><g class="node" transform="translate(4 123.52)"><path fill="#fff5ee" stroke="#444" d="M210.15-30.51h-93.9v22.26h93.9z"/><text x="163.2" y="-14.33" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">recieved mods</text></g><g class="edge" transform="translate(4 123.52)"><path fill="none" stroke="#444" d="M175.23-30.83c13.88-11.97 37.49-32.03 58.47-48.43 4.69-3.67 9.78-7.49 14.68-11.1"/><path fill="#444" stroke="#444" d="m246.04-92.98 10.14-3.05-6.02 8.71z"/><text x="250.95" y="-69.76" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">widgets,</text><text x="250.95" y="-58.51" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">mods</text></g></g></svg></figure><blockquote><p class="par">“byte array” here refers to an array of consecutively stored unsigned 8-bit integers, which is a language-agnostic term. Different languages may adopt their own types or representations for this term, <em>e.g.</em>, <code>bytearray</code> in Python, <code>Vec&lt;u8&gt;</code> in Rust or <code>Uint8Array</code> in Javascript.</p></blockquote><p>I have learned about <a target="_blank" rel="noopener" href="https://github.com/PyO3/pyo3">PyO3</a>, a fascinating framework for writing Python extensions in Rust. But this time I choose not to use it but build everything from scratch. The data passed around is in a basic representation of byte array, simple enough even without the help of PyO3. Besides, building from scratch will give me a better understanding of how the gear works, and how to accomplish in a memory-safe <sup id="fnref:1"><a href="#fn:1">1</a></sup> and efficient <sup id="fnref:2"><a href="#fn:2">2</a></sup> way.</p><p>To this end, I was going to write a dynamic library in Rust, from which the Python code calls certain functions to do the job. The post is organized in three parts. The first part briefly introduces the fundamental of calling functions written by a different programming language, and the following parts show detailed implementation in both Rust and Python.</p><h2 id="ffi-fundamental">FFI Fundamental</h2><p>There’s technical term <strong>FFI</strong> <sup id="fnref:3"><a href="#fn:3">3</a></sup> to describe the mechanism of calling functions from a different programming language. One of the common ways to do FFI is wrapping the functions written in one language in a dynamically linked library <sup id="fnref:4"><a href="#fn:4">4</a></sup>, which is then loaded from another language. However in practice, there’re tons of troubles to concern about and coding can get really cumbersome.</p><p>One of the troubles is ABI compatibility. ABI here refers to <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Application_binary_interface">Application Binary Inteface</a>, an interface between two binary program modules. The term is less familiar to whom work at a higher level such as Python users, but it does exist everywhere in your computer.</p><p class="nomargin">When a program calls functions from a library, they should conform the same conventions in various aspects, such as calling conventions <sup id="fnref:5"><a href="#fn:5">5</a></sup>, memory layout <sup id="fnref:6"><a href="#fn:6">6</a></sup>, <em>etc.</em>. For example, C organizes struct fields in the order of their definition, while Rust by default does not guarantee. There’re also other details like name mangling, where Rust may give the function a different name when producing bianries. If not turned off, the functions can not be located from the Python side.</p><p class="nomargin">Currently, most foreign code exposes a C ABI, <em>i.e.</em>, the ABI generated by the C compiler on your platform. While not standardized, the mechanism serves as a widely used ABI in many cases.</p><p>Another concern is the implications of different languages that might cause undesired behavior on the other side. For example, in GC-based languages like Python, if you pass the pointer to an variable to a foreign function and then drop the variable, the variable might be recycled and the pointer becomes invalid at the other side:</p><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">def</span> <span class="hljs-title function_">func_getb</span>():</span><br><span class="line">    a = <span class="hljs-built_in">bytearray</span>(...)</span><br><span class="line">    b = ffi_atob(ptr_of(a))  <span class="hljs-comment"># b hold a reference to a</span></span><br><span class="line">    <span class="hljs-keyword">return</span> b</span><br><span class="line">    <span class="hljs-comment"># a dropped here!</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">def</span> <span class="hljs-title function_">func_btoc</span>(<span class="hljs-params">b</span>):</span><br><span class="line">    <span class="hljs-keyword">return</span> ffi_btoc(b)</span><br><span class="line"></span><br><span class="line">b = func_getb()   <span class="hljs-comment"># a might be recycled, which invalidates b</span></span><br><span class="line">c = func_btoc(b)  <span class="hljs-comment"># BOOM!</span></span><br></pre></div></div><p class="par">Similar cases exist in Rust. If one allocates a <code>Vec&lt;u8&gt;</code> on the stack and passes out its inner raw pointer, the vec will be dropped at the end of the function and invalidates the pointer:</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">foo</span>() <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span> {</span><br><span class="line">    <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">0u8</span>; <span class="hljs-number">1024</span>];</span><br><span class="line">    v.<span class="hljs-title function_ invoke__">as_ptr</span>()</span><br><span class="line">    <span class="hljs-comment">// v dropped here! returned pointer becomes invalid.</span></span><br><span class="line">}</span><br></pre></div></div><p class="par">Exception handling is another headache. Since different languages have their own approaches to propagate exceptions, it’s essential to stop them before crossing the binary boundary, or otherwise undefined behaviors will occur or even the whole program be crashed.</p><p>In this story, I follow the convention of using C ABI as the bridge of foreign calling, that is, exposing interfaces with <code>extern &quot;C&quot;</code> at Rust and calling with <code>ctypes</code> at Python. Efforts also should be my to ensure exception and memory safety.</p><h2 id="the-rust-side">The Rust Side</h2><p>Let’s start by creating a new cargo package. Simply open a terminal in a new directory and type <code>cargo init --lib</code>. The brilliant Rust package manager will prepare the scaffold to build a shared library. We then add the following lines to the manifest file <code>Cargo.toml</code></p><div class="gk-code hljs" data-gk-id="BLOCK4"><div class="gk-code-display"><pre><span class="line"><span class="hljs-comment"># -- snip --</span></span><br><span class="line"><span class="hljs-section">[lib]</span></span><br><span class="line"><span class="hljs-attr">crate-type</span> = [<span class="hljs-string">&quot;cdylib&quot;</span>]</span><br></pre></div></div><p class="par">As described in the <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/reference/linkage.html#:~:text=%2D%2Dcrate%2Dtype%3Dcdylib%2C%20%23%5Bcrate_type%20%3D%20%22cdylib%22%5D">doc</a>, the <code>crate-type = [&quot;cdylib&quot;]</code> is essential for generating FFI-purposed libraries, without which the library won’t be built with a stable ABI.</p><p class="noindent">Our core implementation will go into the file <code>lib.rs</code>. In this simple library, we are going to expose a function <code>mod_widgets</code>. Let’s write down the a skeleton for it</p><div class="gk-code hljs" data-gk-id="BLOCK5"><div class="gk-code-display"><pre><span class="line"><span class="hljs-comment">// lib.rs</span></span><br><span class="line"><span class="hljs-meta">#[no_mangle]</span></span><br><span class="line"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">mod_widgets</span>(widgets: *<span class="hljs-keyword">mut</span> FFIVec, mods: *<span class="hljs-keyword">mut</span> FFIVec) <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">const</span> FFIVec {</span><br><span class="line">    todo!()</span><br><span class="line">}</span><br></pre></div></div><blockquote><p class="par"><code>#[no_mangle]</code> here disables name mangling for this function. It will therefore appear in the symbol table with exactly the name <code>mod_widgets</code> and become accessible from outside. The <code>extern &quot;C&quot;</code> syntax tells the compiler that our function should conform the C ABI, so that other binaries can call it with the same convention.</p></blockquote><p class="par"><code>FFIVec</code> is a struct encapsulates a byte array and acts as a bridge to exchange data between the two languages. The details will be introduced shortly later, but before which I would like to clarify a fact, that is, there actually exist two kinds of byte arrays in our story</p><ol><li>Byte arrays created at Python and accessed from Rust;</li><li>Byte arrays created at Rust and accessed from Python.</li></ol><p class="par">Why is it important? Because <strong>objects created at one language cannot be de-allocated at the other side.</strong> Imagine, for instance, you apply for a loan at Bank A but later you pay back the money to Bank B. Bank B will have no idea how to deal with the money and Bank A will never remove your loan record, causing a mess in both sides. Each language has its own and distinct implementation for memory allocation, and we must pair the allocator with corresponding de-allocator. We must keep this in mind when crafting the details of <code>FFIVec</code>.</p><h3 id="byte-arrays-from-python">Byte Arrays from Python</h3><p>To access the first kind of byte array in Rust, it is sufficient to use the following data structure, which tells the starting location and the length of the array</p><div class="gk-code hljs" data-gk-id="BLOCK6"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">#[repr(C)]</span></span><br><span class="line"><span class="hljs-meta">#[derive(Debug)]</span></span><br><span class="line"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">FFIVec</span> {</span><br><span class="line">    len: <span class="hljs-type">usize</span>,</span><br><span class="line">    data: *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span>,</span><br><span class="line">}</span><br></pre></div></div><blockquote><p class="par">The attribute <code>#[repr(C)]</code> enforces the compiler to use a memory layout that conform the C ABI. Otherwise Rust code might read unaligned or corrupted data.</p></blockquote><p class="nomargin">Code at Python side can construct a similar struct using something like <code>ctypes</code> and pass its reference to <code>mod_widgets()</code>. Code at Rust side then re-interprets the <code>*mut FFIVec</code> pointer to type <code>&amp;[u8]</code> for easier further processing, with the help of function <code>FFIVec::raw_to_slice()</code></p><div class="gk-code hljs" data-gk-id="BLOCK7"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">FFIVec</span> {</span><br><span class="line">    <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">raw_to_slice</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt;(ptr: *<span class="hljs-keyword">mut</span> <span class="hljs-keyword">Self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;a</span> [<span class="hljs-type">u8</span>] {</span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">from_raw</span>(ptr);</span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">slice</span> = core::slice::<span class="hljs-title function_ invoke__">from_raw_parts</span>(v.data, v.len);</span><br><span class="line">        <span class="hljs-comment">// since v &quot;owns&quot; the buffer, we forget it to not let the struct get dropped</span></span><br><span class="line">        std::mem::forget(v);</span><br><span class="line">        slice</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></div></div><p class="par">It’s worth noting that <code>raw_to_slice()</code> does not perform buffer copying, and therefore impose little runtime overhead, which is efficient.</p><h3 id="byte-arrays-from-rust">Byte Arrays from Rust</h3><p>As of returning a byte array to Python (<em>i.e.</em>, the second kind), however, things get a bit complicated. Remember the pre-caution above – <strong>if a piece of memory is allocated by Rust code, it should eventually be de-allocated by Rust code</strong>. Our library thus need to export another function</p><div class="gk-code hljs" data-gk-id="BLOCK8"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">#[no_mangle]</span></span><br><span class="line"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">free_ffi_vec</span>(v: *<span class="hljs-keyword">mut</span> FFIVec) {</span><br><span class="line">    todo!()</span><br><span class="line">}</span><br></pre></div></div><p class="par">The Python code is responsible to call <code>free_ffi_vec()</code> manually after consuming the <code>FFIVec</code> struct returned by <code>mod_widgets()</code>. Our working flow is thus extended into</p><figure class="graphviz"><svg xmlns="http://www.w3.org/2000/svg" width="598pt" height="116pt" viewBox="0 0 598.2 116.27"><g class="graph"><path fill="none" d="M0 116.27V0h598.2v116.27z"/><g class="node" transform="translate(4 112.27)"><path fill="none" d="M79.65-108.27h-66.9v22.26h66.9z"/><text x="46.2" y="-92.09" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">Rust Side</text></g><g class="node" transform="translate(4 112.27)"><path fill="none" d="M80.4-30.51H0v22.26h80.4z"/><text x="40.2" y="-14.33" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">Python Side</text></g><g class="node" transform="translate(4 112.27)"><path fill="#fff5ee" stroke="#444" d="M303.65-108.27h-96.9v22.26h96.9z"/><text x="255.2" y="-92.09" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">mod_widgets()</text></g><g class="node" transform="translate(4 112.27)"><path fill="#fff5ee" stroke="#444" d="M431.65-38.76h-96.9V0h96.9z"/><text x="383.2" y="-22.58" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">consume</text><text x="383.2" y="-6.08" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">new_widgets...</text></g><g class="edge" transform="translate(4 112.27)"><path fill="none" stroke="#444" d="M269.74-85.63c11.61 8.22 28.4 19.74 43.71 28.87 6.86 4.09 14.22 8.21 21.5 12.13"/><path fill="#444" stroke="#444" d="m336.59-47.73 7.2 7.78-10.48-1.59z"/><text x="340.82" y="-58.51" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">new_widgets</text></g><g class="node" transform="translate(4 112.27)"><path fill="#fff5ee" stroke="#444" d="M517.9-108.27h-89.4v22.26h89.4z"/><text x="473.2" y="-92.09" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">free_ffi_vec()</text></g><g class="node" transform="translate(4 112.27)"><path fill="#fff5ee" stroke="#444" d="M210.15-30.51h-93.9v22.26h93.9z"/><text x="163.2" y="-14.33" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">received mods</text></g><g class="edge" transform="translate(4 112.27)"><path fill="none" stroke="#444" d="M169.09-30.99c6.25-10.48 16.95-26.44 29.61-37.02 5.76-4.82 12.49-9.07 19.25-12.72"/><path fill="#444" stroke="#444" d="m215.91-83.62 10.51-1.33-7.39 7.6z"/><text x="227.95" y="-58.51" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">widgets, mods</text></g><g class="edge" transform="translate(4 112.27)"><path fill="none" stroke="#444" d="M395.94-39c7.07-9.44 16.46-20.65 26.51-29.01 5.26-4.37 11.3-8.41 17.34-11.97"/><path fill="#444" stroke="#444" d="m438.03-83.01 10.45-1.78-7.06 7.9z"/><text x="449.82" y="-58.51" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">new_widgets</text></g></g></svg></figure><p class="par">At Rust side, the duty of <code>free_ffi_vec()</code> is to de-allocate the underlying memory, given the argument of type <code>*mut FFIVec</code> as handle. However, it’s not that trivial as we thought, if we stick to a design of <code>FFIVec</code> like above.</p><p class="nomargin">To allocate a byte array, a “Rust-ic” and common way is by constructing a <code>Vec&lt;u8&gt;</code>. It’s straight-forward to write a function that converts a <code>Vec&lt;u8&gt;</code> into <code>*mut FFIVec</code>, in order that it could be pass across the FFI boundary</p><div class="gk-code hljs" data-gk-id="BLOCK10"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">FFIVec</span> {</span><br><span class="line">    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_vec</span>(vec: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;) <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">mut</span> <span class="hljs-keyword">Self</span> {</span><br><span class="line">        <span class="hljs-comment">// build an FFIVec on heap</span></span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-keyword">Self</span> {</span><br><span class="line">            len: vec.<span class="hljs-title function_ invoke__">len</span>(),</span><br><span class="line">            data: vec.<span class="hljs-title function_ invoke__">as_ptr</span>(),</span><br><span class="line">        });</span><br><span class="line">        std::mem::forget(vec);</span><br><span class="line">        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">into_raw</span>(v)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></div></div><p class="par">Fairly neat and sound. But it upsets you soon, since there’s no way to implement <code>free_ffi_vec()</code> with such a design!</p><p class="nomargin">The problem is, our only way to do de-allocation is recovering the <code>*mut FFIVec</code> back to a <code>Vec&lt;u8&gt;</code> and call the <code>drop()</code> function. However, the recover job is impossible, since we “lose” it after the <code>forget()</code> calling.</p><p class="nomargin">As a workaround, we have to make our <code>FFIVec</code> a litte bit “fatter”, and invite the original vec to live within the struct. Namely, the implementation is modified into</p><div class="gk-code hljs" data-gk-id="BLOCK11"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">#[repr(C)]</span></span><br><span class="line"><span class="hljs-meta">#[derive(Debug)]</span></span><br><span class="line"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">FFIVec</span> {</span><br><span class="line">    len: <span class="hljs-type">usize</span>,</span><br><span class="line">    data: *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span>,</span><br><span class="line">    <span class="hljs-comment">// hl: begin</span></span><br><span class="line">    storage: *<span class="hljs-keyword">mut</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;,</span><br><span class="line">    <span class="hljs-comment">// hl: end</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">FFIVec</span> {</span><br><span class="line">    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_vec</span>(vec: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;) <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">mut</span> <span class="hljs-keyword">Self</span> {</span><br><span class="line">        <span class="hljs-comment">// hl: begin</span></span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">vec</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(vec);</span><br><span class="line">        <span class="hljs-comment">// hl: end</span></span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-keyword">Self</span> {</span><br><span class="line">            len: vec.<span class="hljs-title function_ invoke__">len</span>(),</span><br><span class="line">            data: vec.<span class="hljs-title function_ invoke__">as_ptr</span>(),</span><br><span class="line">            <span class="hljs-comment">// hl: begin</span></span><br><span class="line">            storage: <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">into_raw</span>(vec),</span><br><span class="line">            <span class="hljs-comment">// hl: end</span></span><br><span class="line">        });</span><br><span class="line">        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">into_raw</span>(v)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></div></div><p class="par">A pointer to the original vec is stored as a member in the new design of <code>FFIVec</code>. We now are able to recover it even with a bare <code>*mut FFIVec</code>, and happy to implement the de-allocation</p><div class="gk-code hljs" data-gk-id="BLOCK12"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">#[no_mangle]</span></span><br><span class="line"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">free_ffi_vec</span>(v: *<span class="hljs-keyword">mut</span> FFIVec) {</span><br><span class="line">    <span class="hljs-keyword">if</span> v != <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> FFIVec {</span><br><span class="line">        <span class="hljs-keyword">unsafe</span> {</span><br><span class="line">            <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">from_raw</span>(v);</span><br><span class="line">            <span class="hljs-title function_ invoke__">drop</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">from_raw</span>(v.storage));</span><br><span class="line">            <span class="hljs-title function_ invoke__">drop</span>(v)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></div></div><h3 id="dont-panic">Don’t Panic</h3><p>As aforementioned, we have to care a bunch of implications of Rust, and panic is one of them. The Python interpreter have no idea of who it is interacting with, not even the alien mechanism of panic. It will goes “really panick” if such things cross the boundary, and it’s our duty to stop them just at Rust side.</p><p class="nomargin">There’re many ways to avoid panics. For example, always do checking before <code>.wrap()</code> or something alike. In this story, I adopt a rather brutal one which is using <code>std::panic::catch_unwind()</code> <sup id="fnref:7"><a href="#fn:7">7</a></sup>. This guy behaves as a top level try-catch in other languages that invokes a closure and blocks potential panics from leaking. More information on this function can be found in the doc.</p><p class="noindent">Now put them together, we finish the part of code to bridge the FFI gap at Rust side</p><div class="gk-code hljs" data-gk-id="BLOCK13"><div class="gk-code-display"><pre><span class="line"><span class="hljs-meta">#[repr(C)]</span></span><br><span class="line"><span class="hljs-meta">#[derive(Debug)]</span></span><br><span class="line"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">FFIVec</span> {</span><br><span class="line">    len: <span class="hljs-type">usize</span>,</span><br><span class="line">    data: *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span>,</span><br><span class="line">    storage: *<span class="hljs-keyword">mut</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">FFIVec</span> {</span><br><span class="line">    <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">raw_to_slice</span>&lt;<span class="hljs-symbol">&#x27;a</span>&gt;(ptr: *<span class="hljs-keyword">mut</span> <span class="hljs-keyword">Self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-symbol">&#x27;a</span> [<span class="hljs-type">u8</span>] {</span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">from_raw</span>(ptr);</span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">slice</span> = core::slice::<span class="hljs-title function_ invoke__">from_raw_parts</span>(v.data, v.len);</span><br><span class="line">        std::mem::forget(v);</span><br><span class="line">        slice</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">from_vec</span>(vec: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;) <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">mut</span> <span class="hljs-keyword">Self</span> {</span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">vec</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(vec);</span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-keyword">Self</span> {</span><br><span class="line">            len: vec.<span class="hljs-title function_ invoke__">len</span>(),</span><br><span class="line">            data: vec.<span class="hljs-title function_ invoke__">as_ptr</span>(),</span><br><span class="line">            storage: <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">into_raw</span>(vec),</span><br><span class="line">        });</span><br><span class="line">        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">into_raw</span>(v)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#[no_mangle]</span></span><br><span class="line"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">free_ffi_vec</span>(v: *<span class="hljs-keyword">mut</span> FFIVec) {</span><br><span class="line">    <span class="hljs-keyword">if</span> v != <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> FFIVec {</span><br><span class="line">        <span class="hljs-keyword">unsafe</span> {</span><br><span class="line">            <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">from_raw</span>(v);</span><br><span class="line">            <span class="hljs-title function_ invoke__">drop</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">from_raw</span>(v.storage));</span><br><span class="line">            <span class="hljs-title function_ invoke__">drop</span>(v)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#[no_mangle]</span></span><br><span class="line"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">mod_widgets</span>(widgets: *<span class="hljs-keyword">mut</span> FFIVec, mods: *<span class="hljs-keyword">mut</span> FFIVec) <span class="hljs-punctuation">-&gt;</span> *<span class="hljs-keyword">const</span> FFIVec {</span><br><span class="line">    std::panic::<span class="hljs-title function_ invoke__">catch_unwind</span>(|| {</span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">widgets</span>: &amp;[<span class="hljs-type">u8</span>] = FFIVec::<span class="hljs-title function_ invoke__">raw_to_slice</span>(widgets);</span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">mods</span>: &amp;[<span class="hljs-type">u8</span>] = FFIVec::<span class="hljs-title function_ invoke__">raw_to_slice</span>(mods);</span><br><span class="line">        <span class="hljs-keyword">let</span> <span class="hljs-variable">new_widgets</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt; = <span class="hljs-title function_ invoke__">play_with</span>(widgets, mods);</span><br><span class="line">        FFIVec::<span class="hljs-title function_ invoke__">from_vec</span>(new_widgets)</span><br><span class="line">    })</span><br><span class="line">        <span class="hljs-comment">// returns NULL on panic</span></span><br><span class="line">        .<span class="hljs-title function_ invoke__">unwrap_or</span>(<span class="hljs-number">0</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> FFIVec)</span><br><span class="line">}</span><br></pre></div></div><h2 id="the-python-side">The Python Side</h2><p>It is now half the battle! And the rest half is easier to conquer.</p><p>To play with the shared library generated by Rust, we need the <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/ctypes.html">ctypes</a> module. <code>ctypes</code> is the FFI library for Python. It provides facilities to compose or read from C data structures, and allows calling functions from a shared library. I won’t give an overall introduction to the library since it’s such a huge project, but rather focus on what we would use.</p><h3 id="the-data-bridge">The Data Bridge</h3><p class="nomargin">We would first deal with data bridge. As a peer to <code>FFIVec</code> in Rust, we should also declare the same struct at Python side</p><div class="gk-code hljs" data-gk-id="BLOCK14"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FFIVec</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="hljs-string">&quot;len&quot;</span>, ctypes.c_size_t),</span><br><span class="line">        (<span class="hljs-string">&quot;data&quot;</span>, ctypes.c_void_p),</span><br><span class="line">        (<span class="hljs-string">&quot;_storage&quot;</span>, ctypes.c_void_p),</span><br><span class="line">    ]</span><br></pre></div></div><p class="par">The syntax is straight-forward. <code>ctypes</code> provides various data types like <code>c_size_t</code> or <code>c_void_p</code> to represents their correspondences in C. These types work as guidance for data conversion. For example, when an Python <code>int</code> object (which has varied length) passed to a <code>c_size_t</code>, <code>ctypes</code> would know that it should be casted into an 8-bit unsigned integer (on 64-bit platform), and vice versa.</p><p class="nomargin">The <code>FFIVec</code> class is only a broker. Just like in Rust, we must implement the conversion between it and some more common Python data types, <em>e.g.</em>, <code>bytearray</code> or <code>bytes</code>, to make it useful. The two methods below would work for the purpose</p><div class="gk-code hljs" data-gk-id="BLOCK15"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FFIVec</span>(...):</span><br><span class="line">    ...</span><br><span class="line"><span class="hljs-meta">    @classmethod</span></span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_bytearray</span>(<span class="hljs-params">cls, buf: <span class="hljs-built_in">bytearray</span></span>) -&gt; <span class="hljs-string">&quot;FFIVec&quot;</span>:</span><br><span class="line">        l = <span class="hljs-built_in">len</span>(buf)</span><br><span class="line">        ptr = (ctypes.c_uint8 * l).from_buffer(buf)</span><br><span class="line">        data = ctypes.cast(ptr, ctypes.c_void_p)</span><br><span class="line">        <span class="hljs-keyword">return</span> cls(<span class="hljs-built_in">len</span>=length, data=data, _storage=<span class="hljs-literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_bytes</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bytes</span>:</span><br><span class="line">        ptr = (ctypes.c_uint8 * self.<span class="hljs-built_in">len</span>).from_address(self.data)</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(ptr)</span><br></pre></div></div><p class="par">The class method <code>from_bytearray()</code> creates an <code>FFIVec</code> instance from a given <code>bytearray</code> object. The instance shares the same memory view with that bytearray, and no memory copying occurs. The instance method <code>to_bytes()</code> instead constructs a <code>bytes</code> object, which the underlying memory is copied into.</p><blockquote><p class="par">You may notice the <code>c_uint8 * l</code> syntax. The expression is not doing arithmetics, but creates an <em><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/ctypes.html#arrays">array type</a></em>. It’s equivalent to C <code>uint8_t</code> array type with fixed length <code>l</code>. With this type, we can access the buffer address of a <code>bytearray</code> object, or pump data into a <code>bytes</code> object.</p></blockquote><h3 id="call-the-functions">Call the Functions</h3><p>There’s one last piece in our puzzle – to interact with the functions from a foreign language. But firstly, we should load the shared library. This can be handled by <code>ctypes.cdll.LoadLibrary</code></p><div class="gk-code hljs" data-gk-id="BLOCK16"><div class="gk-code-display"><pre><span class="line">libw = ctypes.cdll.LoadLibrary(<span class="hljs-string">&quot;path/to/libmod_widgets.so&quot;</span>)</span><br></pre></div></div><p class="par">After that, we declare the functions to be called, by attributing <code>libw</code></p><div class="gk-code hljs" data-gk-id="BLOCK17"><div class="gk-code-display"><pre><span class="line">PFFIVec = ctypes.POINTER(FFIVec)</span><br><span class="line"></span><br><span class="line">mod_widgets = libw.mod_widgets</span><br><span class="line">mod_widgets.argtypes = (PFFIVec, PFFIVec)</span><br><span class="line">mod_widgets.restype = PFFIVec</span><br><span class="line"></span><br><span class="line">free_ffi_vec = libw.free_ffi_vec</span><br><span class="line">free_ffi_vec.argtypes = (PFFIVec,)</span><br></pre></div></div><blockquote><p class="par">In the above code, we also specify the argument and return types of the foreign functions. This is not required <sup id="fnref:8"><a href="#fn:8">8</a></sup>, but I recommend to do so whenever possible. Specifying the types can avoid data being incorrectly coerced by <code>ctypes</code>.</p></blockquote><p class="nomargin">That’s it! The functions <code>mod_widgets</code> and <code>free_ffi_vec</code> can now be called just like ordinary Python functions</p><div class="gk-code hljs" data-gk-id="BLOCK18"><div class="gk-code-display"><pre><span class="line">old_widgets = <span class="hljs-built_in">bytearray</span>(...)</span><br><span class="line">mods = <span class="hljs-built_in">bytearray</span>(...)</span><br><span class="line">new_widgets = mod_widgets(</span><br><span class="line">    FFIVec.from_bytes(old_widgets),</span><br><span class="line">    FFIVec.from_bytes(mods),</span><br><span class="line">).contents  <span class="hljs-comment"># .contents dereferences the pointer</span></span><br><span class="line"></span><br><span class="line">new_widgets_bytes = new_widgets.to_bytes()  <span class="hljs-comment"># copy out as bytes</span></span><br><span class="line">free_ffi_vec(new_widgets)  <span class="hljs-comment"># de-allocate at Rust side</span></span><br></pre></div></div><p class="noindent">Cheers!</p><h2 id="epilogue-1">Epilogue</h2><p>This post showcases a simple yet practical example to call functions written in Rust from Python. I deliberately built all the stuff from scratch. Working at such a low level forces me to think carefully about potential edge cases, which I have never noticed before. It’s quite an entertainment and I learnt a good lesson.</p><div class="footnotes"><ol><li class="footnote" id="fn:1">no memory leaking, no double freeing</li><li class="footnote" id="fn:2">least memory copies possible</li><li class="footnote" id="fn:3"><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Foreign_function_interface">https://en.wikipedia.org/wiki/Foreign_function_interface</a></li><li class="footnote" id="fn:4"><code>.so</code> files in Linux or <code>.dll</code> files in Windows</li><li class="footnote" id="fn:5">how to pass the arguments. by registers? by stack?</li><li class="footnote" id="fn:6">how to order the fields of a struct? pad short fields or not?</li><li class="footnote" id="fn:7"><a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/panic/fn.catch_unwind.html">https://doc.rust-lang.org/std/panic/fn.catch_unwind.html</a></li><li class="footnote" id="fn:8"><a target="_blank" rel="noopener" href="https://docs.python.org/3/library/ctypes.html#specifying-the-required-argument-types-function-prototypes">https://docs.python.org/3/library/ctypes.html#specifying-the-required-argument-types-function-prototypes</a></li></ol></div><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/Python/">Python</a><a href="/tags/Rust/">Rust</a><a href="/tags/FFI/">FFI</a></div><div class="post-nav"><a href="/initialize-pool-worker-with-individual-values/" class="pre">«Initialize Process Pool Worker with Individual Value</a><a href="/extending-hexo-better-mathjax-rendering/" class="next">[Extending Hexo For My Site] Part 1 - Better Mathjax Rendering»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="rust-python-ffi-from-scratch/",disqus_title="Rust - Python FFI From Scratch",disqus_url="https://i.hsfzxjy.site/rust-python-ffi-from-scratch/";!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.defer=!0,t.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(t),t.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"><div id="toc" lang="en" class="font__body"><div class="toc-toggler"></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ffi-fundamental"><span class="toc-number">1.</span> <span class="toc-text">FFI Fundamental</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-rust-side"><span class="toc-number">2.</span> <span class="toc-text">The Rust Side</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#byte-arrays-from-python"><span class="toc-number">2.1.</span> <span class="toc-text">Byte Arrays from Python</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#byte-arrays-from-rust"><span class="toc-number">2.2.</span> <span class="toc-text">Byte Arrays from Rust</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dont-panic"><span class="toc-number">2.3.</span> <span class="toc-text">Don’t Panic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#the-python-side"><span class="toc-number">3.</span> <span class="toc-text">The Python Side</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#the-data-bridge"><span class="toc-number">3.1.</span> <span class="toc-text">The Data Bridge</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#call-the-functions"><span class="toc-number">3.2.</span> <span class="toc-text">Call the Functions</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#epilogue-1"><span class="toc-number">4.</span> <span class="toc-text">Epilogue</span></a></li></ol></div></div></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>