<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script>(()=>{let e="/cnfonts.js?rDuukLHQ",t=document,n=navigator.serviceWorker,r=!1;var a;(r=n&&(n.register(e,{scope:"/"}).then(e=>e.update()),a=n.controller)&&a.scriptURL.endsWith(e)&&"activated"===a.state?!0:r)?((a=t.createElement("link")).rel="stylesheet",a.href="/fontchan/rDuukLHQ.css",a.blocking="render",t.head.appendChild(a)):((a=t.createElement("script")).src=e,a.onload=()=>$fontchan.injectCss(),t.head.appendChild(a))})()</script><title>[Unravelling mocona] Part 1 - Verbosity or Anti-Pattern</title><meta itemprop="title" content="[Unravelling mocona] Part 1 - Verbosity or Anti-Pattern - hsfzxjy 的博客"><meta itemprop="og:title" content="[Unravelling mocona] Part 1 - Verbosity or Anti-Pattern - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="I was once working as an intern at MSRA around two years ..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">[Unravelling mocona] Part 1 - Verbosity or Anti-Pattern</h1><div class="post__meta font__ui">2021-09-16 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body"><p>I was once working as an intern at MSRA around two years ago, at which I joined a research project and started developing upon a large codebase. It’s a practice in ML research fields to adopt an existing code repository as codebase, instead of crafting everything from scratch. Such codebases usually come with convenient “infrastructures” <sup id="fnref:1"><a href="#fn:1">1</a></sup>, so researchers would not have to implement them once again, which could be time-wasting and error-prone. All we need is to write our models and losses, and put them into experiments.</p><p>The flow works just fine if you are proposing minor improvement on algorithms. The codebase provides an easy approach to prove and iterate your idea. But things would get worse if your work goes beyond it, especially touching the encapsulated infrastructures. Those convenient parts would constraint you and enforce your code into spaghetti.</p><p>At that time we were working on a new algorithm for image segmentation problem. The algorithm proposed a pipeline that is totally different from previous ones. To match it we had to introduce new data preprocessor as well as training scheme. The codebase, however, was designed for previous algorithms and presumed a traditional pipeline. It was as solid as a rock and we could hardly put our customization in.</p><p class="nomargin">We kept stuffing dozens of lines of code into the codebase. Most of them are badly-designed, repetitive and tightly coupled. We were at that time desperately catching up a conference deadline, applying every effort we had to figure out the optimal setting. Any irrelevant re-factoring would be considered time-consuming and risky. The development went on for months, and finally it grew up into a giant and terrifying monster. Here I would like to share two issues we’ve encountered.</p><hr><p>The first one happens in pairing a model with corresponding data loader. A traditional segmentation algorithm takes images (<code>img</code>) as input and is supervised by ground truth segmentation maps (<code>gtseg</code>). The data loader in codebase, therefore, default to yield a tuple of <code>(img, gtseg)</code> for each training iteration. Whereas in our method, the algorithm expects another two kinds of supervision <code>gtdist</code> and <code>gtoffset</code>, which requires totally different logic for loading and pre-processing.</p><p class="nomargin">Okay. So now we have two kinds of data loader, one for traditional methods, another for our method. We reserve a configuration entry <code>loader_type</code> for selecting a specific loader. The configuration would be firstly passed to a class <code>Trainer</code>, then to a <code>DataLoaderBuilder</code> to instantiate the chosen loader.</p><p class="nomargin">The class <code>Trainer</code> is fundamental in our program. It takes charge of all the instantiation for main components <sup id="fnref:2"><a href="#fn:2">2</a></sup>, and maintains the logic of training loop and evaluation. The design presents a hierarchy like</p><figure class="graphviz"><svg xmlns="http://www.w3.org/2000/svg" width="408" height="118pt" viewBox="0 0 306.49 118.23"><g class="graph"><path fill="none" d="M0 118.23V0h306.49v118.23z"/><g class="node" transform="translate(4 114.23)"><path fill="#fff5ee" stroke="#444" d="m168.52-78.78 2.49-.09 2.48-.13 2.43-.17 2.39-.21 2.34-.26 2.27-.29 2.2-.34 2.11-.37 2.03-.42 1.93-.45 1.82-.48 1.72-.52 1.6-.55 1.48-.58 1.36-.62 1.22-.64 1.1-.67.97-.69.84-.71.7-.74.56-.75.44-.77.3-.78.17-.8.05-.81-.08-.81-.19-.82-.32-.82-.42-.83-.54-.82-.63-.82-.73-.82-.83-.8-.91-.8-.99-.78-1.06-.77-1.14-.76-1.2-.73-1.26-.72-1.31-.69-1.37-.67-1.4-.64-1.45-.61-1.48-.58-1.51-.55-1.54-.52-1.56-.49-1.58-.45-1.6-.41-1.62-.37-1.63-.34-1.64-.29-1.64-.26-1.66-.21-1.66-.17-1.66-.13-1.66-.09-1.67-.04h-1.67l-1.67.04-1.66.09-1.67.13-1.66.17-1.65.21-1.65.26-1.64.29-1.62.34-1.62.37-1.6.41-1.58.45-1.57.49-1.53.52-1.52.55-1.48.58-1.44.61-1.41.64-1.36.67-1.31.69-1.26.72-1.2.73-1.14.76-1.06.77-1 .78-.91.8-.82.8-.73.82-.64.82-.53.82-.43.83-.31.82-.2.82-.07.81.04.81.18.8.3.78.43.77.57.75.7.74.84.71.96.69 1.1.67 1.23.64 1.36.62 1.48.58 1.6.55 1.71.52 1.83.48 1.93.45 2.02.42 2.12.37 2.2.34 2.27.29 2.33.26 2.39.21L156-79l2.47.13 2.5.09 2.51.04H166z"/><text x="164.74" y="-89.44" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">Trainer</text></g><g class="edge" transform="translate(4 114.23)"><path fill="none" stroke="#444" stroke-dasharray="5,2" d="M57.25-94.49h55.68"/><path fill="#444" stroke="#444" d="m112.89-97.99 10 3.5-10 3.5z"/><text x="90.73" y="-99.24" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">loader_type</text></g><g class="node" transform="translate(4 114.23)"><path fill="#fff5ee" stroke="#444" d="m100.01-.04 5.48-.09 5.41-.13 5.34-.17 5.24-.21 5.12-.26 4.97-.29 4.82-.34 4.63-.37 4.44-.42 4.23-.44 4-.49 3.75-.52 3.51-.55 3.25-.58 2.97-.62 2.69-.64 2.41-.66 2.12-.7 1.83-.71 1.53-.73 1.24-.76.95-.77.67-.78.38-.8.1-.81-.17-.81-.43-.82-.69-.82-.93-.83-1.17-.82-1.39-.82-1.6-.82-1.81-.8-1.99-.8-2.17-.78-2.34-.77-2.49-.76-2.63-.73-2.76-.72-2.88-.69-2.98-.66-3.08-.65-3.17-.61-3.24-.58-3.32-.55-3.37-.52-3.42-.49-3.47-.45-3.51-.41-3.53-.37-3.57-.34-3.59-.29-3.61-.26-3.62-.21-3.64-.17-3.64-.13-3.65-.09-3.66-.04h-3.65l-3.66.04-3.65.09-3.64.13-3.64.17-3.62.21-3.61.26-3.59.29-3.57.34-3.54.37-3.5.41-3.47.45-3.43.49-3.37.52-3.31.55-3.24.58-3.17.61-3.08.65-2.99.66-2.87.69-2.76.72-2.63.73-2.49.76-2.34.77-2.17.78-2 .8-1.8.8-1.6.82-1.4.82-1.16.82-.93.83-.69.82-.43.82-.17.81.1.81.38.8.66.78.95.77 1.25.76 1.53.73 1.83.71 2.12.7 2.41.66 2.69.64 2.97.62 3.25.58 3.5.55 3.76.52 4 .49 4.23.44 4.44.42 4.63.37 4.82.34 4.97.29 5.12.26 5.24.21 5.33.17L78-.13l5.48.09 5.5.04h5.52z"/><text x="91.74" y="-10.7" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">DataLoaderBuilder</text></g><g class="edge" transform="translate(4 114.23)"><path fill="none" stroke="#444" d="M151.01-79.05c-10.47 11-25.1 26.39-37.2 39.11"/><path fill="#444" stroke="#444" d="m116.38-37.57-9.43 4.83 4.36-9.65z"/><text x="156.99" y="-51.24" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">loader_type</text></g><g class="node" transform="translate(4 114.23)"><path fill="#fff5ee" stroke="#444" d="m240.26-.04 2.32-.09 2.3-.13 2.27-.17 2.22-.21 2.18-.26 2.11-.29 2.05-.34 1.97-.37 1.88-.42 1.8-.44 1.7-.49 1.59-.52 1.49-.55 1.38-.58 1.26-.62 1.15-.64 1.02-.66.9-.7.78-.71.65-.73.53-.76.4-.77.28-.78.16-.8.05-.81-.08-.81-.18-.82-.29-.82-.4-.83-.49-.82-.59-.82-.69-.82-.76-.8-.85-.8-.92-.78-.99-.77-1.06-.76-1.12-.73-1.17-.72-1.22-.69-1.27-.66-1.31-.65-1.35-.61-1.37-.58-1.41-.55-1.43-.52-1.46-.49-1.47-.45-1.49-.41-1.5-.37-1.52-.34-1.52-.29-1.54-.26-1.53-.21-1.55-.17-1.55-.13-1.55-.09-1.55-.04h-1.55l-1.56.04-1.55.09-1.54.13-1.55.17-1.54.21-1.53.26-1.53.29-1.51.34-1.5.37-1.49.41-1.48.45-1.45.49-1.43.52-1.41.55-1.38.58-1.34.61-1.31.65-1.27.66-1.22.69-1.17.72-1.12.73-1.06.76-.99.77-.92.78-.85.8-.77.8-.68.82-.59.82-.5.82-.39.83-.29.82-.19.82-.07.81.04.81.17.8.28.78.4.77.53.76.65.73.78.71.9.7 1.02.66 1.15.64 1.26.62 1.38.58 1.48.55 1.6.52 1.7.49 1.8.44 1.88.42 1.97.37 2.05.34 2.11.29 2.17.26 2.23.21 2.27.17 2.3.13 2.32.09 2.34.04h2.35z"/><text x="236.74" y="-10.7" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">Model</text></g><g class="edge" transform="translate(4 114.23)"><path fill="none" stroke="#444" d="M178.29-79.05c10.65 11.36 25.68 27.38 37.83 40.33"/><path fill="#444" stroke="#444" d="m218.66-41.13 4.29 9.68-9.39-4.89z"/></g></g></svg></figure><p class="nomargin">It should be alright when there’s only two kinds of loader. But things got complicated as the experiments proceed. During the months We’ve tried dozens of model designs for seeking an optimal one. Some of them should be fed with a combination of input that is different from the two before <sup id="fnref:3"><a href="#fn:3">3</a></sup>. More loaders popped out in support of those models. We began to mess up, since it was a tedious nightmare to keep <code>loader_type</code> in sync with the model in each configuration file.</p><hr><p>The second is a rather common problem in training models. Say you have designed a multi-stage training pipeline, where you would like the model to switch its behavior at some point. In the first X iterations, we disable a component A of model for warming up; while after that, it is enabled again for normal training. The catch is, how to make a deeply rooted component aware of the iteration number?</p><p class="nomargin">Back to our codebase. We had a <code>Trainer</code> in charge of everything. It starts a training loop, in which the iteration number lies as a local variable. It also holds a reference to the model. The model has a hierachical structure, and component A hides deeply in some layers.</p><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Trainer</span>:</span><br><span class="line">    model: <span class="hljs-string">&quot;Model&quot;</span></span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">self</span>):</span><br><span class="line">        <span class="hljs-keyword">for</span> iter_num, data_batch <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(self.data_loader):</span><br><span class="line">            self.model.forward(data_batch)</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span>:</span><br><span class="line">    A: <span class="hljs-string">&quot;ComponentA&quot;</span></span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, data_batch</span>):</span><br><span class="line">        ...</span><br><span class="line">        self.A.forward(data_batch)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ComponentA</span>:</span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, data_batch</span>):</span><br><span class="line">        <span class="hljs-comment"># How can I access iter_num?</span></span><br></pre></div></div><p class="par">The stuff was implemented in a rough way at that time – we add a second argument for both <code>Model.forward()</code> and <code>ComponentA.forward()</code>, and pass <code>iter_num</code> down along the path.</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Trainer</span>:</span><br><span class="line">    model: <span class="hljs-string">&quot;Model&quot;</span></span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">self</span>):</span><br><span class="line">        <span class="hljs-keyword">for</span> iter_num, data_batch <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(self.data_loader):</span><br><span class="line">            <span class="hljs-comment">#hl: begin</span></span><br><span class="line">            self.model.forward(data_batch, iter_num)</span><br><span class="line">            <span class="hljs-comment">#hl: end</span></span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span>:</span><br><span class="line">    A: <span class="hljs-string">&quot;ComponentA&quot;</span></span><br><span class="line">    <span class="hljs-comment">#hl: begin</span></span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, data_batch, iter_num</span>):</span><br><span class="line">    <span class="hljs-comment">#hl: end</span></span><br><span class="line">        ...</span><br><span class="line">        self.A.forward(data_batch, iter_num)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ComponentA</span>:</span><br><span class="line">    <span class="hljs-comment">#hl: begin</span></span><br><span class="line">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, data_batch, iter_num</span>):</span><br><span class="line">    <span class="hljs-comment">#hl: end</span></span><br><span class="line">        <span class="hljs-comment"># How can I access iter_num?</span></span><br></pre></div></div><p class="nomargin">Jesus it is dirty. The argument passing “contaminates” all functions it goes through. Whether or not expecting, they have to accept an extra argument. What if more components would like to access the states? What if more states would be passed? Every single change would have to modify a large area of code. Nobody would like it. At least I won’t.</p><hr><p>Now let’s move to a higher level for some deeper thoughts. In the first example, we choose to initiate model and data loader separately. The crux is, <em>they are not uncorrelated components</em>. The choice of model decides what shape input data would be like, and further determines the type of loader. We in fact have a graph like</p><figure class="graphviz"><svg xmlns="http://www.w3.org/2000/svg" width="329pt" height="118pt" viewBox="0 0 329.3 118.23"><g class="graph"><path fill="none" d="M0 118.23V0h329.3v118.23z"/><g class="node" transform="translate(4 114.23)"><path fill="#fff5ee" stroke="#444" d="m138.73-78.78 2.49-.09 2.48-.13 2.43-.17 2.39-.21 2.34-.26 2.27-.29 2.2-.34 2.11-.37 2.03-.42 1.93-.45 1.82-.48 1.72-.52 1.6-.55 1.48-.58 1.35-.62 1.23-.64 1.1-.67.97-.69.83-.71.7-.74.57-.75.44-.77.3-.78.17-.8.05-.81-.08-.81-.2-.82-.31-.82-.42-.83-.54-.82-.63-.82-.73-.82-.83-.8-.91-.8-.99-.78-1.07-.77-1.13-.76-1.2-.73-1.26-.72-1.32-.69-1.36-.67-1.4-.64-1.45-.61-1.48-.58-1.51-.55-1.54-.52-1.56-.49-1.58-.45-1.6-.41-1.62-.37-1.63-.34-1.64-.29-1.64-.26-1.66-.21-1.66-.17-1.66-.13-1.67-.09-1.66-.04h-1.67l-1.67.04-1.67.09-1.66.13-1.66.17-1.65.21-1.65.26-1.64.29-1.63.34-1.61.37-1.6.41-1.58.45-1.57.49-1.53.52-1.52.55-1.48.58-1.44.61-1.41.64-1.36.67-1.31.69-1.26.72-1.2.73-1.14.76-1.07.77-.99.78-.91.8-.82.8-.73.82-.64.82-.53.82-.43.83-.31.82-.2.82-.07.81.04.81.18.8.3.78.43.77.57.75.7.74.83.71.97.69 1.1.67 1.23.64 1.36.62 1.48.58 1.6.55 1.71.52 1.83.48 1.93.45 2.02.42 2.12.37 2.2.34 2.27.29 2.33.26 2.39.21 2.44.17 2.47.13 2.5.09 2.51.04h2.52z"/><text x="134.95" y="-89.44" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">Trainer</text></g><g class="node" transform="translate(4 114.23)"><path fill="#fff5ee" stroke="#444" d="m41.46-.04 2.33-.09 2.3-.13 2.27-.17 2.22-.21 2.18-.26 2.11-.29 2.05-.34 1.96-.37 1.89-.42 1.8-.44 1.69-.49 1.6-.52 1.49-.55 1.38-.58 1.26-.62 1.14-.64 1.03-.66.9-.7.77-.71.66-.73.52-.76.41-.77.28-.78.16-.8.04-.81-.07-.81-.18-.82-.29-.82-.4-.83-.49-.82-.59-.82-.69-.82-.76-.8-.85-.8-.92-.78-1-.77-1.05-.76-1.12-.73-1.17-.72-1.22-.69-1.27-.66-1.31-.65-1.35-.61-1.37-.58-1.41-.55-1.43-.52-1.46-.49-1.47-.45-1.49-.41-1.5-.37-1.52-.34-1.52-.29-1.54-.26-1.54-.21-1.54-.17-1.55-.13-1.55-.09-1.55-.04h-1.55l-1.56.04-1.55.09-1.54.13-1.55.17-1.54.21-1.53.26-1.53.29-1.51.34-1.51.37-1.48.41-1.48.45-1.45.49-1.43.52-1.41.55-1.38.58-1.34.61-1.31.65-1.27.66-1.22.69-1.17.72-1.12.73-1.06.76-.99.77-.92.78-.85.8-.77.8-.68.82-.59.82-.5.82-.39.83-.29.82-.19.82-.07.81.04.81.16.8.29.78.4.77.53.76.65.73.78.71.9.7 1.02.66 1.14.64 1.27.62 1.37.58 1.49.55 1.6.52 1.7.49 1.79.44 1.89.42 1.97.37 2.04.34 2.12.29 2.17.26 2.23.21 2.26.17 2.31.13 2.32.09 2.34.04h2.34z"/><text x="37.95" y="-10.7" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">Model</text></g><g class="edge" transform="translate(4 114.23)"><path fill="none" stroke="#444" d="M117.16-79.41c-15.23 12.05-37.32 29.52-54.3 42.96"/><path fill="#444" stroke="#444" d="M65.22-33.86 55.21-30.4l5.67-8.95z"/><text x="106.88" y="-51.24" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">initiate</text></g><g class="node" transform="translate(4 114.23)"><path fill="#fff5ee" stroke="#444" d="m240.22-.04 5.47-.09 5.42-.13 5.34-.17 5.24-.21 5.12-.26 4.97-.29 4.82-.34 4.63-.37 4.44-.42 4.23-.44 3.99-.49 3.76-.52 3.51-.55 3.24-.58 2.98-.62 2.69-.64 2.41-.66 2.12-.7 1.82-.71 1.54-.73 1.24-.76.95-.77.67-.78.38-.8.1-.81-.17-.81-.43-.82-.69-.82-.93-.83-1.17-.82-1.39-.82-1.6-.82-1.81-.8-1.99-.8-2.18-.78-2.33-.77-2.49-.76-2.63-.73-2.76-.72-2.88-.69-2.98-.66-3.08-.65-3.17-.61-3.24-.58-3.32-.55-3.37-.52-3.42-.49-3.47-.45-3.51-.41-3.54-.37-3.56-.34-3.59-.29-3.61-.26-3.63-.21-3.63-.17-3.65-.13-3.65-.09-3.65-.04h-3.66l-3.65.04-3.65.09-3.64.13-3.64.17-3.62.21-3.61.26-3.59.29-3.57.34-3.54.37-3.51.41-3.46.45-3.43.49-3.37.52-3.31.55-3.24.58-3.17.61-3.08.65-2.99.66-2.87.69-2.76.72-2.63.73-2.49.76-2.34.77-2.17.78-2 .8-1.8.8-1.61.82-1.39.82-1.16.82-.94.83-.68.82-.44.82-.16.81.1.81.38.8.66.78.95.77 1.25.76 1.53.73 1.83.71 2.12.7 2.41.66 2.69.64 2.97.62 3.24.58 3.51.55 3.76.52 4 .49 4.23.44 4.43.42 4.64.37 4.81.34 4.98.29 5.12.26 5.23.21 5.34.17 5.42.13 5.47.09 5.51.04h5.52z"/><text x="231.95" y="-10.7" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">DataLoaderBuilder</text></g><g class="edge" transform="translate(4 114.23)"><path fill="none" stroke="#444" d="M152.74-79.41c14.59 11.54 35.46 28.05 52.12 41.23"/><path fill="#444" stroke="#444" d="m206.76-41.14 5.67 8.95-10.02-3.46z"/><text x="203.88" y="-51.24" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">initiate</text></g><g class="edge" transform="translate(4 114.23)"><path fill="none" stroke="#444" stroke-dasharray="5,2" d="M75.36-15.75h57.29"/><path fill="#444" stroke="#444" d="m132.49-19.25 10 3.5-10 3.5z"/><text x="109.26" y="-20.5" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">loader_type</text></g></g></svg></figure><p class="par">Ideally, <code>DataLoaderBuilder</code> should “contact” with <code>Model</code> to obtain information required for building loader. But we couldn’t, due to the limitation from hierarchy. The only possible path for message passing is <code>Model</code> -&gt; <code>Trainer</code> -&gt; <code>DataLoaderBuilder</code>. It would however turns <code>Trainer</code> into a “god object”, passing messages around between its children. Having a god object is considered to be a bad practice <sup id="fnref:4"><a href="#fn:4">4</a></sup>). Components are tightly coupled to their parents, and maintenance becomes difficult. The second is similar, except we are making <code>Model</code> into the broker between <code>Trainer</code> and <code>ComponentA</code>.</p><p>A more generalized version of the problem: In a system with tree-like hierarchical structure, how would the communication be made between two non-adjacent components?</p><figure class="graphviz"><svg xmlns="http://www.w3.org/2000/svg" width="262pt" height="88pt" viewBox="0 0 262.46 88.49"><g class="graph"><path fill="none" d="M0 88.49V0h262.46v88.49z"/><g class="node" transform="translate(4 84.49)"><path fill="#fff5ee" stroke="#444" d="m31.4-24.04 1.76-.09 1.75-.13 1.71-.17 1.69-.21 1.65-.26 1.6-.29 1.55-.34 1.49-.37 1.42-.42 1.36-.44 1.29-.49 1.21-.52 1.13-.55 1.04-.58.96-.62.86-.64.78-.66.68-.7.59-.71.49-.73.4-.76.31-.77.21-.78.12-.8.04-.81-.06-.81-.14-.82-.22-.82-.3-.83-.37-.82-.45-.82-.52-.82-.58-.8-.64-.8-.7-.78-.75-.77-.8-.76-.85-.73-.88-.72-.93-.69-.96-.66-.99-.65-1.02-.61-1.04-.58-1.07-.55-1.08-.52-1.1-.49-1.12-.45-1.13-.41-1.14-.37-1.14-.34-1.16-.29-1.16-.26-1.17-.21-1.17-.17-1.17-.13-1.17-.09-1.18-.04h-1.17l-1.18.04-1.17.09-1.18.13-1.17.17-1.16.21-1.16.26-1.16.29-1.15.34-1.13.37-1.13.41-1.12.45-1.1.49-1.08.52-1.07.55-1.04.58-1.02.61-.99.65-.96.66-.93.69-.89.72-.84.73-.8.76-.76.77-.69.78-.65.8-.58.8-.51.82-.45.82-.38.82-.3.83-.22.82-.14.82-.05.81.03.81.13.8.21.78.3.77.4.76.5.73.59.71.68.7.77.66.87.64.96.62 1.04.58 1.13.55 1.21.52 1.28.49 1.36.44 1.43.42 1.49.37 1.55.34 1.6.29 1.65.26 1.68.21 1.72.17 1.74.13 1.76.09 1.78.04h1.77z"/><text x="28.74" y="-34.7" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">A</text></g><g class="node" transform="translate(4 84.49)"><path fill="#fff5ee" stroke="#444" d="m125.89-49.04 1.76-.09 1.74-.13 1.72-.17 1.69-.21 1.64-.26 1.6-.29 1.55-.34 1.49-.37 1.43-.42 1.36-.44 1.29-.49 1.21-.52 1.13-.55 1.04-.58.95-.62.87-.64.78-.66.68-.7.59-.71.49-.73.4-.76.31-.77.21-.78.12-.8.03-.81-.05-.81-.14-.82-.22-.82-.3-.83-.38-.82-.44-.82-.52-.82-.58-.8-.64-.8-.7-.78-.75-.77-.8-.76-.85-.73-.89-.72-.92-.69-.96-.66-.99-.65-1.02-.61-1.05-.58-1.06-.55-1.09-.52-1.1-.49-1.11-.45-1.13-.41-1.14-.37-1.15-.34-1.15-.29-1.16-.26-1.17-.21-1.17-.17-1.17-.13-1.18-.09-1.17-.04h-1.18l-1.17.04-1.18.09-1.17.13-1.17.17-1.17.21-1.16.26-1.15.29-1.15.34-1.14.37-1.13.41-1.11.45-1.1.49-1.09.52-1.06.55-1.05.58-1.02.61-.99.65-.96.66-.92.69-.89.72-.85.73-.8.76-.75.77-.7.78-.64.8-.58.8-.52.82-.44.82-.38.82-.3.83-.22.82-.14.82-.05.81.03.81.12.8.22.78.3.77.4.76.49.73.59.71.68.7.78.66.87.64.95.62 1.05.58 1.12.55 1.21.52 1.29.49 1.36.44 1.43.42 1.49.37 1.55.34 1.6.29 1.64.26 1.69.21 1.72.17 1.74.13 1.76.09 1.77.04h1.78z"/><text x="123.23" y="-59.7" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">B</text></g><g class="edge" transform="translate(4 84.49)"><path fill="none" stroke="#444" d="m53.08-46.05 31.71-8.58"/><path fill="#444" stroke="#444" d="m83.6-57.93 10.57.77-8.74 5.99z"/></g><g class="node" transform="translate(4 84.49)"><path fill="#fff5ee" stroke="#444" d="m125.89-.04 1.76-.09 1.74-.13 1.72-.17 1.69-.21 1.64-.26 1.6-.29 1.55-.34 1.49-.37 1.43-.42 1.36-.44 1.29-.49 1.21-.52 1.13-.55 1.04-.58.95-.62.87-.64.78-.66.68-.7.59-.71.49-.73.4-.76.31-.77.21-.78.12-.8.03-.81-.05-.81-.14-.82-.22-.82-.3-.83-.38-.82-.44-.82-.52-.82-.58-.8-.64-.8-.7-.78-.75-.77-.8-.76-.85-.73-.89-.72-.92-.69-.96-.66-.99-.65-1.02-.61-1.05-.58-1.06-.55-1.09-.52-1.1-.49-1.11-.45-1.13-.41-1.14-.37-1.15-.34-1.15-.29-1.16-.26-1.17-.21-1.17-.17-1.17-.13-1.18-.09-1.17-.04h-1.18l-1.17.04-1.18.09-1.17.13-1.17.17-1.17.21-1.16.26-1.15.29-1.15.34-1.14.37-1.13.41-1.11.45-1.1.49-1.09.52-1.06.55-1.05.58-1.02.61-.99.65-.96.66-.92.69-.89.72-.85.73-.8.76-.75.77-.7.78-.64.8-.58.8-.52.82-.44.82-.38.82-.3.83-.22.82-.14.82-.05.81.03.81.12.8.22.78.3.77.4.76.49.73.59.71.68.7.78.66.87.64.95.62 1.05.58 1.12.55 1.21.52 1.29.49 1.36.44 1.43.42 1.49.37 1.55.34 1.6.29 1.64.26 1.69.21 1.72.17 1.74.13 1.76.09 1.77.04h1.78z"/><text x="123.23" y="-10.7" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">C</text></g><g class="edge" transform="translate(4 84.49)"><path fill="none" stroke="#444" d="M56.49-32.8c9.69 2.51 20.78 5.39 31.06 8.05"/><path fill="#444" stroke="#444" d="m88.42-28.14 8.8 5.9-10.56.88z"/></g><g class="node" transform="translate(4 84.49)"><path fill="#fff5ee" stroke="#444" d="m228.38-.04 1.76-.09 1.74-.13 1.72-.17 1.68-.21 1.65-.26 1.6-.29 1.55-.34 1.49-.37 1.43-.42 1.36-.44 1.28-.49 1.21-.52 1.13-.55 1.05-.58.95-.62.87-.64.77-.66.68-.7.59-.71.5-.73.4-.76.3-.77.22-.78.12-.8.03-.81-.05-.81-.14-.82-.22-.82-.3-.83-.38-.82-.45-.82-.51-.82-.58-.8-.65-.8-.69-.78-.76-.77-.8-.76-.84-.73-.89-.72-.93-.69-.96-.66-.99-.65-1.02-.61-1.04-.58-1.07-.55-1.08-.52-1.1-.49-1.12-.45-1.12-.41-1.14-.37-1.15-.34-1.16-.29-1.16-.26-1.16-.21-1.17-.17-1.17-.13-1.18-.09-1.17-.04h-1.18l-1.18.04-1.17.09-1.17.13-1.17.17-1.17.21-1.16.26-1.15.29-1.15.34-1.14.37-1.13.41-1.11.45-1.11.49-1.08.52-1.07.55-1.04.58-1.02.61-.99.65-.96.66-.93.69-.88.72-.85.73-.8.76-.75.77-.7.78-.64.8-.58.8-.52.82-.45.82-.37.82-.3.83-.22.82-.14.82-.06.81.04.81.12.8.21.78.31.77.4.76.49.73.59.71.68.7.78.66.86.64.96.62 1.04.58 1.13.55 1.21.52 1.29.49 1.36.44 1.42.42 1.5.37 1.54.34 1.6.29 1.65.26 1.69.21 1.71.17 1.75.13 1.76.09 1.77.04h1.78z"/><text x="225.72" y="-10.7" fill="#444" font-family="Times New Roman,serif" font-size="14" text-anchor="middle">D</text></g><g class="edge" transform="translate(4 84.49)"><path fill="none" stroke="#444" stroke-dasharray="5,2" d="M157.07-48.73c12.24 5.96 26.04 12.7 37.98 18.52"/><path fill="#444" stroke="#444" d="m155.85-45.43-7.46-7.53 10.53 1.23zM196.57-33.36l7.46 7.53-10.53-1.24z"/><text x="174.47" y="-43.46" fill="#444" font-family="Times New Roman,serif" font-size="10" text-anchor="middle">??</text></g><g class="edge" transform="translate(4 84.49)"><path fill="none" stroke="#444" d="M151.69-15.75h34.13"/><path fill="#444" stroke="#444" d="m185.78-19.25 10 3.5-10 3.5z"/></g></g></svg></figure><p class="nomargin">It is not some kind of novel research problem, but one already addressed in practical scenes. Following the single-responsibility principle, we can use a standalone service responsible for managing the communication. Such would be much common in modern Web development, since web components are usually organized in a tree and pass messages more frequently. Mature and production-ready solutions exist like <em>Event-Bus pattern</em> or <em>centralized state management</em> <sup id="fnref:5"><a href="#fn:5">5</a></sup>, which are all instances of the design pattern. Instead of relying on the target (or the path to the target), the components now depend only on the service object, and the system becomes less coupled.</p><p>So why won’t we use the techniques? Well, if some libaries integrate the stuff, we are glad to try; if not, we have to implement by ourselves, but sorry, we are running out of time.</p><p class="nomargin">For programmers in production group, they care more about coupling, otherwise the maintenance is getting painful. They would apply every best practice and design patterns that could be found from textbooks or from some blog posts.</p><p class="nomargin">But as researchers, we might have taken the course of software engineering, but we seldom do this. I’ve skimmed so much released code for papers on Github, most of which have their logic for building model, loading data and training tightly coupled, fragile and with mere flexibility for extending. They might be enough to showcase the papers, but are far from a good codebase. But sometimes we have no choice <sup id="fnref:6"><a href="#fn:6">6</a></sup> but to extend upon it. There are indeed someone paying efforts to make well-designed and easy-to-extend codebases <sup id="fnref:7"><a href="#fn:7">7</a></sup>, but apparently they could not cover all extension demand from developers. We are from time to time being limited by our codebase, badly-designed or over-designed. What’s worse, we have a deadline ahead, and to rush out the idea, we are practicing so many anti-patterns – communicating via global variables or god object, duplicating the logic here and there, or writing meaningless boilerplate codes. The codebase would finally grow into spaghetti. Badly-cooked spaghetti.</p><p>It was then I began to think about why practices for production could hardly apply to a research project. The answer is that a research project is not production-ready, but evolving and iterating rapidly with aimless target, rather like a prototype. A prototype might grow into a production, but research project won’t, mostly ending after some paper deadlines. The dogmatism of design patterns are too verbose, and sometimes complicated. Researchers seldom use them, but run for some easy-to-use-but-dirty hacking or tricks.</p><p>And that’s the background of <a target="_blank" rel="noopener" href="https://github.com/hsfzxjy/mocona">hsfzxjy/mocona</a>. It implements some patterns like <em>Dependency Injection</em> and <em>Event Emitter</em>, in addressing the problem of communication between components. The library is deliberately designed to be “magical”, that is, do most of the heavy work behind the scene, but expose a very simple interface or (self-made) “syntax” for users. It is evil and an anti-pattern to be implicit and magical in Python. But there’re people tired or more afraid of verbosity, for which they are willing to write even worse code. If the library could help, they would be glad to make a trade-off between verbosity and anti-pattern.</p><div class="footnotes"><ol><li class="footnote" id="fn:1">Loaders and preprocessors for various datasets, training loop, and evaluation metrics, <em>etc.</em></li><li class="footnote" id="fn:2">Logger, data loader, model, evaluator, <em>etc.</em></li><li class="footnote" id="fn:3">e.g., taking <code>(img, offset)</code> as input and supervised by <code>(gtseg, gtoffset)</code></li><li class="footnote" id="fn:4">[God Object - Wikipedia](<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/God_object">http://en.wikipedia.org/wiki/God_object</a></li><li class="footnote" id="fn:5">such as <a target="_blank" rel="noopener" href="https://redux.js.org/">Redux</a> for React.js</li><li class="footnote" id="fn:6">you would like to improve the method and that’s the only reliable way to reproduce it</li><li class="footnote" id="fn:7">We thank projects like <a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2">Detectron2</a> and series of <a target="_blank" rel="noopener" href="https://github.com/open-mmlab">OpenMMLab</a>.</li></ol></div><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"></div><div class="post-nav"><a href="/a-trick-to-retrieve-web-contents-without-curl-or-wget/" class="pre">«Retrieve Contents over HTTP without curl or wget</a><a href="/unravelling-mocona-preface/" class="next">[Unravelling mocona] Part 0 - Preface»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="unravelling-mocona-verbosity-or-anti-pattern/",disqus_title="[Unravelling mocona] Part 1 - Verbosity or Anti-Pattern",disqus_url="https://i.hsfzxjy.site/unravelling-mocona-verbosity-or-anti-pattern/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>