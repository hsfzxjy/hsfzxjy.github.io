<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width,initial-scale=1,maximum-scale=5" name="viewport"><meta content="yes" name="mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><script>(()=>{let e="/cnfonts.js?rDuukLHQ",t=document,n=navigator.serviceWorker,r=!1;var a;(r=n&&(n.register(e,{scope:"/"}).then(e=>e.update()),a=n.controller)&&a.scriptURL.endsWith(e)&&"activated"===a.state?!0:r)?((a=t.createElement("link")).rel="stylesheet",a.href="/fontchan/rDuukLHQ.css",a.blocking="render",t.head.appendChild(a)):((a=t.createElement("script")).src=e,a.onload=()=>$fontchan.injectCss(),t.head.appendChild(a))})()</script><title>Go Fact: Zero-sized Field at the Rear of a Struct Has Non-zero Size</title><meta itemprop="title" content="Go Fact: Zero-sized Field at the Rear of a Struct Has Non-zero Size - hsfzxjy 的博客"><meta itemprop="og:title" content="Go Fact: Zero-sized Field at the Rear of a Struct Has Non-zero Size - hsfzxjy 的博客"><meta itemprop="image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="og:image" content="https://i.hsfzxjy.site/avatar-for-hsfzxjy.jpg"><meta itemprop="description" content="There’s a concept in Golang called zero-sized type (or ZS..."><meta itemprop="og:type" content="website"><link rel="stylesheet" href="/dist/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" href="/rss.xml"></head><body><nav class="nav"><span class="nav__toggler"><span class="nav__toggler-bar bar1"></span><span class="nav__toggler-bar bar2"></span><span class="nav__toggler-bar bar3"></span></span><span class="nav__core"><div class="nav__logo"><img src="/avatar.webp" loading="lazy"></div><a href="/" lang="zh" class="nav__brand">hsfzxjy</a></span><span class="nav__togglerClose"><span class="nav__togglerClose-circle"></span><span class="nav__togglerClose-bar bar1"></span><span class="nav__togglerClose-bar bar2"></span></span><div class="nav__pathIndicator"><a href="/categories/Tech/">Tech</a></div></nav><main class="mainContainer"><div lang="en" class="post post-page"><h1 lang="en" class="post__title">Go Fact: Zero-sized Field at the Rear of a Struct Has Non-zero Size</h1><div class="post__meta font__ui">2023-11-04 | <span class="post__meta-categories"><a href="/categories/Tech/">Tech</a></span></div><div class="post__content font__body"><blockquote>See the discussion of this article on <a target="_blank" rel="noopener" href="https://www.reddit.com/r/golang/comments/184f62j/go_fact_zerosized_field_at_the_rear_of_a_struct/">Reddit</a>.</blockquote><p>There’s a concept in Golang called <em>zero-sized type</em> (or ZST), namely, a type whose variables take up zero bit of memory. One of them is the famous <code>struct&#123;&#125;</code>. People often use <code>map[string]struct&#123;&#125;</code> to efficiently emulate a set structure. Others include zero-length arrays such as <code>[0]int</code>, albeit not very common, are adopted to enforce some properties of a customized type.</p><div class="gk-unified-code tab" data-gk-style="tab"><div class="gk-code hljs" data-gk-id="BLOCK1" data-gk-title="Comparability"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">type</span> UserName <span class="hljs-keyword">struct</span>{</span><br><span class="line">    name <span class="hljs-type">string</span></span><br><span class="line">    <span class="hljs-comment">// ZST [0]func() makes the surrounding type incomparable</span></span><br><span class="line">    _phantom [<span class="hljs-number">0</span>]<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span></span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">println</span>(UserName{name: <span class="hljs-string">&quot;a&quot;</span>} == UserName{name: <span class="hljs-string">&quot;b&quot;</span>})</span><br><span class="line"><span class="hljs-comment">// invalid operation: UserName{…} == UserName{…}</span></span><br><span class="line"><span class="hljs-comment">// (struct containing [0]func() cannot be compared)</span></span><br></pre></div></div><div class="gk-code hljs" data-gk-id="convert" data-gk-title="Convertibility"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">type</span> Tag <span class="hljs-keyword">struct</span>{</span><br><span class="line">    Value <span class="hljs-type">string</span></span><br><span class="line">    _tag <span class="hljs-keyword">struct</span>{}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">type</span> Id <span class="hljs-keyword">struct</span>{</span><br><span class="line">    Value <span class="hljs-type">string</span></span><br><span class="line">    _id <span class="hljs-keyword">struct</span>{}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> a = Tag{Value: <span class="hljs-string">&quot;Go&quot;</span>}</span><br><span class="line"><span class="hljs-keyword">var</span> b = Id(a)</span><br><span class="line"><span class="hljs-comment">// cannot convert a (variable of type Tag) to type Id</span></span><br></pre></div></div></div><p>One may think that a ZST variable always occupies 0 byte of space, which however is not the case. For example, the result of <code>unsafe.Sizeof</code> against UserName might surprise you:</p><div class="gk-code hljs" data-gk-id="BLOCK2"><div class="gk-code-display"><pre><span class="line"><span class="hljs-built_in">println</span>(unsafe.Sizeof(UserName{}), unsafe.Sizeof(<span class="hljs-string">&quot;&quot;</span>)) <span class="hljs-comment">// 24 16</span></span><br></pre></div></div><p>The size of UserName is 8 bytes greater than the size of a string, which means the field of <code>[0]func()</code> at the rear takes up exactly 8 bytes.</p><p>Well, this is heavy. The incorporation of ZSTs was aimed to ensure type safety without introducing any runtime overhead. However, if this implementation leads to an increased footprint, it may be considered less favorable. Why does it happen?</p><p>There’s an explanation from the Go team on <a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/58483#issuecomment-1427182579">Github</a>:</p><blockquote><p>[…] this means it (a pointer to ZST field) would actually point outside of the allocation.<br>Unlike many other languages, (C, C++, Rust, …) where creating pointer past the allocation (but not using it) is legal. In go it isn’t because the GC may at anytime inspect any pointer.</p></blockquote><p>This design serves as a precautionary measure to avoid any potential confusion for the Garbage Collector runtime. Roughly speaking, Go organizes allocated objects into several memory blocks. At the same time, Go provides users the flexibility to create pointers pointing to or within those objects. These pointers are inspected by the garbage collector from time to time, therefore they must point to somewhere valid within a memory block. Now think about an edge case:</p><div class="gk-code hljs" data-gk-id="BLOCK3"><div class="gk-code-display"><pre><span class="line">          memory block</span><br><span class="line"> ______________/\______________</span><br><span class="line">/                              \</span><br><span class="line">+-----+------------------------+----------------------+</span><br><span class="line">| ... |         name           | &lt;unallocated memory&gt; |</span><br><span class="line">+-----+------------------------+----------------------+</span><br><span class="line">       \__________  __________/|</span><br><span class="line">                  \/           |</span><br><span class="line">            u := UserName{}    |</span><br><span class="line">                              \|/</span><br><span class="line">                       p := &amp;(u._phantom)</span><br></pre></div></div><p>In this case, an object <code>u</code> of type UserName is placed at the end of a memory block. Meanwhile, a pointer <code>p</code> exists and points to its <code>_phantom</code> field. If the <code>_phantom</code> field took up zero byte, the pointer <code>p</code> would contain the address of right boundary of the memory block, which, once dereferenced by the GC, would lead to invalid access to unallocated memory. Hence, the Go compiler reserves additional bytes at the end of the UserName struct to prevent the occurrence of such cases.</p><p>That said, we do have solution to eliminate such overhead. As discussed in the same Github issue, reordering the ZST field to the middle of the struct eliminates the need for additional reserved bytes. This adjustment ensures that there is no possibility of a pointer pointing to the allocation boundary.</p><div class="gk-code hljs" data-gk-id="BLOCK4"><div class="gk-code-display"><pre><span class="line"><span class="hljs-keyword">type</span> UserName2 <span class="hljs-keyword">struct</span>{</span><br><span class="line">    _phantom [<span class="hljs-number">0</span>]<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span></span><br><span class="line">    name <span class="hljs-type">string</span></span><br><span class="line">}</span><br><span class="line"><span class="hljs-built_in">println</span>(unsafe.Sizeof(Username2{})) <span class="hljs-comment">// 16</span></span><br></pre></div></div><p>Hence, whenever we want to employ the “ZST-trick”, it is crucial to ensure its placement at the middle of a struct.</p><br><blockquote><p class="cc"><b>Author:</b> hsfzxjy.<br><b>Link:</b> <span class="cc-link"></span>.<br><b>License:</b> <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">CC BY-NC-ND 4.0</a>.<br>All rights reserved by the author.<br>Commercial use of this post in any form is <b>NOT</b> permitted.<br>Non-commercial use of this post should be attributed with this block of text.</p></blockquote><script>!function(){var n=document.querySelector("span.cc-link");n&&(n.innerHTML='<a href="'+location.href+'">'+location.href+"</a>")}()</script></div><div class="post__tags"><a href="/tags/Go/">Go</a></div><div class="post-nav"><a href="/train-2023-11-18/" class="pre">«硬卧</a><a href="/display-rat-losslessly-smartly-go/" class="next">Display *big.Rat Losslessly and Smartly in Golang»</a></div><div id="disqus_thread"><div id="no-comment"><h2>OOPS!</h2><span>A comment box should be right here...</span><span>But it was gone due to network issues :-(</span><span>If you want to leave comments, make sure you have access to&nbsp;<a target="_blank" rel="noopener" href="https://disqus.com">disqus.com</a>.</span></div><script>var disqus_shortname="hsfzxjy",disqus_identifier="zst-at-the-rear-of-go-struct/",disqus_title="Go Fact: Zero-sized Field at the Rear of a Struct Has Non-zero Size",disqus_url="https://i.hsfzxjy.site/zst-at-the-rear-of-go-struct/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.defer=!0,e.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("head")[0]).appendChild(e),e.onerror=function(){document.getElementById("no-comment").classList.add("show")}}()</script><script id="dsq-count-scr" src="//hsfzxjy.disqus.com/count.js" async defer></script></div></div></main><section class="aside__group"><span class="aside__btn"><div lang="zh" class="github-btn"><a href="#" rel="noopener noreferrer" target="_blank" class="gh-btn"><span class="gh-ico"></span><span class="gh-text">FOLLOW ME</span></a><a href="#" rel="noopener noreferrer" target="_blank" class="gh-count"></a></div><script>window.GH_BUTTON={username:"hsfzxjy"}</script></span><aside class="aside__left"><div class="aside__menuList"><span class="aside__menuList-item__icon"><i class="icon-home"></i></span><a href="/" class="aside__menuList-item"><span lang="zh" class="font__ui">首页 / Home</span></a><span class="aside__menuList-item__icon current"><i class="icon-embed2"></i></span><a href="/categories/Tech/" class="aside__menuList-item current"><span lang="zh" class="font__ui">科技 / Tech</span></a><span class="aside__menuList-item__icon"><i class="icon-android"></i></span><a href="/categories/Soliloquy/" class="aside__menuList-item"><span lang="zh" class="font__ui">呓语 / Soliloquy</span></a><span class="aside__menuList-item__icon"><i class="icon-leaf"></i></span><a href="/categories/Life/" class="aside__menuList-item"><span lang="zh" class="font__ui">生活 / Life</span></a><span class="aside__menuList-item__icon"><i class="icon-bookmarks"></i></span><a href="/categories/Memo/" class="aside__menuList-item"><span lang="zh" class="font__ui">速记 / Memo</span></a><span class="aside__menuList-item__icon"><i class="icon-books"></i></span><a href="/categories/Series/" class="aside__menuList-item"><span lang="zh" class="font__ui">连载 / Series</span></a><span class="aside__menuList-item__icon"><i class="icon-sigma"></i></span><a href="/works/" class="aside__menuList-item"><span lang="zh" class="font__ui">项目 / Projects</span></a><span class="aside__menuList-item__icon"><i class="icon-earth"></i></span><a href="/links/" class="aside__menuList-item"><span lang="zh" class="font__ui">友链 / Links</span></a><span class="aside__menuList-item__icon"><i class="icon-wink"></i></span><a href="/about/" class="aside__menuList-item"><span lang="zh" class="font__ui">关于 / About</span></a><span class="aside__menuList-item__icon"><i class="icon-history"></i></span><a href="/aggr/" class="aside__menuList-item"><span lang="zh" class="font__ui">索引 / Index</span></a><span class="aside__menuList-item__icon"><i class="icon-rss2"></i></span><a href="/rss.xml" class="aside__menuList-item"><span lang="zh" class="font__ui">订阅 / RSS</span></a></div></aside><aside class="aside__right"></aside></section><div id="footer" style="text-align:center" lang="zh" class="font__ui">© <a href="/" rel="nofollow">hsfzxjy 的博客.</a>&nbsp;Powered by&nbsp;<a rel="nofollow" target="_blank" href="https://hexo.io">Hexo.</a>&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy/byak-hexo">Theme</a>&nbsp;by&nbsp;<a rel="nofollow" target="_blank" href="https://github.com/hsfzxjy">hsfzxjy</a>.<div style="margin-top:10px"><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44011202001249" style="display:inline-block;text-decoration:none;height:20px;line-height:20px"><img src="/img/beian.png" style="float:left" loading="lazy"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤公网安备44011202001249号</span></a><a target="_blank" style="display:inline-block;text-decoration:none;height:20px;line-height:20px" href="http://beian.miit.gov.cn/"><span style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">粤ICP备2020075702号-1</span></a></div></div></body><script src="/dist/js/main.js" async defer></script></html>